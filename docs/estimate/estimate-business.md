# 見積管理機能 業務要件・実装設計書

## 1. 業務要件概要

### 1.1 見積管理の目的
- 建設工事の見積書を効率的に作成・管理
- 承認フローによる適切な承認プロセス
- 高品質な見積書の出力
- 見積履歴の管理と分析
- 工事実行予算システムとの連携

### 1.2 対象ユーザー
- **営業担当者**: 見積書の作成・編集
- **部門長**: 見積書の承認
- **経営陣**: 最終承認
- **管理者**: 見積分析・レポート

## 2. 業務フロー詳細

### 2.1 見積作成フェーズ
見積書データ（ヘッダと明細が基本構成）

#### 2.1.1 受注明細の作成
- 担当者は、顧客に提示する「受注内容」としての見積明細を作成
- 階層構造（大内訳・中内訳・小内訳）を活用した柔軟な明細構成
- 数量×単価による自動金額計算

#### 2.1.2 原価計画（予実）の作成
- 作成した受注明細を基に、社内検討用の「原価計画（予実）」を作成
- 発注先や原価が異なるパターンとして、一次、二次、三次…と複数作成可能
- 常に最新のものが有効な計画となる

#### 2.1.3 枝番の作成（必要な場合）
- 顧客との交渉で受注金額自体が変更になった場合、元の見積もりから「枝番」を作成
- 枝番は、元の見積もりの受注明細と原価計画をすべてコピーした、新しい独立した見積もり
- 複数の枝番を管理し、最終的に一つを選択して受注申請

### 2.2 受注申請と工事データ作成フェーズ

#### 2.2.1 受注申請
- 担当者は、最終的に合意した見積もり（特定の枝番）と、その中の最終版の原価計画（例: 三次案）を固め、「受注申請」を実行

#### 2.2.2 工事データ作成画面の表示
- 受注申請を行うと、システムは申請された見積もり情報を基に、工事データの初期値が入力された登録画面を表示
- 必須項目である「受注日」と「報告日」を入力

#### 2.2.3 工事データの登録
担当者が登録ボタンを押すと、以下の処理が同時に実行：
- 工事データが正式に作成される
- 選ばれた見積もりの「受注明細」と「最終版の原価計画」が、初代の実行予算として工事データにコピーされる
- 元の見積もりのステータスが「承認待」に更新され、完全にロックされる（変更・削除不可）
- 選ばれなかった他の枝番は、「廃棄」などのステータスになる

## 3. データ構造詳細

### 3.1 明細行の基本項目

#### 3.1.1 見積情報
- **数量**: 工事数量
- **単価**: 単価
- **金額**: 数量 × 単価で自動計算

#### 3.1.2 発注・予算情報
- **発注先**: 発注先企業名
- **予想金額（原価）**: 社内原価

### 3.2 金額の自動計算ロジック
- 各明細行の「金額」は、数量 × 単価 で自動的に計算
- 「小内訳」の合計金額は、それに含まれる明細行の「金額」の合計値
- 「中内訳」の合計金額は、それに含まれる「小内訳」の合計金額の合計値
- 「大内訳」の合計金額は、それに含まれる「中内訳」の合計金額の合計値
- 最終的な見積もり合計金額は、すべての大内訳、中内訳、小内訳、そしてどの内訳にも属さない明細行の金額をすべて足し合わせたもの

### 3.3 階層構造
見積書の明細は、複数の「明細行」で構成され、必要に応じてグループ化可能：

- **レベル1：小内訳**: 複数の「明細行」をまとめたもの
- **レベル2：中内訳**: 複数の「小内訳」をまとめたもの
- **レベル3：大内訳**: 複数の「中内訳」をまとめたもの

この階層構造により、単純な一行ずつの明細から、複雑な多段階の集計まで、柔軟に見積書を作成可能

## 4. ユーザーインターフェース設計

### 4.1 基本画面構成

#### 4.1.1 見積詳細画面（照会モード）
```
【見積詳細画面】

[ 基本情報 ] [ 金額情報 ] [ 見積内訳 ] [ 見積明細 ]

基本情報
├── 見積番号: EST-2024-001
├── 工事名称: 〇〇ビル新築工事
├── 受注先: 株式会社ABC
├── 担当者: 田中太郎
├── 工期: 2024/04/01 〜 2024/12/31
└── [ 編集 ] ← クリックで基本情報編集ダイアログ

金額情報
├── 税抜見積金額: ¥10,000,000
├── 消費税: ¥1,100,000 (10%)
├── 合計金額: ¥11,100,000
└── [ 編集 ] ← クリックで金額情報編集ダイアログ

見積内訳
├── 大内訳1: 基礎工事 (¥3,000,000)
├── 大内訳2: 躯体工事 (¥5,000,000)
├── 大内訳3: 仕上げ工事 (¥2,000,000)
└── [ 編集 ] ← クリックで見積内訳編集ダイアログ

見積明細
├── 明細1: コンクリート打設 (100m³ × ¥30,000 = ¥3,000,000)
├── 明細2: 鉄筋工事 (50t × ¥80,000 = ¥4,000,000)
└── [ 編集 ] ← クリックで見積明細編集ダイアログ
```

#### 4.1.2 見積書作成画面
```
【見積書作成画面】

[ ヘッダー情報入力エリア： 顧客名、件名、納期、支払条件など ]

--------------------------------------------------------------------------------------------------------------------

[ 明細編集エリア ]

[ 行追加 ] [ 小内訳作成 ] [ 中内訳作成 ] [ 大内訳作成 ] [ 階層を上げる/下げる ] [ 行を上に/下に ] [ 削除 ]

| No. | 階層 | 品名・仕様                               | 数量 | 単位 | 単価     | 金額（自動計算） | 発注先 | 予想金額（原価） |
|-----|------|------------------------------------------|------|------|----------|------------------|--------|------------------|
| 1   |      | サーバー機器一式                         | 1    | 式   | 500,000  | 500,000          | A社    | 450,000          |
| 2   |      | ネットワーク設定費用                     | 1    | 式   | 50,000   | 50,000           | 自社   | 30,000           |
| 3   |      |                                          |      |      |          |                  |        |                  |

--------------------------------------------------------------------------------------------------------------------

[ 合計金額エリア ]

見積合計： 550,000 円
予想原価合計： 480,000 円
粗利： 70,000 円

[ 保存 ] [ プレビュー ] [ PDF出力 ]
```

### 4.2 編集方式の設計

#### 4.2.1 ダイアログベース編集方式
**基本方針**: 照会モードを基本とし、必要な部分のみダイアログで編集

**利点**:
- **段階的編集**: 必要な部分だけを編集できる
- **誤操作防止**: 全体を編集モードにせず、意図した部分のみ編集
- **直感的操作**: 編集したい部分をクリック → ダイアログで編集
- **データ整合性**: 編集した部分のみ保存、他の部分は影響なし
- **並行編集対応**: 複数ユーザーが異なる部分を同時編集可能

#### 4.2.2 編集ダイアログの種類

##### 4.2.2.1 基本情報編集ダイアログ
```
【基本情報編集ダイアログ】
┌─────────────────────────────────────┐
│ 基本情報編集                        │
├─────────────────────────────────────┤
│ 見積番号: [EST-2024-001        ]    │
│ 工事名称: [〇〇ビル新築工事     ]    │
│ 受注先:   [株式会社ABC ▼       ]    │
│ 担当者:   [田中太郎 ▼          ]    │
│ 工期:     [2024/04/01] 〜 [2024/12/31] │
│ 工事種別: [新築工事 ▼          ]    │
│ 備考:     [                    ]    │
│          [                    ]    │
├─────────────────────────────────────┤
│              [キャンセル] [保存]    │
└─────────────────────────────────────┘
```

##### 4.2.2.2 金額情報編集ダイアログ
```
【金額情報編集ダイアログ】
┌─────────────────────────────────────┐
│ 金額情報編集                        │
├─────────────────────────────────────┤
│ 税抜見積金額: [¥10,000,000     ]    │
│ 消費税率:     [10% ▼           ]    │
│ 消費税額:     [¥1,100,000      ]    │
│ 割引額:       [¥0              ]    │
│ 合計金額:     [¥11,100,000     ]    │
│                                     │
│ 一般管理費率: [8.5%            ]    │
│ 原価経費率:   [2.0%            ]    │
│ 材料経費率:   [1.5%            ]    │
├─────────────────────────────────────┤
│              [キャンセル] [保存]    │
└─────────────────────────────────────┘
```

##### 4.2.2.3 見積内訳編集ダイアログ
```
【見積内訳編集ダイアログ】
┌─────────────────────────────────────┐
│ 見積内訳編集                        │
├─────────────────────────────────────┤
│ [大内訳] [中内訳] [小内訳]          │
│                                     │
│ 大内訳一覧:                         │
│ ├─ 基礎工事 (¥3,000,000) [編集][削除] │
│ ├─ 躯体工事 (¥5,000,000) [編集][削除] │
│ └─ 仕上げ工事 (¥2,000,000) [編集][削除] │
│                                     │
│ [新規内訳追加]                      │
├─────────────────────────────────────┤
│              [キャンセル] [保存]    │
└─────────────────────────────────────┘
```

##### 4.2.2.4 見積明細編集ダイアログ
```
【見積明細編集ダイアログ】
┌─────────────────────────────────────┐
│ 見積明細編集                        │
├─────────────────────────────────────┤
│ 明細一覧:                           │
│ ┌─────────────────────────────────┐ │
│ │工法│工事分類│摘要│数量│単価│金額│ │
│ ├─────────────────────────────────┤ │
│ │基礎│コンクリート│打設│100│30,000│3,000,000│ │
│ │基礎│鉄筋    │配筋│50 │80,000│4,000,000│ │
│ └─────────────────────────────────┘ │
│                                     │
│ [明細追加] [一括編集] [CSV取込]     │
├─────────────────────────────────────┤
│              [キャンセル] [保存]    │
└─────────────────────────────────────┘
```

#### 4.2.3 見積内訳・明細の連動仕様

##### 4.2.3.1 連動方式の選択肢

**選択肢A: 統合ダイアログ**
```
見積内訳・明細編集ダイアログ
├── タブ1: 見積内訳構造
├── タブ2: 見積明細
└── 保存: 両方を一括保存
```

**選択肢B: 分離ダイアログ**
```
見積内訳編集ダイアログ → 内訳のみ保存
見積明細編集ダイアログ → 明細のみ保存
（内訳削除時は明細も連動削除）
```

**選択肢C: 段階的編集**
```
見積内訳編集ダイアログ → 内訳保存
↓
「明細も編集しますか？」→ 明細編集ダイアログ
```

**推奨**: 選択肢A（統合ダイアログ）で実装

#### 4.2.4 保存・更新フロー

##### 4.2.4.1 部分保存方式
1. **ダイアログで編集** → 該当部分のみ保存
2. **保存完了** → ダイアログ閉じる
3. **詳細ページ更新** → 最新状態を反映
4. **キャッシュ無効化** → React Queryで最新データ取得

##### 4.2.4.2 エラーハンドリング
- **保存失敗時**: ダイアログ内でエラー表示、詳細ページは変更なし
- **ネットワークエラー**: リトライ機能付き
- **バリデーションエラー**: リアルタイム検証

### 4.3 操作フロー（ステップ・バイ・ステップ）

#### 4.3.1 ステップ1：明細行の入力
- ユーザーはまず、階層を意識せず、必要な明細項目をどんどん入力
- [行追加]ボタンか、最終行でEnterキーを押すと新しい行が追加
- 「金額」は「数量」と「単価」を入力すると自動で計算

#### 4.3.2 ステップ2：小内訳の作成
- まとめたい複数の明細行を選択（例：No.1とNo.2の行を選択）
- [小内訳作成]ボタンをクリック
- 選択された行の上に「小内訳」行が挿入
- 選択された行は、一段階インデント（字下げ）され、「小内訳」の子要素であることが視覚的にわかる
- 「小内訳」行の金額欄には、子要素の金額合計が自動で表示

#### 4.3.3 ステップ3：中内訳・大内訳の作成
- 操作は小内訳と全く同じ
- 複数の「小内訳」を選択して[中内訳作成]ボタンを押すと、それらがまとまった「中内訳」が作成
- 同様に、複数の「中内訳」を選択して[大内訳作成]ボタンを押すと、「大内訳」が作成

#### 4.3.4 ステップ4：階層の変更
- 移動したい行（明細行でも内訳行でも）を選択
- [階層を上げる/下げる]ボタンでインデントを調整し、階層を移動
- [行を上に/下に]ボタンで、同じ階層内での表示順序を入れ替え

**「まず入力」→「後からグループ化」**という流れにより、思考を妨げずに複雑な見積書を作成可能

### 4.4 実装優先順位

#### 4.4.1 Phase 1: 基本情報編集ダイアログ
- **対象**: 見積基本情報（工事名称、受注先、担当者、工期等）
- **特徴**: 最もシンプル、バリデーション少ない
- **実装**: フォーム + バリデーション + 保存API

#### 4.4.2 Phase 2: 金額情報編集ダイアログ
- **対象**: 見積金額、消費税、各種費率
- **特徴**: 計算ロジック含む、自動計算機能
- **実装**: 計算式 + リアルタイム更新 + 保存API

#### 4.4.3 Phase 3: 見積内訳編集ダイアログ
- **対象**: 大内訳・中内訳・小内訳の階層構造
- **特徴**: 階層構造対応、ドラッグ&ドロップ
- **実装**: ツリー表示 + 階層操作 + 一括保存API

#### 4.4.4 Phase 4: 見積明細編集ダイアログ
- **対象**: 明細項目（工法、工事分類、数量、単価等）
- **特徴**: 内訳との連動、一括編集機能
- **実装**: テーブル編集 + CSV取込 + 連動保存API

## 5. データベース設計

### 5.1 テーブル構成

#### 5.1.1 見積基本情報テーブル（estimates）
- 見積ID、見積番号、顧客ID、工事種別ID、工事名称
- 工事場所、工事期間、工事内容詳細
- 見積ステータス、発行日、有効期限
- 通貨、小計、各種経費、消費税、割引、合計金額
- 利益率、利益額、支払条件、納期条件、保証期間
- 備考、作成者ID、承認者ID、承認日時
- 作成日時、更新日時、削除日時

#### 5.1.2 見積明細テーブル（estimate_items）- 階層構造対応

詳細なテーブル設計については、[見積管理機能 詳細仕様書](estimate-management.md#42-見積明細テーブル階層構造対応)を参照してください。

**主要な特徴**:
- 1テーブル階層構造による柔軟な明細管理
- 自己参照キー（parent_id）による階層関係
- 明細種別（large/medium/small/detail）による階層レベル管理
- 階層構造の動的変更に対応

#### 5.1.7 原価計画・見積枝番テーブル

詳細なテーブル設計については、[見積管理機能 詳細仕様書](estimate-management.md#43-原価計画テーブル)を参照してください。

**主要なテーブル**:
- **原価計画テーブル（cost_plans）**: 複数パターンの原価計画を管理
- **原価計画明細テーブル（cost_plan_items）**: 原価計画の明細項目を管理
- **見積枝番テーブル（estimate_branches）**: 見積の枝番バリエーションを管理

### 5.2 テーブル設計の詳細

詳細なテーブル設計、利点、比較については、[見積管理機能 詳細仕様書](estimate-management.md#42-見積明細テーブル階層構造対応)を参照してください。

### 5.5 インデックス設計
- 各テーブルの主要キーに対するインデックス
- 外部キー、ステータス、作成者などの検索用インデックス
- 複合インデックスによる検索パフォーマンス最適化

## 6. API設計

### 6.1 見積基本情報API
- GET /api/v1/estimates - 見積一覧取得
- POST /api/v1/estimates - 見積作成
- GET /api/v1/estimates/{id} - 見積詳細取得
- PUT /api/v1/estimates/{id} - 見積更新
- DELETE /api/v1/estimates/{id} - 見積削除
- POST /api/v1/estimates/{id}/status - ステータス変更
- POST /api/v1/estimates/{id}/approve - 承認
- POST /api/v1/estimates/{id}/reject - 却下

### 6.2 見積明細API（階層構造対応）

詳細なAPI設計については、[見積管理機能 詳細仕様書](estimate-management.md#51-見積明細api階層構造対応)を参照してください。

**主要なAPI**:
- 見積明細のCRUD操作
- 階層管理（移動、順序変更、展開・折りたたみ）
- 金額計算
- 階層構造取得

### 6.5 原価計画API
- GET /api/v1/estimates/{id}/cost-plans - 原価計画一覧取得
- POST /api/v1/estimates/{id}/cost-plans - 原価計画作成
- GET /api/v1/estimates/{id}/cost-plans/{plan_id} - 原価計画詳細取得
- PUT /api/v1/estimates/{id}/cost-plans/{plan_id} - 原価計画更新
- DELETE /api/v1/estimates/{id}/cost-plans/{plan_id} - 原価計画削除

### 6.6 見積枝番API
- GET /api/v1/estimates/{id}/branches - 枝番一覧取得
- POST /api/v1/estimates/{id}/branches - 枝番作成
- GET /api/v1/estimates/{id}/branches/{branch_id} - 枝番詳細取得
- PUT /api/v1/estimates/{id}/branches/{branch_id} - 枝番更新
- DELETE /api/v1/estimates/{id}/branches/{branch_id} - 枝番削除
- POST /api/v1/estimates/{id}/branches/{branch_id}/order-request - 受注申請

## 7. フロントエンド設計

### 7.1 コンポーネント構成

詳細なコンポーネント構成については、[見積管理機能 詳細仕様書](estimate-management.md#61-コンポーネント構成)を参照してください。

**主要なコンポーネント**:
- 見積基本情報管理
- 見積明細管理（階層構造対応）
- 階層構造表示・操作
- 金額計算
- 見積ステータス管理

### 7.2 状態管理

詳細な状態管理については、[見積管理機能 詳細仕様書](estimate-management.md#62-状態管理)を参照してください。

**主要な状態**:
- 見積基本情報
- 見積明細（階層構造対応）
- 原価計画
- 見積枝番
- UI状態管理

## 8. システム連携

### 8.1 工事実行予算システム連携
- 作成された見積もりの内訳を含む明細データ全体が、後工程の「工事実行予算」システムに連携
- 受注申請時に、見積データを工事データとしてコピー
- 見積の変更履歴を工事実行予算に反映

### 8.2 データ連携仕様
```typescript
// 工事データ連携インターフェース
interface ConstructionDataSync {
  // 見積から工事データへの変換
  convertEstimateToConstruction(estimate_id: number, branch_id: number): ConstructionData;
  
  // 工事データの作成
  createConstructionData(data: ConstructionData): Promise<ConstructionData>;
  
  // 見積ステータスの更新
  updateEstimateStatus(estimate_id: number, status: string): Promise<void>;
  
  // 枝番ステータスの更新
  updateBranchStatus(branch_id: number, status: string): Promise<void>;
}
```

## 9. 実装優先順位

### 9.1 Phase 1: ダイアログベース編集機能
1. **基本情報編集ダイアログ** - 見積基本情報の編集
2. **金額情報編集ダイアログ** - 見積金額・費率の編集
3. **見積内訳編集ダイアログ** - 階層構造の編集
4. **見積明細編集ダイアログ** - 明細項目の編集

### 9.2 Phase 2: 階層機能
1. 小内訳の作成・管理
2. 中内訳の作成・管理
3. 大内訳の作成・管理
4. 階層構造の表示・編集

### 9.3 Phase 3: 原価計画
1. 原価計画の作成・編集
2. 複数原価計画の管理
3. 原価計画の比較・分析

### 9.4 Phase 4: 枝番機能
1. 見積枝番の作成
2. 枝番の管理・比較
3. 受注申請機能

### 9.5 Phase 5: 承認フロー
1. 承認フローの実装
2. ステータス管理
3. 承認履歴の管理

### 9.6 Phase 6: 出力・連携
1. PDF出力機能
2. 工事実行予算システム連携
3. レポート機能

## 10. 技術実装詳細

### 10.1 ダイアログコンポーネント設計

#### 10.1.1 共通ダイアログ基盤
```typescript
interface BaseEditDialogProps {
  isOpen: boolean
  onClose: () => void
  onSave: (data: any) => Promise<void>
  title: string
  children: React.ReactNode
}

// 共通ダイアログコンポーネント
export function BaseEditDialog({ isOpen, onClose, onSave, title, children }: BaseEditDialogProps) {
  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="max-w-2xl">
        <DialogHeader>
          <DialogTitle>{title}</DialogTitle>
        </DialogHeader>
        {children}
        <DialogFooter>
          <Button variant="outline" onClick={onClose}>キャンセル</Button>
          <Button onClick={onSave}>保存</Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  )
}
```

#### 10.1.2 各編集ダイアログの実装
```typescript
// 基本情報編集ダイアログ
export function EstimateBasicInfoEditDialog({ estimate, isOpen, onClose }: Props) {
  const [formData, setFormData] = useState(estimate)
  const updateEstimateMutation = useUpdateEstimate()
  
  const handleSave = async () => {
    await updateEstimateMutation.mutateAsync({
      id: estimate.id,
      data: formData
    })
    onClose()
  }
  
  return (
    <BaseEditDialog isOpen={isOpen} onClose={onClose} onSave={handleSave} title="基本情報編集">
      <EstimateBasicInfoForm data={formData} onChange={setFormData} />
    </BaseEditDialog>
  )
}
```

### 10.2 状態管理設計

#### 10.2.1 楽観的更新
```typescript
// 保存後の楽観的更新
const updateEstimateMutation = useMutation({
  mutationFn: updateEstimate,
  onSuccess: () => {
    // キャッシュを無効化して最新データを取得
    queryClient.invalidateQueries({ queryKey: ['estimate', estimateId] })
    
    // 成功通知
    addToast({
      title: "保存完了",
      description: "見積情報が正常に保存されました。",
      type: "success"
    })
  },
  onError: (error) => {
    // エラー通知
    addToast({
      title: "保存失敗",
      description: "保存中にエラーが発生しました。",
      type: "error"
    })
  }
})
```

#### 10.2.2 エラーハンドリング
```typescript
// バリデーションエラーの処理
const handleSave = async () => {
  try {
    // バリデーション
    const validationResult = validateFormData(formData)
    if (!validationResult.isValid) {
      setErrors(validationResult.errors)
      return
    }
    
    // 保存実行
    await updateEstimateMutation.mutateAsync({
      id: estimate.id,
      data: formData
    })
    
    onClose()
  } catch (error) {
    // エラーハンドリング
    console.error('保存エラー:', error)
  }
}
```

### 10.3 パフォーマンス最適化

#### 10.3.1 ダイアログの遅延読み込み
```typescript
// ダイアログコンポーネントの遅延読み込み
const EstimateBasicInfoEditDialog = lazy(() => 
  import('./EstimateBasicInfoEditDialog')
)

// 使用時
<Suspense fallback={<div>読み込み中...</div>}>
  <EstimateBasicInfoEditDialog {...props} />
</Suspense>
```

#### 10.3.2 メモ化による再レンダリング最適化
```typescript
// フォームコンポーネントのメモ化
export const EstimateBasicInfoForm = memo(({ data, onChange }: Props) => {
  return (
    <div className="space-y-4">
      {/* フォーム内容 */}
    </div>
  )
})
```