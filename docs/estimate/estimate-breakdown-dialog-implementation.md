# 見積内訳編集ダイアログ実装進捗管理

## 実装概要

### 目的
見積内訳の階層構造を管理するための編集ダイアログを実装する。大内訳・中内訳・小内訳の3段階の階層構造を直感的に操作できるUIを提供する。

### 実装対象
- **コンポーネント**: `EstimateBreakdownEditDialog`
- **ファイル**: `frontend/src/components/features/estimates/EstimateDetail/EstimateBreakdownEditDialog.tsx`
- **仕様書**: `docs/estimate/estimate-breakdown.md`

## 実装構想

### 1. ダイアログ構成
```
┌─────────────────────────────────────────────────────────┐
│ 見積内訳編集                                    [×]     │
├─────────────────────────────────────────────────────────┤
│ [大内訳] [中内訳] [小内訳]                              │
├─────────────────────────────────────────────────────────┤
│ 階層表示エリア                                           │
│ ├─ 大内訳1 (編集可能)                                   │
│ │  ├─ 中内訳1-1 (編集可能)                              │
│ │  │  ├─ 小内訳1-1-1 (編集可能)                         │
│ │  │  └─ 小内訳1-1-2 (編集可能)                         │
│ │  └─ 中内訳1-2 (編集可能)                              │
│ └─ 大内訳2 (編集可能)                                   │
├─────────────────────────────────────────────────────────┤
│ [追加] [保存] [キャンセル]                              │
└─────────────────────────────────────────────────────────┘
```

### 2. タブ別機能

#### 大内訳タブ
- 大内訳の一覧表示・編集
- 中内訳・小内訳は表示しない
- 大内訳の追加・編集・削除・移動

#### 中内訳タブ
- 上位の大内訳を階層表示
- 中内訳の一覧表示・編集
- 小内訳は表示しない
- 中内訳の追加・編集・削除・移動

#### 小内訳タブ
- 上位の大内訳・中内訳を階層表示
- 小内訳の一覧表示・編集
- 小内訳の追加・編集・削除・移動

### 3. 階層表示ルール

#### 初期状態
- 小内訳タブに1行の小内訳を初期表示（削除不可）
- 中内訳・大内訳は空

#### 段階的追加
1. **小内訳のみ**: 小内訳タブで小内訳を管理
2. **中内訳追加**: 中内訳タブが追加表示、小内訳タブで上位階層表示
3. **大内訳追加**: 大内訳タブが追加表示、中内訳・小内訳タブで上位階層表示

#### 階層表示の内容
- 上位内訳の名称を表示
- 上位内訳の編集・削除は不可
- 上位内訳の選択変更は可能（1つ上のレベルまで）

### 4. 行操作機能

#### 追加
- 各タブで「追加」ボタンから新しい行を追加
- 親子関係を適切に設定

#### 編集
- 行をクリックして直接編集
- 編集ボタンは不要（常時編集可能）

#### 削除
- 行の削除ボタンで削除
- 子要素がある場合は親子関係を適切に処理

#### 移動
- 上下矢印ボタンで順序変更
- ドラッグ&ドロップで順序変更
- 同じ階層内での移動のみ

### 5. 親子関係管理

#### 親選択
- 1つ上のレベルまでの親を選択可能
- 選択肢は上位タブで入力された値から生成

#### 親削除時の処理
- 親が削除された場合、子は「未設定」親に移動
- 「未設定」親は上位内訳と紐づけのない内訳を表示

## 実装タスクリスト

### Phase 1: 基本構造実装
- [x] ダイアログの基本レイアウト作成
- [x] タブコンポーネントの実装
- [x] 基本的な状態管理の設定

### Phase 2: データ表示実装
- [x] 階層データの取得・表示
- [x] タブ別の表示ロジック実装
- [x] 階層表示の実装

### Phase 3: 行操作機能実装
- [x] 行の追加機能
- [x] 行の編集機能（直接編集）
- [x] 行の削除機能
- [x] 行の移動機能（上下矢印）

### Phase 4: 親子関係管理実装
- [x] 親選択機能
- [x] 親削除時の子要素処理
- [x] 「未設定」親の処理

### Phase 5: 段階的追加機能実装
- [x] 小内訳→中内訳の追加
- [x] 中内訳→大内訳の追加
- [x] タブの動的表示/非表示

### Phase 6: データ保存機能実装
- [x] ローカル状態での変更管理
- [x] 保存ボタンでの一括保存
- [x] バリデーション機能

### Phase 7: UI/UX改善
- [ ] ドラッグ&ドロップ機能
- [ ] アニメーション効果
- [ ] エラーハンドリング

### Phase 8: 統合・テスト
- [x] 見積詳細ページへの統合
- [ ] 動作テスト
- [ ] バグ修正

## 技術仕様

### 使用技術
- **React**: コンポーネント実装
- **TypeScript**: 型安全性
- **Shadcn/ui**: UIコンポーネント
- **React Query**: データ取得・キャッシュ
- **Zustand**: 状態管理（必要に応じて）

### データ構造
```typescript
interface BreakdownEditState {
  largeBreakdowns: EstimateBreakdown[]
  mediumBreakdowns: EstimateBreakdown[]
  smallBreakdowns: EstimateBreakdown[]
  activeTab: 'large' | 'medium' | 'small'
  hasChanges: boolean
}
```

### API連携
- **取得**: `GET /api/estimate-breakdowns/{estimateId}`
- **保存**: `PUT /api/estimate-breakdowns/{estimateId}`
- **個別更新**: `PATCH /api/estimate-breakdowns/{breakdownId}`

## 進捗状況

### 現在の状況
- **Phase**: Phase 7 UI/UX改善
- **完了率**: 85%
- **次のタスク**: UI/UX改善（ドラッグ&ドロップ、アニメーション、エラーハンドリング）

### 完了済み
- [x] 仕様書作成 (`estimate-breakdown.md`)
- [x] 実装計画策定
- [x] Phase 1: 基本構造実装
- [x] Phase 2: データ表示実装
- [x] Phase 3: 行操作機能実装
- [x] Phase 4: 親子関係管理実装
- [x] Phase 5: 段階的追加機能実装
- [x] Phase 6: データ保存機能実装
- [x] Phase 8: 見積詳細ページへの統合

### 進行中
- [ ] Phase 7: UI/UX改善

### 未着手
- [ ] Phase 8: 動作テスト・バグ修正

## 注意事項

### 実装時の考慮点
1. **パフォーマンス**: 大量の内訳データでの動作確認
2. **ユーザビリティ**: 直感的な操作感の実現
3. **データ整合性**: 親子関係の適切な管理
4. **エラーハンドリング**: ネットワークエラーやバリデーションエラーへの対応

### 既存システムとの整合性
- 見積詳細ページの既存UIとの統一感
- 既存のAPI仕様との整合性
- データベース設計との整合性

## 更新履歴

| 日付 | 更新内容 | 担当者 |
|------|----------|--------|
| 2024-12-19 | 初版作成 | AI Assistant |
| 2024-12-19 | Phase 1-3, 6, 8の基本実装完了 | AI Assistant |
| 2024-12-19 | Phase 4-5の親子関係管理・段階的追加機能実装完了 | AI Assistant |
