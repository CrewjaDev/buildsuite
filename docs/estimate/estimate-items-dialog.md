# 見積明細編集ダイアログ仕様書

## 概要

見積明細編集ダイアログは、見積内訳に紐づく明細項目の管理を行うためのダイアログです。見積内訳編集ダイアログと連携して、2段階管理システムを実現します。

## 基本概念

### 2段階管理システム
1. **第1段階**: 見積内訳編集ダイアログ - 内訳構造の定義
2. **第2段階**: 見積明細編集ダイアログ - 明細項目の管理

### 明細項目の特徴
- 小内訳に紐づく明細項目のみを管理
- 明細項目は工事内容の具体的な作業項目
- 数量、単価、金額の計算機能
- 工事分類、発注先の管理

## 機能仕様

### 1. ダイアログ基本構成

#### 1.1 ダイアログレイアウト
```
┌─────────────────────────────────────────────────────────┐
│ 見積明細編集                                    [×]     │
├─────────────────────────────────────────────────────────┤
│ 小内訳選択: [ドロップダウン]                             │
├─────────────────────────────────────────────────────────┤
│ 明細項目一覧                                             │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ 操作 │ 明細名称 │ 工事分類 │ 数量 │ 単価 │ 金額 │ 削除 │ │
│ ├─────────────────────────────────────────────────────┤ │
│ │  ↑   │ 明細1   │ 分類A   │  1   │ 1000 │ 1000 │  🗑  │ │
│ │  ↓   │ 明細2   │ 分類B   │  2   │ 2000 │ 4000 │  🗑  │ │
│ └─────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────┤
│                                    [+ 明細を追加]       │
├─────────────────────────────────────────────────────────┤
│                                    [キャンセル] [保存]  │
└─────────────────────────────────────────────────────────┘
```

#### 1.2 ダイアログサイズ
- 幅: `max-w-6xl` (見積内訳編集ダイアログより小さい)
- 高さ: `max-h-[70vh]`
- スクロール: 明細項目が多い場合は縦スクロール

### 2. 小内訳選択機能

#### 2.1 小内訳ドロップダウン
- **データソース**: 見積内訳編集ダイアログで定義された小内訳
- **表示形式**: `小内訳名称 (親中内訳名称)`
- **初期選択**: 最初の小内訳を自動選択
- **変更時**: 選択した小内訳の明細項目を表示

#### 2.2 小内訳情報表示
```
選択中の小内訳: クラック補修 (西面)
```

### 3. 明細項目管理

#### 3.1 明細項目テーブル

##### 3.1.1 テーブルヘッダー
| 列名 | 幅 | 説明 |
|------|-----|------|
| 操作 | 80px | 上下移動ボタン |
| 明細名称 | 200px | 明細項目の名称 |
| 工事分類 | 150px | 工事分類の選択 |
| 数量 | 80px | 数量入力 |
| 単位 | 80px | 単位選択 |
| 単価 | 100px | 単価入力 |
| 金額 | 100px | 自動計算（数量×単価） |
| 発注先 | 150px | 発注先選択 |
| 削除 | 60px | 削除ボタン |

##### 3.1.2 明細項目行
- **最小行数**: 1行（削除不可）
- **最大行数**: 制限なし
- **行の追加**: テーブル下部の「+ 明細を追加」ボタン
- **行の削除**: 各行の削除ボタン（最小行数は削除不可）

#### 3.2 明細項目フィールド

##### 3.2.1 明細名称
- **必須**: はい
- **入力形式**: テキスト入力
- **プレースホルダー**: "明細名称を入力"
- **バリデーション**: 空文字不可

##### 3.2.2 工事分類
- **必須**: いいえ
- **入力形式**: ドロップダウン選択
- **データソース**: 工事分類マスタ
- **検索機能**: あり（PopoverSearchFilter使用）

##### 3.2.3 数量
- **必須**: はい
- **入力形式**: 数値入力
- **初期値**: 1
- **最小値**: 0.01
- **小数点**: 2桁まで

##### 3.2.4 単位
- **必須**: はい
- **入力形式**: ドロップダウン選択
- **選択肢**: 式、m²、m、個、kg、t、台、本、枚、その他
- **初期値**: "式"

##### 3.2.5 単価
- **必須**: はい
- **入力形式**: 数値入力
- **初期値**: 0
- **最小値**: 0
- **小数点**: 0桁（整数）

##### 3.2.6 金額
- **必須**: いいえ（自動計算）
- **計算式**: 数量 × 単価
- **表示形式**: 数値（カンマ区切り）
- **編集**: 不可（読み取り専用）

##### 3.2.7 発注先
- **必須**: いいえ
- **入力形式**: ドロップダウン選択
- **データソース**: 発注先マスタ
- **検索機能**: あり（PopoverSearchFilter使用）

### 4. 操作機能

#### 4.1 明細項目の追加
- **ボタン位置**: テーブル下部
- **ボタンラベル**: "+ 明細を追加"
- **動作**: 新しい明細項目行を追加
- **初期値**: 明細名称="", 数量=1, 単価=0, 単位="式"

#### 4.2 明細項目の削除
- **ボタン位置**: 各行の右端
- **ボタンアイコン**: ゴミ箱アイコン
- **制限**: 最小行数（1行）は削除不可
- **確認**: 削除確認なし（即座に削除）

#### 4.3 明細項目の順序変更
- **ボタン位置**: 各行の左端
- **ボタン**: 上矢印、下矢印
- **動作**: 明細項目の表示順序を変更
- **制限**: 最初の行は上移動不可、最後の行は下移動不可

### 5. データ管理

#### 5.1 ローカル状態管理
```typescript
interface EstimateItemsEditState {
  selectedSmallBreakdownId: string | null
  items: EstimateItem[]
  hasChanges: boolean
}
```

#### 5.2 データ取得
- **API**: `useEstimateItems(estimateId, smallBreakdownId)`
- **キャッシュ**: React Query使用
- **更新**: 小内訳選択変更時に再取得

#### 5.3 データ保存
- **保存方式**: 一括保存
- **API**: `useCreateEstimateItem`, `useUpdateEstimateItem`, `useDeleteEstimateItem`
- **バリデーション**: 保存前に必須項目チェック
- **エラーハンドリング**: 保存失敗時のエラー表示

### 6. バリデーション

#### 6.1 必須項目チェック
- 明細名称: 空文字不可
- 数量: 0より大きい値
- 単価: 0以上の値

#### 6.2 数値バリデーション
- 数量: 小数点2桁まで
- 単価: 整数のみ
- 金額: 自動計算（編集不可）

#### 6.3 保存時バリデーション
- すべての明細項目の必須項目が入力されているか
- 数値フィールドが有効な値か

### 7. エラーハンドリング

#### 7.1 データ取得エラー
- **エラー表示**: ダイアログ内にエラーメッセージ
- **リトライ**: 再取得ボタンを表示
- **フォールバック**: 空の明細項目リストを表示

#### 7.2 保存エラー
- **エラー表示**: トーストメッセージ
- **詳細**: エラーの詳細をコンソールに出力
- **リトライ**: 保存ボタンで再試行可能

### 8. ユーザビリティ

#### 8.1 レスポンシブ対応
- **デスクトップ**: 全列表示
- **タブレット**: 主要列のみ表示
- **モバイル**: 縦スクロール対応

#### 8.2 アクセシビリティ
- **キーボード操作**: Tabキーで順次移動
- **スクリーンリーダー**: 適切なラベル設定
- **フォーカス管理**: ダイアログ開閉時のフォーカス制御

#### 8.3 パフォーマンス
- **仮想化**: 大量の明細項目がある場合の仮想スクロール
- **デバウンス**: 数値入力時の自動計算のデバウンス
- **メモ化**: 不要な再レンダリングの防止

## 技術仕様

### 1. コンポーネント構成

#### 1.1 メインコンポーネント
```typescript
EstimateItemsEditDialog
├── SmallBreakdownSelector
├── EstimateItemsTable
│   ├── EstimateItemsTableHeader
│   ├── EstimateItemsTableRow
│   └── EstimateItemsTableFooter
└── EstimateItemsEditDialogFooter
```

#### 1.2 子コンポーネント
- **SmallBreakdownSelector**: 小内訳選択ドロップダウン
- **EstimateItemsTable**: 明細項目テーブル
- **EstimateItemsTableRow**: 明細項目行
- **EstimateItemsTableFooter**: 明細追加ボタン

### 2. データフロー

#### 2.1 データ取得フロー
```
1. ダイアログ開封
2. 小内訳一覧取得 (useEstimateBreakdowns)
3. 初期小内訳選択
4. 明細項目取得 (useEstimateItems)
5. ローカル状態に設定
```

#### 2.2 データ保存フロー
```
1. バリデーション実行
2. 新規作成項目の処理
3. 更新項目の処理
4. 削除項目の処理
5. 一括保存実行
6. キャッシュ更新
7. 成功通知
```

### 3. API仕様

#### 3.1 明細項目取得
```typescript
GET /api/estimate-items?estimate_id={estimateId}&small_breakdown_id={smallBreakdownId}
```

#### 3.2 明細項目作成
```typescript
POST /api/estimate-items
{
  estimate_id: string
  small_breakdown_id: string
  name: string
  construction_classification_id?: number
  quantity: number
  unit: string
  unit_price: number
  supplier_id?: number
}
```

#### 3.3 明細項目更新
```typescript
PUT /api/estimate-items/{itemId}
{
  name: string
  construction_classification_id?: number
  quantity: number
  unit: string
  unit_price: number
  supplier_id?: number
}
```

#### 3.4 明細項目削除
```typescript
DELETE /api/estimate-items/{itemId}
```

### 4. 状態管理

#### 4.1 ローカル状態
```typescript
interface EstimateItemsEditState {
  selectedSmallBreakdownId: string | null
  items: EstimateItem[]
  hasChanges: boolean
  isLoading: boolean
  error: string | null
}
```

#### 4.2 グローバル状態
- **React Query**: 明細項目データのキャッシュ
- **Toast**: 成功・エラーメッセージ
- **Dialog**: ダイアログの開閉状態

## 実装計画

### Phase 1: 基本構造実装
- [ ] ダイアログレイアウト
- [ ] 小内訳選択機能
- [ ] 明細項目テーブル基本構造
- [ ] 状態管理の設定

### Phase 2: 明細項目管理機能
- [ ] 明細項目の追加・削除
- [ ] 明細項目の編集
- [ ] 順序変更機能
- [ ] バリデーション

### Phase 3: データ連携
- [ ] API連携
- [ ] データ保存機能
- [ ] エラーハンドリング
- [ ] キャッシュ管理

### Phase 4: UI/UX改善
- [ ] レスポンシブ対応
- [ ] アクセシビリティ
- [ ] パフォーマンス最適化
- [ ] ユーザビリティ向上

### Phase 5: 統合・テスト
- [ ] 見積内訳編集ダイアログとの連携
- [ ] 見積詳細ページとの統合
- [ ] 総合テスト
- [ ] ドキュメント整備

## 関連ドキュメント

- [見積内訳編集ダイアログ仕様書](./estimate-breakdown.md)
- [見積管理機能仕様書](./estimate-management.md)
- [見積データベース設計書](./estimate-database-design.md)
- [見積内訳編集ダイアログ実装進捗](./estimate-breakdown-dialog-implementation.md)
