# 見積明細編集ダイアログ実装進捗

## 実装概要

見積明細編集ダイアログは、見積内訳に紐づく明細項目の管理を行うためのダイアログです。見積内訳編集ダイアログと連携して、2段階管理システムを実現します。

## 実装コンセプト

### 2段階管理システム
1. **第1段階**: 見積内訳編集ダイアログ - 内訳構造の定義
2. **第2段階**: 見積明細編集ダイアログ - 明細項目の管理

### 設計原則
- **シンプルなUI**: 明細項目の管理に特化したシンプルなインターフェース
- **効率的な操作**: 一括編集、バリデーション、自動計算
- **データ整合性**: 見積内訳との整合性を保つ
- **ユーザビリティ**: 直感的な操作、エラーハンドリング

## 実装タスク一覧

### Phase 1: 基本構造実装
- [ ] **1.1 ダイアログレイアウト**
  - [ ] DialogContentの基本構造
  - [ ] ヘッダー（タイトル、説明）
  - [ ] フッター（キャンセル、保存ボタン）
  - [ ] レスポンシブ対応

- [ ] **1.2 小内訳選択機能**
  - [ ] 小内訳ドロップダウン
  - [ ] 小内訳情報表示
  - [ ] 選択変更時のデータ再取得

- [ ] **1.3 状態管理設定**
  - [ ] EstimateItemsEditStateインターフェース
  - [ ] ローカル状態管理
  - [ ] データ取得フック

### Phase 2: 明細項目管理機能
- [ ] **2.1 明細項目テーブル**
  - [ ] テーブルヘッダー
  - [ ] 明細項目行コンポーネント
  - [ ] テーブルフッター（追加ボタン）

- [ ] **2.2 明細項目フィールド**
  - [ ] 明細名称入力
  - [ ] 工事分類選択
  - [ ] 数量・単価入力
  - [ ] 単位選択
  - [ ] 発注先選択

- [ ] **2.3 行操作機能**
  - [ ] 明細項目の追加
  - [ ] 明細項目の削除
  - [ ] 順序変更（上下移動）
  - [ ] 最小行数制限

### Phase 3: データ連携
- [ ] **3.1 API連携**
  - [ ] 明細項目取得API
  - [ ] 明細項目作成API
  - [ ] 明細項目更新API
  - [ ] 明細項目削除API

- [ ] **3.2 データ保存機能**
  - [ ] 一括保存処理
  - [ ] 新規作成・更新・削除の分離
  - [ ] バリデーション実行
  - [ ] エラーハンドリング

- [ ] **3.3 キャッシュ管理**
  - [ ] React Queryキャッシュ
  - [ ] データ更新時のキャッシュ無効化
  - [ ] 見積詳細ページとの同期

### Phase 4: バリデーション・エラーハンドリング
- [ ] **4.1 入力バリデーション**
  - [ ] 必須項目チェック
  - [ ] 数値バリデーション
  - [ ] 文字数制限

- [ ] **4.2 保存時バリデーション**
  - [ ] 全明細項目の必須項目チェック
  - [ ] 数値フィールドの有効性チェック
  - [ ] 重複チェック

- [ ] **4.3 エラーハンドリング**
  - [ ] データ取得エラー
  - [ ] 保存エラー
  - [ ] ネットワークエラー
  - [ ] ユーザーフレンドリーなエラーメッセージ

### Phase 5: UI/UX改善
- [ ] **5.1 レスポンシブ対応**
  - [ ] デスクトップ表示
  - [ ] タブレット表示
  - [ ] モバイル表示

- [ ] **5.2 アクセシビリティ**
  - [ ] キーボード操作対応
  - [ ] スクリーンリーダー対応
  - [ ] フォーカス管理

- [ ] **5.3 パフォーマンス最適化**
  - [ ] 仮想スクロール（大量データ時）
  - [ ] デバウンス処理
  - [ ] メモ化

### Phase 6: 統合・テスト
- [ ] **6.1 見積内訳編集ダイアログとの連携**
  - [ ] 小内訳データの同期
  - [ ] 明細項目の表示・非表示
  - [ ] データ整合性の確保

- [ ] **6.2 見積詳細ページとの統合**
  - [ ] 明細項目の表示
  - [ ] 金額計算の反映
  - [ ] データ更新の同期

- [ ] **6.3 総合テスト**
  - [ ] 機能テスト
  - [ ] 統合テスト
  - [ ] ユーザビリティテスト

## 技術仕様

### コンポーネント構成
```
EstimateItemsEditDialog
├── SmallBreakdownSelector
├── EstimateItemsTable
│   ├── EstimateItemsTableHeader
│   ├── EstimateItemsTableRow
│   └── EstimateItemsTableFooter
└── EstimateItemsEditDialogFooter
```

### データフロー
```
1. ダイアログ開封
2. 小内訳一覧取得
3. 初期小内訳選択
4. 明細項目取得
5. ローカル状態に設定
6. ユーザー操作
7. ローカル状態更新
8. 保存処理
9. API呼び出し
10. キャッシュ更新
11. 成功通知
```

### API仕様
- **GET** `/api/estimate-items?estimate_id={estimateId}&small_breakdown_id={smallBreakdownId}`
- **POST** `/api/estimate-items`
- **PUT** `/api/estimate-items/{itemId}`
- **DELETE** `/api/estimate-items/{itemId}`

## 進捗ログ

### 2024-01-XX: 仕様書作成完了
- [x] 見積明細編集ダイアログの専用仕様書を作成
- [x] 実装計画の策定
- [x] 技術仕様の定義

### 次のステップ
1. **Phase 1開始**: 基本構造実装
2. **コンポーネント作成**: EstimateItemsEditDialog
3. **状態管理設定**: ローカル状態とAPI連携
4. **UI実装**: テーブルとフォーム要素

## 関連ファイル

### フロントエンド
- `frontend/src/components/features/estimates/EstimateDetail/EstimateItemsEditDialog.tsx` (新規作成)
- `frontend/src/hooks/features/estimates/useEstimateItems.ts` (新規作成)
- `frontend/src/services/features/estimates/estimateItemsService.ts` (新規作成)
- `frontend/src/types/features/estimates/estimateItem.ts` (新規作成)

### バックエンド
- `backend/app/Http/Controllers/EstimateItemController.php` (新規作成)
- `backend/routes/api.php` (更新)

### ドキュメント
- `docs/estimate/estimate-items-dialog.md` (作成済み)
- `docs/estimate/estimate-items-dialog-implementation.md` (本ファイル)

## 注意事項

### 実装時の考慮点
1. **見積内訳編集ダイアログとの連携**: 小内訳データの同期
2. **データ整合性**: 明細項目と内訳の整合性確保
3. **パフォーマンス**: 大量の明細項目がある場合の対応
4. **ユーザビリティ**: 直感的な操作、エラーメッセージ

### 既存システムとの整合性
- 見積内訳編集ダイアログの実装パターンを踏襲
- 既存のUIコンポーネント（PopoverSearchFilter等）を活用
- 既存のAPI設計パターンに準拠

## 完了基準

### Phase 1完了基準
- [ ] ダイアログが正常に開閉できる
- [ ] 小内訳選択が動作する
- [ ] 明細項目テーブルが表示される
- [ ] 基本的な状態管理が動作する

### Phase 2完了基準
- [ ] 明細項目の追加・削除が動作する
- [ ] 明細項目の編集が動作する
- [ ] 順序変更が動作する
- [ ] バリデーションが動作する

### Phase 3完了基準
- [ ] API連携が動作する
- [ ] データ保存が動作する
- [ ] エラーハンドリングが動作する
- [ ] キャッシュ管理が動作する

### 全体完了基準
- [ ] 見積内訳編集ダイアログとの連携が動作する
- [ ] 見積詳細ページとの統合が動作する
- [ ] 総合テストが完了する
- [ ] ドキュメントが整備される
