# 見積内訳編集ダイアログ 操作仕様書

## 概要

見積内訳編集ダイアログは、見積の階層構造（大内訳・中内訳・小内訳）を管理するための専用ダイアログです。各内訳レベルの編集、親子関係の管理、階層構造の構築を行います。

## ダイアログの基本構成

### タブ構成
- **大内訳タブ**: 大内訳の編集・管理
- **中内訳タブ**: 中内訳の編集・管理（大内訳との階層表示）
- **小内訳タブ**: 小内訳の編集・管理（中内訳との階層表示）

### 基本操作
- **編集**: 各内訳行のフィールドを直接編集（編集ボタン不要）
- **追加**: 新しい内訳行の追加
- **削除**: 内訳行の削除
- **保存**: 変更内容の一括保存（データベース更新）
- **キャンセル**: 変更内容の破棄

## 各タブの詳細仕様

### 大内訳タブ

#### 表示内容
```
【大内訳タブ】
┌─────────────────────────────────────────────────────────┐
│工法      │工事分類│摘要│数量│単価│金額│発注先│予想原価│操作│ │
├─────────────────────────────────────────────────────────┤
│[大内訳1]│[▼]│[摘要1]│[1]│[0]│[0]│[▼]│[0]│[削除][↑][↓]│ │
│[大内訳2]│[▼]│[摘要2]│[1]│[0]│[0]│[▼]│[0]│[削除][↑][↓]│ │
└─────────────────────────────────────────────────────────┘
│ [大内訳追加] ← 全体用の追加ボタン
```

#### 操作制限
- ✅ **大内訳の追加・編集・削除・移動**
- ❌ **中内訳・小内訳の操作**（不可）

#### フィールド構成
| フィールド | タイプ | 説明 |
|-----------|--------|------|
| 工法 | テキスト表示 | 大内訳の名称（編集不可） |
| 工事分類 | ドロップダウン | 工事分類の選択 |
| 摘要 | テキスト入力 | 大内訳の詳細説明 |
| 数量 | 数値入力 | 数量 |
| 単価 | 数値入力 | 単価 |
| 金額 | 数値入力 | 金額（自動計算） |
| 発注先 | ドロップダウン | 発注先の選択 |
| 予想原価 | 数値入力 | 予想原価 |



### 中内訳タブ

#### 表示内容
```
【中内訳タブ】
┌─────────────────────────────────────────────────────────┐
│工法      │工事分類│摘要│数量│単価│金額│発注先│予想原価│操作│ │
├─────────────────────────────────────────────────────────┤
│[大内訳1▼]│ │ │ │ │ │ │ │[削除][追加]│ │
│ ├─[中内訳1]│[▼]│[摘要1]│[1]│[0]│[0]│[▼]│[0]│[削除][↑][↓]│ │
│ └─[中内訳2]│[▼]│[摘要2]│[1]│[0]│[0]│[▼]│[0]│[削除][↑][↓]│ │
│[大内訳2▼]│ │ │ │ │ │ │ │[削除][追加]│ │
│ ├─[中内訳3]│[▼]│[摘要3]│[1]│[0]│[0]│[▼]│[0]│[削除][↑][↓]│ │
└─────────────────────────────────────────────────────────┘
│ [中内訳追加] ← 全体用の追加ボタン
```

#### 操作制限
- ✅ **中内訳の追加・編集・削除・移動**
- ✅ **大内訳の選択変更**（ドロップダウン）
- ✅ **大内訳との紐づけを無効化**（親子関係を解除）
- ❌ **大内訳の編集・削除**（不可）

#### フィールド構成
| 行の種類 | 工法列 | 工事分類列 | 摘要列 | その他 |
|----------|--------|------------|--------|--------|
| 大内訳行（階層表示） | 大内訳名称 | - | - | 削除・追加ボタンのみ |
| 中内訳行（内訳項目） | 中内訳名称 | ドロップダウン | テキスト入力 | 数量・単価・金額・発注先・予想原価・削除ボタン |

#### 階層表示ルール
- **大内訳行**: 階層表示行（編集不可、選択のみ可能）
- **中内訳行**: 内訳項目行（工法列に中内訳名称、編集可能、削除可能）
- **親子関係**: 大内訳と中内訳の階層関係を表示

#### 操作ボタン
| ボタン | 対象 | 動作 |
|--------|------|------|
| 削除 | 大内訳行 | 大内訳との紐づけを取り消す |
| 追加 | 大内訳行 | 大内訳の下に中内訳を追加 |
| 削除 | 中内訳行 | 中内訳を削除 |
| ↑ | 中内訳行 | 中内訳を上に移動 |
| ↓ | 中内訳行 | 中内訳を下に移動 |


### 小内訳タブ

#### 表示内容
```
【小内訳タブ】
┌─────────────────────────────────────────────────────────┐
│工法        │工事分類│摘要│数量│単価│金額│発注先│予想原価│操作│ │
├─────────────────────────────────────────────────────────┤
│[中１▼]│ │ │ │ │ │ │ │[削除][追加]│ │
│ ├─[小内訳 A1]│[▼]│[摘要A1]│[1]│[0]│[0]│[▼]│[0]│[削除][↑][↓]│ │
│[中２▼]│ │ │ │ │ │ │ │[削除][追加]│ │
│ ├─[小内訳 B1]│[▼]│[摘要B1]│[1]│[0]│[0]│[▼]│[0]│[削除][↑][↓]│ │
└─────────────────────────────────────────────────────────┘
│ [小内訳追加] ← 全体用の追加ボタン
```

#### 操作制限
- ✅ **小内訳の追加・編集・削除・移動**
- ✅ **中内訳の選択変更**（ドロップダウン）
- ✅ **中内訳との紐づけを無効化**（親子関係を解除）
- ❌ **中内訳の編集・削除**（不可）

#### フィールド構成
| 行の種類 | 工法列 | 工事分類列 | 摘要列 | その他 |
|----------|--------|------------|--------|--------|
| 中内訳行（階層表示） | 中内訳名称 | - | - | 削除・追加ボタンのみ |
| 小内訳行（内訳項目） | 小内訳名称 | ドロップダウン | テキスト入力 | 数量・単価・金額・発注先・予想原価・削除ボタン |

#### 階層表示ルール
- **中内訳行**: 階層表示行（編集不可、選択のみ可能）
- **小内訳行**: 内訳項目行（工法列に小内訳名称、編集可能、削除可能）
- **親子関係**: 中内訳と小内訳の階層関係を表示

#### 操作ボタン
| ボタン | 対象 | 動作 |
|--------|------|------|
| 削除 | 中内訳行 | 中内訳との紐づけを取り消す |
| 追加 | 中内訳行 | 中内訳の下に小内訳を追加 |
| 削除 | 小内訳行 | 小内訳を削除 |
| ↑ | 小内訳行 | 小内訳を上に移動 |
| ↓ | 小内訳行 | 小内訳を下に移動 |






## 初期状態と段階的追加

### 初期状態
- **小内訳**: 1行を初期表示（削除不可）
- **中内訳**: なし
- **大内訳**: なし

### 段階的追加フロー
```
1. 小内訳のみの状態
   ↓
2. 中内訳を追加
   - 中内訳タブが表示される
   - 小内訳タブで中内訳が階層表示される
   - 中内訳は「中内訳(未設定)」として表示
   ↓
3. 大内訳を追加
   - 大内訳タブが表示される
   - 中内訳タブで大内訳が階層表示される
   - 大内訳は「大内訳(未設定)」として表示
```

## 親子関係の管理

### 親選択の制限
- **中内訳**: 大内訳のみを親として選択可能
- **小内訳**: 中内訳のみを親として選択可能
- **1つ上のレベル**: 直接の親のみ変更可能

### 階層表示での上位内訳変更機能（1つ上のみ）

#### 中内訳タブでの表示例
```
【中内訳タブ】
┌─────────────────────────────────────────────────────────┐
│工法      │工事分類│摘要│数量│単価│金額│発注先│予想原価│操作│ │
├─────────────────────────────────────────────────────────┤
│[大内訳1▼]│ │ │ │ │ │ │ │[削除][追加]│ │
│ ├─[中内訳1]│[▼]│[摘要1]│[1]│[0]│[0]│[▼]│[0]│[削除]│ │
│ └─[中内訳2]│[▼]│[摘要2]│[1]│[0]│[0]│[▼]│[0]│[削除]│ │
└─────────────────────────────────────────────────────────┘
```

#### 小内訳タブでの表示例
```
【小内訳タブ】
┌─────────────────────────────────────────────────────────┐
│工法      │工事分類│摘要│数量│単価│金額│発注先│予想原価│操作│ │
├─────────────────────────────────────────────────────────┤
│[大内訳1]│ │ │ │ │ │ │ │ │ │
│ ├─[中内訳1▼]│ │ │ │ │ │ │ │[削除][追加]│ │
│ │ ├─[小内訳1]│[▼]│[摘要1]│[1]│[0]│[0]│[▼]│[0]│[削除]│ │
│ │ └─[小内訳2]│[▼]│[摘要2]│[1]│[0]│[0]│[▼]│[0]│[削除]│ │
│ └─[中内訳2▼]│ │ │ │ │ │ │ │[削除][追加]│ │
│   └─[小内訳3]│[▼]│[摘要3]│[1]│[0]│[0]│[▼]│[0]│[削除]│ │
└─────────────────────────────────────────────────────────┘
```

#### 変更制限
- **小内訳タブ**: 中内訳のみ変更可能（1つ上のみ）
- **中内訳タブ**: 大内訳のみ変更可能（1つ上のみ）





### 親選択の更新タイミング
- **選択肢の更新**: ユーザーがドロップダウンを開いた時
- **表示名の更新**: ユーザーが新しい親を選択した時
- **自動更新**: 親の名称変更時は自動更新しない

### 親削除時の処理
```
1. 親内訳を削除
   ↓
2. 子内訳のparent_idをnullに設定
   ↓
3. 子内訳を「中内訳(未設定)」の下に移動
   ↓
4. 階層表示を更新
```

## 特殊な内訳

### 大内訳(未設定)　中内訳(未設定)　小内訳(未設定)
- **用途**: 親子関係のない小内訳を表示する仮想的な内訳
- **特徴**: 削除不可、編集不可
- **表示**: 小内訳タブでのみ表示

### 初期内訳の命名
- **中内訳(未設定)**: 中内訳追加時の初期名称
- **大内訳(未設定)**: 大内訳追加時の初期名称
- **小内訳(未設定)**: 小内訳追加時の初期名称

## 階層表示での上位内訳選択肢の更新仕様

### 1. 選択肢更新のタイミング
- **自動更新ではなく、ユーザー選択で更新**
- **中内訳タブで名称変更**: 小内訳タブの選択肢は自動更新されない
- **ユーザーが選択**: ドロップダウンを開いた時に最新の選択肢を表示

### 2. 操作フロー（中内訳追加から名称設定まで）
```
1. 中内訳追加: 中内訳(未設定) で作成
   ↓
2. 小内訳タブ表示: [中内訳(未設定)▼] で表示
   ↓
3. 中内訳タブで名称入力: 中１ を入力
   ↓
4. 小内訳タブ: 表示は [中内訳(未設定)▼] のまま
   ↓
5. ユーザーがドロップダウンを開く: 選択肢に 中１ が表示される
   ↓
6. ユーザーが 中１ を選択: [中１▼] で表示更新
```

## 行の移動機能

### 移動可能な行
- **大内訳行**: 大内訳タブ内での移動
- **中内訳行**: 中内訳タブ内での移動（異なる大内訳間での移動も可能）
- **小内訳行**: 小内訳タブ内での移動（異なる中内訳間での移動も可能）

### 移動方法
1. **上下矢印ボタン**: 1行ずつ上下に移動
2. **ドラッグ&ドロップ**: 行をドラッグして任意の位置に移動

### 移動制限
- **階層表示行**: 移動不可（大内訳行、中内訳行の階層表示部分）
- **親を跨ぐ移動**: 可能（中内訳は異なる大内訳間、小内訳は異なる中内訳間での移動も可能）
- **階層レベルを跨ぐ移動**: 不可（大内訳→中内訳、中内訳→小内訳への移動は不可）

### 移動時の処理
```
1. 行の移動操作
   ↓
2. 親子関係の更新（異なる親への移動時）
   ↓
3. display_orderの再計算
   ↓
4. 画面上の表示順序を更新
   ↓
5. 保存時にデータベースのparent_idとdisplay_orderを更新
```

### 異なる上位内訳への移動例

#### 中内訳の移動例
```
移動前:
[大内訳1▼]
├─中内訳A
└─中内訳B
[大内訳2▼]
└─中内訳C

中内訳Aを大内訳2の下に移動後:
[大内訳1▼]
└─中内訳B
[大内訳2▼]
├─中内訳C
└─中内訳A
```

#### 小内訳の移動例
```
移動前:
[中内訳1▼]
├─小内訳A
└─小内訳B
[中内訳2▼]
└─小内訳C

小内訳Aを中内訳2の下に移動後:
[中内訳1▼]
└─小内訳B
[中内訳2▼]
├─小内訳C
└─小内訳A
```

## データ管理

### ローカル状態
- **編集内容**: ダイアログ内でのみ保持
- **保存前**: データベースは更新しない
- **変更フラグ**: 変更がある場合は保存ボタンを有効化

### 保存処理
- **一括保存**: すべての変更を一度にデータベースに保存
- **エラーハンドリング**: 保存失敗時の適切な処理
- **成功時**: 変更フラグをリセット

### キャンセル処理
- **変更確認**: 変更がある場合は確認ダイアログを表示
- **状態リセット**: ローカル状態を元の状態に戻す
- **ダイアログ閉じる**: 変更を破棄してダイアログを閉じる

## 実装上の注意点

### パフォーマンス
- **大量データ**: 内訳数が多い場合の表示最適化
- **階層構築**: 効率的な階層構造の構築
- **リアルタイム更新**: 画面上の更新のみ、データベースは保存時

### ユーザビリティ
- **直感的操作**: 編集ダイアログなので最初から編集可能
- **一貫性**: 他の編集ダイアログと同じ操作感
- **エラー防止**: 不適切な操作の防止

### データ整合性
- **親子関係**: 階層構造の整合性を保つ
- **削除制限**: 子を持つ親の削除制限
- **自動移動**: 親削除時の子の自動移動

## 関連ドキュメント

- [見積管理 実装仕様書](./estimate-management.md)
- [見積管理 データベース設計](./estimate-database-design.md)
- [見積管理 実装進捗](./estimate-management-implementation.md)