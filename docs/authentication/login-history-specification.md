# ログイン履歴管理仕様

## 概要
本ドキュメントでは、BuildSuiteシステムにおけるログイン履歴の管理仕様について定義します。

## ログイン履歴の目的

### 1. セキュリティ監査
- 不正アクセスの検出
- アカウント乗っ取りの早期発見
- ログイン試行パターンの分析

### 2. 運用管理
- ユーザーのアクティビティ追跡
- アカウント使用状況の把握
- 問題発生時の原因調査

## 記録対象

### 記録するログイン試行
1. **成功したログイン**
   - 正常な認証が完了した場合
   - ユーザーID、ログイン時刻、IPアドレス、ユーザーエージェントを記録

2. **失敗したログイン（既存ユーザー）**
   - パスワードが間違っている場合
   - アカウントがロックされている場合
   - アカウントが無効の場合
   - パスワードが期限切れの場合

### 記録しないログイン試行
1. **存在しないユーザーID**
   - ログインIDが存在しない場合
   - 理由：セキュリティ上の情報漏洩を防ぐため
   - 理由：システムリソースの無駄遣いを防ぐため

## データベース設計

### user_login_history テーブル
```sql
CREATE TABLE user_login_history (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    login_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    logout_at TIMESTAMP NULL,
    ip_address INET NULL,
    user_agent TEXT NULL,
    session_id VARCHAR(255) NULL,
    status VARCHAR(50) NOT NULL, -- 'success', 'failed', 'logout'
    failure_reason VARCHAR(255) NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NULL
);
```

### 制約
- `user_id`は`NOT NULL`制約
- 存在しないユーザーのログイン試行は記録しない
- 外部キー制約により、ユーザー削除時は履歴も自動削除

## 実装方針

### 1. ログイン履歴の記録タイミング
```php
// 成功時
$this->logLoginAttempt($request, 'success', null, $user);

// 失敗時（既存ユーザー）
$this->logLoginAttempt($request, 'failed', 'パスワードが正しくありません', $user);

// 存在しないユーザーID
// ログイン履歴は記録しない
```

### 2. エラーメッセージの統一
- 存在しないユーザーIDでも「ログインIDまたはパスワードが正しくありません」
- セキュリティ上の理由で、ユーザーIDの存在有無を外部に知らせない

### 3. ログイン履歴の保持期間
- 成功したログイン：1年間保持
- 失敗したログイン：6ヶ月間保持
- 自動削除処理を定期実行

## セキュリティ考慮事項

### 1. 情報漏洩の防止
- 存在しないユーザーIDの試行を記録しないことで、システムに登録されているユーザーIDを推測されることを防ぐ
- エラーメッセージを統一することで、ユーザーIDの存在有無を外部に知らせない

### 2. ブルートフォース攻撃対策
- 既存ユーザーに対する連続した失敗試行を監視
- 一定回数失敗した場合のアカウントロック機能
- IPアドレスベースの制限（必要に応じて）

### 3. プライバシー保護
- ログイン履歴のアクセス権限を適切に管理
- 個人情報保護法に準拠したデータ管理

## 運用ルール

### 1. ログイン履歴の確認
- 管理者はユーザーのログイン履歴を確認可能
- ユーザー本人は自分のログイン履歴を確認可能
- セキュリティ監査時は全履歴を確認可能

### 2. 異常検知
- 通常と異なる時間帯のログイン
- 通常と異なるIPアドレスからのログイン
- 連続した失敗試行
- 複数のアカウントからの同一IPアドレス

### 3. 対応手順
- 異常検知時の自動通知
- 管理者による手動確認
- 必要に応じたアカウントロック
- ユーザーへの通知

## 今後の拡張予定

### 1. 高度な分析機能
- ログイン試行パターンの機械学習による分析
- 異常検知の自動化
- リスクスコアの算出

### 2. 通知機能
- リアルタイムアラート
- 定期レポート
- カスタム通知ルール

### 3. 統合機能
- SIEMシステムとの連携
- 外部セキュリティツールとの統合
- API経由での履歴取得

## まとめ

本仕様では、セキュリティとプライバシーのバランスを考慮し、以下の方針を採用しています：

1. **存在しないユーザーIDのログイン試行は記録しない**
2. **エラーメッセージは統一し、情報漏洩を防ぐ**
3. **既存ユーザーのログイン試行は詳細に記録する**
4. **適切な保持期間を設定し、プライバシーを保護する**

この方針により、セキュリティを維持しながら、システムリソースを効率的に使用し、プライバシーを保護することができます。
