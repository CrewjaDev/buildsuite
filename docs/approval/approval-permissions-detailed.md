# 承認機能 詳細権限設定ガイド

## 概要

承認権限を持つユーザーに対する詳細な権限設定と画面設計について説明します。申請、承認、却下、差戻し、承認フロー順序設定など、きめ細かい権限管理を実現する方法を具体例とともに示します。

## 🎯 承認機能の詳細権限分類

### 1. 基本承認権限

#### 申請関連権限
```php
// 申請権限の詳細分類
$applicationPermissions = [
    'approval.request.create' => [
        'display_name' => '承認依頼作成',
        'description' => '新規承認依頼を作成する権限',
        'scope' => ['own_department', 'all_departments', 'specific_projects']
    ],
    'approval.request.edit' => [
        'display_name' => '承認依頼編集',
        'description' => '自分が作成した承認依頼の編集権限',
        'conditions' => ['status:draft', 'before_approval_start']
    ],
    'approval.request.cancel' => [
        'display_name' => '承認依頼キャンセル',
        'description' => '承認依頼のキャンセル権限',
        'conditions' => ['own_request', 'status:pending']
    ],
    'approval.request.resubmit' => [
        'display_name' => '承認依頼再提出',
        'description' => '差戻された依頼の再提出権限',
        'conditions' => ['status:returned', 'original_requester']
    ]
];
```

#### 承認処理権限
```php
// 承認処理権限の詳細分類
$approvalPermissions = [
    'approval.action.approve' => [
        'display_name' => '承認実行',
        'description' => '承認依頼を承認する権限',
        'scope' => ['assigned_requests', 'department_requests', 'amount_based']
    ],
    'approval.action.reject' => [
        'display_name' => '却下実行',
        'description' => '承認依頼を却下する権限',
        'conditions' => ['require_comment', 'final_decision']
    ],
    'approval.action.return' => [
        'display_name' => '差戻実行',
        'description' => '承認依頼を差戻す権限',
        'conditions' => ['require_comment', 'specify_reason']
    ],
    'approval.action.delegate' => [
        'display_name' => '承認委譲',
        'description' => '承認権限を他者に委譲する権限',
        'scope' => ['same_level', 'subordinates', 'designated_users']
    ],
    'approval.action.parallel' => [
        'display_name' => '並列承認',
        'description' => '複数承認者による並列承認権限',
        'conditions' => ['all_required', 'majority_required', 'any_one']
    ]
];
```

### 2. 承認フロー管理権限

```php
// フロー管理権限
$flowPermissions = [
    'approval.flow.design' => [
        'display_name' => '承認フロー設計',
        'description' => '新規承認フローの設計権限',
        'scope' => ['department_flows', 'company_flows', 'project_flows']
    ],
    'approval.flow.modify' => [
        'display_name' => '承認フロー変更',
        'description' => '既存フローの変更権限',
        'conditions' => ['no_active_requests', 'version_control']
    ],
    'approval.step.configure' => [
        'display_name' => '承認ステップ設定',
        'description' => '承認ステップの詳細設定権限',
        'parameters' => ['order', 'approver', 'conditions', 'timeout']
    ],
    'approval.condition.set' => [
        'display_name' => '適用条件設定',
        'description' => 'フロー適用条件の設定権限',
        'types' => ['amount', 'department', 'project', 'priority', 'custom']
    ]
];
```

## 🎨 詳細権限設定画面の設計

### 1. 承認権限設定メイン画面

```
┌─────────────────────────────────────────────────────────────┐
│ 承認権限設定                                                │
├─────────────────────────────────────────────────────────────┤
│ ユーザー: [田中 太郎 ▼] 部署: [営業部] 役職: [課長]           │
├─────────────────────────────────────────────────────────────┤
│ 【申請権限】                                               │
│ □ 承認依頼作成    範囲: [自部署のみ ▼]                     │
│ □ 承認依頼編集    条件: [未承認のみ ▼]                     │
│ □ 承認依頼キャンセル 条件: [自分の依頼のみ ▼]               │
│ □ 承認依頼再提出  条件: [差戻案件のみ ▼]                   │
├─────────────────────────────────────────────────────────────┤
│ 【承認処理権限】                                           │
│ □ 承認実行       範囲: [割当案件 ▼] 金額上限: [1000万円]   │
│ □ 却下実行       条件: [コメント必須 ☑]                   │
│ □ 差戻実行       条件: [理由選択必須 ☑]                   │
│ □ 承認委譲       範囲: [同格以下 ▼]                       │
│ □ 並列承認参加   条件: [過半数承認 ▼]                     │
├─────────────────────────────────────────────────────────────┤
│ 【フロー管理権限】                                         │
│ □ フロー設計     範囲: [部署内フロー ▼]                   │
│ □ フロー変更     条件: [進行中案件なし ▼]                 │
│ □ ステップ設定   権限: [順序変更可 ☑] [承認者変更可 ☑]     │
│ □ 条件設定       種類: [金額 ☑] [部署 ☑] [優先度 □]        │
├─────────────────────────────────────────────────────────────┤
│ [保存] [権限テスト] [権限コピー] [リセット] [キャンセル]      │
└─────────────────────────────────────────────────────────────┘
```

### 2. 承認フロー設計画面

```
┌─────────────────────────────────────────────────────────────┐
│ 承認フロー設計：見積承認フロー（高額案件）                    │
├─────────────────────────────────────────────────────────────┤
│ 基本設定                                                   │
│ フロー名: [見積承認フロー（1000万円以上）               ]   │
│ 説明:     [1000万円以上の見積に適用される承認フロー      ]   │
│ 対象:     [見積 ▼] 優先度: [高 ▼] 有効: [☑]              │
├─────────────────────────────────────────────────────────────┤
│ 適用条件                                                   │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 条件1: 金額 >= 10,000,000 円                          │ │
│ │ 条件2: 部署 = [営業部 ▼] または [技術部 ▼]             │ │
│ │ 条件3: プロジェクト種別 = [大型案件 ▼]                 │ │
│ │ [+ 条件追加]                                          │ │
│ └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│ 承認ステップ                                               │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ Step 1: [課長承認        ] [↑] [↓] [削除]              │ │
│ │   承認者: [役職:課長 ▼] 必須: [☑] 期限: [24時間 ▼]     │ │
│ │   条件: [金額<5000万円 ▼] 委譲可: [☑] 並列: [□]        │ │
│ │                                                       │ │
│ │ Step 2: [部長承認        ] [↑] [↓] [削除]              │ │
│ │   承認者: [役職:部長 ▼] 必須: [☑] 期限: [48時間 ▼]     │ │
│ │   条件: [すべて ▼] 委譲可: [☑] 並列: [□]              │ │
│ │                                                       │ │
│ │ Step 3: [役員承認        ] [↑] [↓] [削除]              │ │
│ │   承認者: [役職:役員 ▼] 必須: [☑] 期限: [72時間 ▼]     │ │
│ │   条件: [金額>=1億円 ▼] 委譲可: [□] 並列: [☑ 2名以上]   │ │
│ │                                                       │ │
│ │ [+ ステップ追加]                                      │ │
│ └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│ 例外処理設定                                               │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 緊急案件: [承認期限短縮 ▼] 短縮時間: [50% ▼]           │ │
│ │ 期限超過: [自動エスカレーション ▼] 通知先: [上位者 ▼]   │ │
│ │ 承認者不在: [代理承認 ▼] 代理者: [同格者 ▼]            │ │
│ └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│ [保存] [フロー図表示] [テスト実行] [複製] [キャンセル]        │
└─────────────────────────────────────────────────────────────┘
```

### 3. 承認ステップ詳細設定画面

```
┌─────────────────────────────────────────────────────────────┐
│ 承認ステップ詳細設定：Step 2 - 部長承認                      │
├─────────────────────────────────────────────────────────────┤
│ 基本設定                                                   │
│ ステップ名: [部長承認                                    ] │
│ 説明:       [部長による見積内容の承認                    ] │
│ 順序:       [2] 必須: [☑] アクティブ: [☑]                 │
├─────────────────────────────────────────────────────────────┤
│ 承認者設定                                                 │
│ 承認者タイプ: [役職ベース ▼]                               │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ ○ 特定ユーザー   [田中部長 ▼]                          │ │
│ │ ● 役職ベース     [部長 ▼]                              │ │
│ │ ○ 部署ベース     [営業部 ▼] + [部長以上 ▼]             │ │
│ │ ○ システムレベル [レベル5以上 ▼]                       │ │
│ │ ○ カスタム       [条件設定... ]                        │ │
│ └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│ 承認条件設定                                               │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 条件1: 見積金額 <= [50,000,000] 円                     │ │
│ │ 条件2: 部署 = [営業部 ▼] または [技術部 ▼]             │ │
│ │ 条件3: 優先度 = [通常 ▼] 以上                          │ │
│ │ [+ 条件追加]                                          │ │
│ └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│ 処理設定                                                   │
│ 承認期限: [48] 時間  期限超過時: [上位者に通知 ▼]           │
│ 委譲可能: [☑]       委譲範囲: [同格以下 ▼]                │
│ 並列承認: [□]       必要数: [1] 名                        │
│ コメント: [任意 ▼]   必須項目: [承認理由 ▼]                │
├─────────────────────────────────────────────────────────────┤
│ 通知設定                                                   │
│ 承認依頼通知:     [☑] メール [☑] システム [□] SMS         │
│ リマインダー:     [☑] 24時間前 [☑] 12時間前 [☑] 6時間前   │
│ 期限超過通知:     [☑] 即座 [☑] 6時間後 [☑] 24時間後       │
│ 完了通知:         [☑] 承認者 [☑] 申請者 [☑] 関係者         │
├─────────────────────────────────────────────────────────────┤
│ [保存] [テスト] [プレビュー] [削除] [キャンセル]              │
└─────────────────────────────────────────────────────────────┘
```

### 4. 承認権限マトリックス画面

```
┌─────────────────────────────────────────────────────────────┐
│ 承認権限マトリックス：見積承認フロー                          │
├─────────────────────────────────────────────────────────────┤
│ 表示対象: [営業部 ▼] 金額範囲: [100万円以上 ▼]              │
├─┬─────────┬─────┬─────┬─────┬─────┬─────┬─────┤
│ │ ユーザー  │申請│承認│却下│差戻│委譲│設定│備考│
├─┼─────────┼─────┼─────┼─────┼─────┼─────┼─────┤
│営│田中 課長  │ ○ │ ○ │ ○ │ ○ │ ○ │ - │1000万円まで│
│業│佐藤 主任  │ ○ │ ○ │ ○ │ ○ │ - │ - │500万円まで │
│部│山田 担当  │ ○ │ - │ - │ - │ - │ - │申請のみ    │
│ │鈴木 部長  │ ○ │ ○ │ ○ │ ○ │ ○ │ ○ │制限なし    │
├─┼─────────┼─────┼─────┼─────┼─────┼─────┼─────┤
│技│高橋 課長  │ ○ │ ○ │ ○ │ ○ │ ○ │ - │2000万円まで│
│術│伊藤 主任  │ ○ │ ○ │ ○ │ ○ │ - │ - │1000万円まで│
│部│加藤 部長  │ ○ │ ○ │ ○ │ ○ │ ○ │ ○ │制限なし    │
├─┼─────────┼─────┼─────┼─────┼─────┼─────┼─────┤
│役│中村 常務  │ ○ │ ○ │ ○ │ ○ │ ○ │ ○ │制限なし    │
│員│松本 専務  │ ○ │ ○ │ ○ │ ○ │ ○ │ ○ │制限なし    │
├─┴─────────┴─────┴─────┴─────┴─────┴─────┴─────┤
│ 凡例: ○=可能 -=不可 金額は承認上限額                      │
├─────────────────────────────────────────────────────────────┤
│ [エクスポート] [印刷] [権限一括変更] [更新] [閉じる]          │
└─────────────────────────────────────────────────────────────┘
```

### 5. 承認処理画面（承認者向け）

```
┌─────────────────────────────────────────────────────────────┐
│ 承認処理：見積承認依頼 #EST-2024-001                         │
├─────────────────────────────────────────────────────────────┤
│ 【申請内容】                                               │
│ 申請者:     田中 太郎 (営業部・営業課)                       │
│ 申請日時:   2024/01/15 10:30                              │
│ 件名:       ABC商事向け新システム構築見積                    │
│ 見積金額:   ¥15,000,000 (税込)                            │
│ 有効期限:   2024/02/15                                    │
│ 優先度:     高                                            │
├─────────────────────────────────────────────────────────────┤
│ 【承認フロー進捗】                                         │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ Step 1: 課長承認    [完了✓] 佐藤課長 2024/01/15 14:20   │ │
│ │ Step 2: 部長承認 ►  [待機中] 鈴木部長 (あなた)          │ │
│ │ Step 3: 役員承認    [待機  ] 中村常務                  │ │
│ └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│ 【承認権限確認】                                           │
│ あなたの権限: [部長承認権限] 金額上限: [5000万円]            │
│ 期限:        2024/01/17 14:20 (残り 28時間)              │
│ 委譲可能:    はい (同格以下に委譲可)                        │
├─────────────────────────────────────────────────────────────┤
│ 【添付資料】                                               │
│ 📄 見積書_ABC商事_20240115.pdf  📊 原価計算書.xlsx         │
│ 📋 プロジェクト計画書.docx      📈 売上予測.xlsx           │
├─────────────────────────────────────────────────────────────┤
│ 【承認処理】                                               │
│ ○ 承認する   ○ 却下する   ○ 差戻す   ○ 委譲する           │
│                                                           │
│ コメント (必須):                                           │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 見積内容を確認し、技術的実現性と収益性の観点から        │ │
│ │ 問題ないと判断します。ABC商事との継続的な関係構築       │ │
│ │ の観点からも重要な案件と考えます。                      │ │
│ │                                                       │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                           │
│ 委譲先 (委譲する場合): [選択してください ▼]                │
│ 緊急フラグ: [□] 緊急案件として次ステップの期限を短縮        │
├─────────────────────────────────────────────────────────────┤
│ [承認実行] [却下実行] [差戻実行] [委譲実行] [下書き保存]      │
└─────────────────────────────────────────────────────────────┘
```

## 🛠️ 実装上の技術仕様

### 1. 権限データ構造

```php
// 詳細権限テーブル設計
CREATE TABLE approval_detailed_permissions (
    id BIGINT PRIMARY KEY,
    user_id BIGINT,
    permission_type ENUM('request', 'approve', 'reject', 'return', 'delegate', 'configure'),
    target_type ENUM('estimate', 'budget', 'order', 'progress', 'payment'),
    conditions JSON, -- 金額上限、部署制限、時間制限等
    restrictions JSON, -- 実行条件、必須項目等
    scope JSON, -- 適用範囲設定
    is_active BOOLEAN DEFAULT TRUE,
    valid_from DATETIME,
    valid_until DATETIME,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);

// 権限設定例
{
    "permission_type": "approve",
    "conditions": {
        "max_amount": 10000000,
        "departments": ["sales", "technical"],
        "time_limit_hours": 48
    },
    "restrictions": {
        "require_comment": true,
        "require_attachments": false,
        "allow_delegate": true,
        "delegate_scope": ["same_level", "subordinates"]
    },
    "scope": {
        "own_department_only": false,
        "assigned_projects_only": true,
        "emergency_override": false
    }
}
```

### 2. フロー実行時の権限チェック

```php
// 承認権限チェックの実装例
class ApprovalPermissionChecker
{
    public function canApprove(User $user, ApprovalRequest $request): array
    {
        $result = [
            'can_approve' => false,
            'reasons' => [],
            'restrictions' => []
        ];
        
        // 基本権限チェック
        if (!$user->hasPermission('approval.action.approve')) {
            $result['reasons'][] = '承認権限がありません';
            return $result;
        }
        
        // 金額制限チェック
        $maxAmount = $this->getMaxApprovalAmount($user, $request->request_type);
        if ($request->getRequestAmount() > $maxAmount) {
            $result['reasons'][] = "承認可能金額({$maxAmount}円)を超過しています";
            return $result;
        }
        
        // 部署制限チェック
        if (!$this->isDepartmentAccessible($user, $request)) {
            $result['reasons'][] = '部署制限により承認できません';
            return $result;
        }
        
        // 期限チェック
        if ($this->isTimeoutExpired($request)) {
            $result['reasons'][] = '承認期限が過ぎています';
            return $result;
        }
        
        // 承認可能
        $result['can_approve'] = true;
        $result['restrictions'] = $this->getApprovalRestrictions($user, $request);
        
        return $result;
    }
    
    private function getApprovalRestrictions(User $user, ApprovalRequest $request): array
    {
        return [
            'require_comment' => $this->isCommentRequired($user, $request),
            'allow_delegate' => $this->canDelegate($user, $request),
            'time_limit' => $this->getTimeLimit($user, $request),
            'approval_conditions' => $this->getApprovalConditions($user, $request)
        ];
    }
}
```

### 3. 動的フロー制御

```php
// 承認フローの動的制御
class DynamicApprovalFlow
{
    public function executeStep(ApprovalRequest $request, string $action, User $user, array $params = []): bool
    {
        // アクション別処理
        switch ($action) {
            case 'approve':
                return $this->processApproval($request, $user, $params);
            case 'reject':
                return $this->processRejection($request, $user, $params);
            case 'return':
                return $this->processReturn($request, $user, $params);
            case 'delegate':
                return $this->processDelegate($request, $user, $params);
        }
        
        return false;
    }
    
    private function processApproval(ApprovalRequest $request, User $user, array $params): bool
    {
        // 権限チェック
        $permissionCheck = app(ApprovalPermissionChecker::class)->canApprove($user, $request);
        if (!$permissionCheck['can_approve']) {
            throw new ApprovalException(implode(', ', $permissionCheck['reasons']));
        }
        
        // 承認実行
        $request->approve($user, $params['comment'] ?? null);
        
        // 次ステップ判定
        if ($this->hasNextStep($request)) {
            $this->moveToNextStep($request);
            $this->notifyNextApprovers($request);
        } else {
            $this->completeApprovalProcess($request);
        }
        
        return true;
    }
}
```

## 📊 実装工数・スケジュール

### Phase 1: 詳細権限システム（2週間）
- [ ] 詳細権限テーブル設計・実装
- [ ] 権限チェッカークラス実装
- [ ] GraphQL API拡張

### Phase 2: フロー管理機能（2週間）
- [ ] フロー設計画面実装
- [ ] ステップ詳細設定機能
- [ ] 動的フロー制御システム

### Phase 3: 承認処理UI（2週間）
- [ ] 承認処理画面実装
- [ ] 権限マトリックス画面
- [ ] 通知・アラート機能

### Phase 4: テスト・調整（1週間）
- [ ] 統合テスト
- [ ] ユーザビリティ調整
- [ ] パフォーマンス最適化

## 🎯 期待される効果

### 1. 精密な権限管理
- **きめ細かい制御**: 申請・承認・却下・差戻の個別権限設定
- **条件ベース制限**: 金額・部署・期限による動的制限
- **例外処理対応**: 緊急案件・代理承認等の柔軟な対応

### 2. 業務効率化
- **自動権限判定**: システムによる承認可否の自動判断
- **視覚的管理**: 権限マトリックスによる一覧性
- **処理ガイド**: 承認者への明確な処理指示

### 3. ガバナンス強化
- **統制の徹底**: システムによる権限統制の自動化
- **監査対応**: 完全な権限行使履歴の記録
- **コンプライアンス**: 組織ルールの確実な実行

## 📝 まとめ

承認機能の詳細な権限設定は、現在の実装基盤を活用して**エンタープライズレベルの精密な制御**が実現可能です。

### ✅ 実現可能な機能
- **詳細権限分類**: 申請・承認・却下・差戻・委譲の個別設定
- **動的制限**: 金額・部署・期限による条件ベース制御
- **視覚的管理**: 権限マトリックス・フロー図による直感的操作
- **例外処理**: 緊急案件・代理承認等の柔軟な対応

### 🚀 開発効率
- **実装期間**: 6-7週間で完全機能実装
- **既存活用**: 承認フロー基盤の最大活用
- **段階実装**: 段階的な機能追加による早期価値提供

組織の複雑な承認要件に対応する、高度で使いやすい権限管理システムを効率的に構築できます。
