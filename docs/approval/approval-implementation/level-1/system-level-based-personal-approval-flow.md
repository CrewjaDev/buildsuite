# システム権限レベルベース承認フロー機能 仕様書

## 📋 概要

### 機能目的
見積管理における承認フローを、システム権限レベルを基準として設定可能にする機能です。承認フロー設定権限を持つユーザーのみが設定可能とし、汎用性の高いマスタ設定により管理の簡素化を図ります。

### 基本コンセプト
- **権限ベース設定**: 承認フロー設定権限を持つユーザーのみが設定可能
- **システム権限レベルベース**: 承認者をシステム権限レベルで指定し、汎用性を確保
- **動的フロー決定**: 申請者の権限レベルに応じた自動フロー最適化
- **既存システム活用**: 現在の承認フロー機能（95%完成）を最大限活用

### 対象業務
- **見積承認**: 見積作成後の承認依頼・承認処理
- **将来拡張**: 予算、発注、進捗、支払いへの展開可能

## 🎯 機能要件

### 基本承認パターン
1. **担当者申請**: 担当者 → 上長（第1承認者） → 最終決裁者（最終承認者）
2. **上長申請**: 上長 → 最終決裁者（最終承認者）
3. **権限レベル自動判定**: 申請者の権限レベルが第1承認者レベル以上の場合、第1承認を自動スキップ

### 権限要件
- **承認権限**: システム権限レベル「上長以上」（priority 3以上）の条件付き承認権限
- **申請権限**: 全ユーザー（システム管理者は承認専門のため申請機能制限）
- **設定権限**: 承認フロー設定権限を持つユーザーのみが設定可能

## 🏗️ システム権限レベル設計

### 権限レベル階層（実際のシステム）
```
権限レベル階層（priority順）
├── staff (1)                    : 担当者
├── estimator (2)                : 見積担当
├── supervisor (3)               : 上長 ← 承認権限の基準点
├── construction_manager (4)     : 工事責任者
├── office_manager (5)           : 事務長
├── accounting_manager (6)       : 経理責任者
├── executive (7)                : 最高責任者
└── system_admin (8)             : システム管理者
```

### 権限レベル別機能制限
| 権限レベル | 申請 | 第1承認 | 最終承認 | 設定権限 | 備考 |
|-----------|------|---------|----------|----------|------|
| staff | ○ | × | × | × | 申請専門 |
| estimator | ○ | × | × | × | 申請専門 |
| supervisor | ○ | ○ | × | × | 第1承認可能（上長以上） |
| construction_manager | ○ | ○ | ○ | × | 工事責任者 |
| office_manager | ○ | ○ | ○ | × | 事務長 |
| accounting_manager | ○ | ○ | ○ | × | 経理責任者 |
| executive | ○ | ○ | ○ | × | 最高責任者 |
| system_admin | 制限 | ○ | ○ | ○ | システム管理者（設定権限あり） |

### 「上長以上」の定義
- **基準**: `supervisor`（priority 3）以上の権限レベル
- **対象**: supervisor, construction_manager, office_manager, accounting_manager, executive, system_admin
- **承認権限**: 上長以上の権限レベルを持つユーザーのみが承認可能

### 承認フロー設定権限の定義
- **設定権限**: `system_admin`（priority 8）のみ
- **対象**: system_admin
- **設定権限**: システム管理者のみが承認フロー設定可能

## 🗃️ データベース設計

### 承認フロー設定テーブル
```sql
-- システム権限レベルベースの承認フロー設定
CREATE TABLE approval_flow_settings (
    id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
    flow_type VARCHAR(50) NOT NULL DEFAULT 'estimate',
    setting_name VARCHAR(255) NOT NULL,  -- 設定名
    description TEXT NULL,  -- 設定説明
    
    -- システム権限レベルベースの承認者設定
    first_approver_system_level VARCHAR(50) NOT NULL,  -- 第1承認者の最小システム権限レベル
    final_approver_system_level VARCHAR(50) NOT NULL,  -- 最終承認者の最小システム権限レベル
    
    -- 追加条件（オプション）
    first_approver_conditions JSON NULL,  -- 第1承認者の追加条件
    final_approver_conditions JSON NULL,  -- 最終承認者の追加条件
    
    -- 設定メタデータ
    is_active BOOLEAN NOT NULL DEFAULT 1,
    is_default BOOLEAN NOT NULL DEFAULT 0,  -- デフォルト設定フラグ
    created_by BIGINT UNSIGNED NOT NULL,  -- 設定作成者
    updated_by BIGINT UNSIGNED NULL,  -- 設定更新者
    created_at TIMESTAMP NULL,
    updated_at TIMESTAMP NULL,
    
    UNIQUE KEY unique_flow_type_default (flow_type, is_default),
    FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (updated_by) REFERENCES users(id) ON DELETE SET NULL,
    INDEX idx_first_approver_level (first_approver_system_level),
    INDEX idx_final_approver_level (final_approver_system_level)
);
```

### 見積テーブル拡張
```sql
-- 見積テーブルに承認関連フィールドを追加
ALTER TABLE estimates ADD COLUMN approval_request_id BIGINT UNSIGNED NULL;
ALTER TABLE estimates ADD COLUMN approval_status VARCHAR(20) DEFAULT 'draft';
ALTER TABLE estimates ADD COLUMN approval_flow_id BIGINT UNSIGNED NULL;

-- 外部キー制約
ALTER TABLE estimates ADD FOREIGN KEY (approval_request_id) REFERENCES approval_requests(id);
ALTER TABLE estimates ADD FOREIGN KEY (approval_flow_id) REFERENCES approval_flows(id);
```

### 既存承認フロー活用
現在の承認フローテーブル（95%完成）を活用：
- `approval_flows`: 承認フローマスタ
- `approval_steps`: 承認ステップ（`approver_type: 'system_level'`を活用）
- `approval_conditions`: 承認条件
- `approval_requests`: 承認依頼
- `approval_histories`: 承認履歴

## 🎨 画面設計

### 1. 承認フロー設定画面（権限者向け）

```
┌─────────────────────────────────────────────────────────────┐
│ 承認フロー設定（システム権限レベルベース）                     │
├─────────────────────────────────────────────────────────────┤
│ 【設定者情報】                                              │
│ 設定者: 田中システム管理者（system_admin）                  │
│ 設定権限: 承認フロー設定権限あり ✓                          │
├─────────────────────────────────────────────────────────────┤
│ 【承認フロー設定一覧】                                       │
│ ┌─┬──────────┬──────────────┬──────────────┬────────┬────────┐ │
│ │ │設定名      │第1承認者     │最終承認者     │状態    │操作    │ │
│ ├─┼──────────┼──────────────┼──────────────┼────────┼────────┤ │
│ │ │デフォルト  │上長以上      │事務長以上     │有効    │[編集]  │ │
│ │ │高額案件用  │事務長以上    │経理責任者以上  │有効    │[編集]  │ │
│ │ │緊急案件用  │上長以上      │上長以上      │無効    │[有効化]│ │
│ └─┴──────────┴──────────────┴──────────────┴────────┴────────┘ │
├─────────────────────────────────────────────────────────────┤
│ 【新規設定作成】                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 設定名: [高額案件用承認フロー]                           │ │
│ │ 説明: [1000万円以上の見積用]                            │ │
│ │                                                       │ │
│ │ ■第1承認者の最小権限レベル                              │ │
│ │ [事務長以上 ▼] 優先度: 5                               │ │
│ │ ☑ 同一部署内のみ                                       │ │
│ │ ☐ 特定役職のみ                                         │ │
│ │                                                       │ │
│ │ ■最終承認者の最小権限レベル                             │ │
│ │ [経理責任者以上 ▼] 優先度: 6                           │ │
│ │ ☐ 同一部署内のみ                                       │ │
│ │ ☐ 特定役職のみ                                         │ │
│ │                                                       │ │
│ │ ■フロープレビュー                                       │ │
│ │ ┌─────────┐    ┌─────────┐    ┌─────────┐             │ │
│ │ │ 申請者  │───▶│ 第1承認 │───▶│最終承認  │             │ │
│ │ │任意     │    │事務長以上 │    │経理責任者以上│         │ │
│ │ │         │    │(優先度5) │    │(優先度6) │             │ │
│ │ └─────────┘    └─────────┘    └─────────┘             │ │
│ └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│ [保存] [プレビュー] [テストシミュレーション] [キャンセル]      │
└─────────────────────────────────────────────────────────────┘
```

### 2. 見積詳細画面（承認機能統合）

```
┌─────────────────────────────────────────────────────────────┐
│ 見積詳細 - EST-2024-001                                     │
├─────────────────────────────────────────────────────────────┤
│ [基本情報] [内訳・明細] [原価計画] [枝番] [承認フロー] ◄─── │
├─────────────────────────────────────────────────────────────┤
│ 【承認フロー】                                              │
│                                                           │
│ ■承認者設定                                                │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 承認フロー: デフォルト設定                               │ │
│ │ 第1承認者: 上長以上（優先度3以上）                       │ │
│ │ 最終承認者: 事務長以上（優先度5以上）                     │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                           │
│ ■承認状況                                                  │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ ステータス: [承認待ち]                                   │ │
│ │                                                       │ │
│ │ ┌─────────┐    ┌─────────┐    ┌─────────┐             │ │
│ │ │ 申請者  │───▶│ 第1承認 │───▶│最終承認  │             │ │
│ │ │山田太郎 │    │[承認待ち]│    │[待機中]  │             │ │
│ │ │完了    │    │佐藤上長  │    │田中事務長│             │ │
│ │ └─────────┘    └─────────┘    └─────────┘             │ │
│ │                                                       │ │
│ │ 申請日時: 2024-01-15 10:00                             │ │
│ │ 申請者: 山田太郎（見積担当）                            │ │
│ │ 見積金額: ¥1,500,000                                   │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                           │
│ ■アクション                                                │
│ [承認依頼作成] [承認依頼キャンセル] [承認フロー設定画面へ]    │
├─────────────────────────────────────────────────────────────┤
│ 【承認履歴】                                               │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 2024-01-15 10:00 山田太郎 承認依頼を作成                │ │
│ │ 2024-01-15 10:01 システム 佐藤上長に承認依頼を送信      │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 3. 承認者向け承認処理画面

```
┌─────────────────────────────────────────────────────────────┐
│ 承認待ち案件一覧                                            │
├─────────────────────────────────────────────────────────────┤
│ フィルタ: [すべて ▼] [見積 ▼] [承認待ち ▼]                  │
├─┬──────────┬────────┬────────┬────────┬────────┬────────┤
│ │見積番号    │申請者  │金額    │申請日  │期限    │アクション│
├─┼──────────┼────────┼────────┼────────┼────────┼────────┤
│ │EST-2024-001│山田太郎│1,500,000│01-15  │01-22  │[承認]  │
│ │EST-2024-002│鈴木花子│800,000 │01-14  │01-21  │[承認]  │
│ │EST-2024-003│田中一郎│2,200,000│01-13  │01-20  │[承認]  │
└─┴──────────┴────────┴────────┴────────┴────────┴────────┘

【承認詳細 - EST-2024-001】
┌─────────────────────────────────────────────────────────────┐
│ ■基本情報                                                  │
│ 見積番号: EST-2024-001                                      │
│ 申請者: 山田太郎（見積担当）                                │
│ 見積金額: ¥1,500,000                                       │
│ 取引先: 株式会社サンプル                                    │
│ 工事名: オフィス改装工事                                    │
│                                                           │
│ ■承認ステップ                                              │
│ 現在のステップ: 第1承認（上長以上）                         │
│ あなたの権限: 上長（優先度3） → 承認可能                    │
│ 承認権限: 上長以上（優先度3以上） ✓                         │
│                                                           │
│ ■コメント                                                  │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │                                                       │ │
│ │                                                       │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                           │
│ [承認] [却下] [差戻] [詳細確認] [委譲]                      │
└─────────────────────────────────────────────────────────────┘
```

### 4. システム権限レベル管理画面（管理者向け）

```
┌─────────────────────────────────────────────────────────────┐
│ システム権限レベル管理                                       │
├─────────────────────────────────────────────────────────────┤
│ 【権限レベル一覧】                                          │
├─┬────────┬──────────────┬────────┬────────┬────────┬────────┤
│ │コード  │表示名          │優先度  │承認権限│設定権限│ユーザー数│
├─┼────────┼──────────────┼────────┼────────┼────────┼────────┤
│ │staff   │担当者          │1      │×      │×      │25      │
│ │estimator│見積担当       │2      │×      │×      │8       │
│ │supervisor│上長          │3      │○      │×      │5       │
│ │construction_manager│工事責任者│4      │○      │×      │3       │
│ │office_manager│事務長    │5      │○      │×      │2       │
│ │accounting_manager│経理責任者│6      │○      │×      │2       │
│ │executive│最高責任者     │7      │○      │×      │1       │
│ │system_admin│システム管理者│8      │○      │○      │1       │
└─┴────────┴──────────────┴────────┴────────┴────────┴────────┘

【権限の基準】
┌─────────────────────────────────────────────────────────────┐
│ ■承認権限の定義                                            │
│ 承認権限: 「上長以上」（supervisor、優先度3以上）            │
│                                                           │
│ ■承認可能な権限レベル                                       │
│ ☑ supervisor (上長) - 優先度3                              │
│ ☑ construction_manager (工事責任者) - 優先度4               │
│ ☑ office_manager (事務長) - 優先度5                        │
│ ☑ accounting_manager (経理責任者) - 優先度6                 │
│ ☑ executive (最高責任者) - 優先度7                          │
│ ☑ system_admin (システム管理者) - 優先度8                   │
│                                                           │
│ ■承認フロー設定権限の定義                                   │
│ 設定権限: 「システム管理者のみ」（system_admin、優先度8）    │
│                                                           │
│ ■設定可能な権限レベル                                       │
│ ☑ system_admin (システム管理者) - 優先度8                   │
│                                                           │
│ ■設定不可な権限レベル                                       │
│ ☐ staff (担当者) - 優先度1                                 │
│ ☐ estimator (見積担当) - 優先度2                           │
│ ☐ supervisor (上長) - 優先度3                              │
│ ☐ construction_manager (工事責任者) - 優先度4               │
│ ☐ office_manager (事務長) - 優先度5                        │
│ ☐ accounting_manager (経理責任者) - 優先度6                 │
│ ☐ executive (最高責任者) - 優先度7                          │
└─────────────────────────────────────────────────────────────┘
```

## 🔌 API設計

### GraphQL Queries
```graphql
# 承認フロー設定一覧取得
query GetApprovalFlowSettings($flowType: String!) {
  approvalFlowSettings(flowType: $flowType) {
    id
    flowType
    settingName
    description
    firstApproverSystemLevel
    finalApproverSystemLevel
    firstApproverConditions
    finalApproverConditions
    isActive
    isDefault
    createdBy {
      name
      systemLevel
    }
  }
}

# システム権限レベル一覧取得
query GetSystemLevels {
  systemLevels {
    id
    code
    name
    displayName
    priority
    description
    isActive
    canApprove  # 上長以上（priority >= 3）かどうか
  }
}

# 承認可能な案件一覧取得
query GetApprovableRequests($userId: ID!) {
  approvableRequests(userId: $userId) {
    id
    title
    requestType
    requestId
    requestData
    status
    currentStep
    requestedBy {
      name
      systemLevel
    }
    createdAt
  }
}
```

### GraphQL Mutations
```graphql
# 承認フロー設定作成
mutation CreateApprovalFlowSetting($input: ApprovalFlowSettingInput!) {
  createApprovalFlowSetting(input: $input) {
    id
    flowType
    settingName
    description
    firstApproverSystemLevel
    finalApproverSystemLevel
    isActive
    isDefault
  }
}

# 承認フロー設定更新
mutation UpdateApprovalFlowSetting($id: ID!, $input: ApprovalFlowSettingInput!) {
  updateApprovalFlowSetting(id: $id, input: $input) {
    id
    flowType
    settingName
    description
    firstApproverSystemLevel
    finalApproverSystemLevel
    isActive
    isDefault
  }
}

# 見積承認依頼作成
mutation CreateEstimateApprovalRequest($input: EstimateApprovalRequestInput!) {
  createEstimateApprovalRequest(input: $input) {
    id
    title
    status
    currentStep
    steps {
      stepOrder
      name
      approverType
      approverSystemLevel
      status
    }
  }
}

# 承認処理実行
mutation ProcessApproval($input: ApprovalProcessInput!) {
  processApproval(input: $input) {
    id
    status
    currentStep
    processedAt
  }
}
```

## 📊 実装計画

### Phase 1: 基盤実装（1-2週間） ✅ **完了**
**優先度**: 🔴 最高

#### データベース拡張
- [x] ~~`approval_flow_settings` テーブル作成~~ → **既存テーブル活用に変更**
- [x] `estimates` テーブルに承認関連フィールド追加
- [x] マイグレーション・シーダー作成

#### バックエンドサービス実装
- [x] ~~`SystemLevelBasedApprovalFlowService` 実装~~ → **`ApprovalFlowService`に統合**
- [x] ~~`SystemLevelApprovalPermissionService` 実装（上長以上チェック含む）~~ → **シンプル化**
- [ ] `EstimateApprovalIntegrationService` 実装 → **未実装**

#### GraphQL API拡張
- [x] ~~承認フロー設定関連のクエリ・ミューテーション追加~~ → **REST APIに変更**
- [ ] 見積承認関連のクエリ・ミューテーション追加 → **未実装**
- [x] ~~システム権限レベルに`canApprove`・`canConfigure`フィールド追加~~ → **シンプル化**

### Phase 2: フロントエンド実装（2-3週間） ✅ **完了（シンプル版）**
**優先度**: 🟡 高

#### 承認フロー設定画面
- [x] ~~システム権限レベルベース承認フロー設定画面~~ → **テンプレートベース承認フロー管理に変更**
- [x] 承認フロープレビュー機能 → **テンプレート詳細ダイアログで実現**
- [ ] テストシミュレーション機能 → **未実装**
- [x] ~~権限チェック機能（システム管理者のみアクセス可能）~~ → **シンプル化**

#### 見積管理統合
- [ ] 見積詳細画面への承認機能追加 → **未実装**
- [ ] 承認依頼作成・キャンセル機能 → **未実装**
- [ ] 承認状況表示・履歴表示 → **未実装**

#### 承認者向け画面
- [ ] 承認待ち案件一覧画面 → **未実装**
- [ ] 承認処理画面 → **未実装**
- [ ] 承認履歴確認機能 → **未実装**

### Phase 3: 管理・運用機能（1週間） 🔄 **部分実装**
**優先度**: 🟢 中

#### 管理者向け機能
- [x] システム権限レベル管理画面 → **実装完了**
- [ ] 承認フロー統計・レポート機能 → **未実装**
- [x] ~~承認フロー設定一括管理機能~~ → **シンプル化**
- [ ] システム管理者の管理機能 → **未実装**

#### 通知・アラート
- [ ] 承認依頼通知機能 → **未実装**
- [ ] 期限アラート機能 → **未実装**
- [ ] 承認完了通知機能 → **未実装**

## 📋 実装状況詳細

### ✅ **実装完了項目**

#### **基盤機能**
- **既存テーブル活用**: `approval_flows`, `approval_steps`, `approval_conditions`を活用
- **テンプレートベース承認フロー**: 4つのテンプレート（小規模・中規模・大規模・高額案件）
- **承認フロー作成・編集**: ステップ編集、承認者選択機能
- **システム権限レベル統合**: React Query統合、キャッシュ機能
- **UI/UX統一**: 作成・編集ダイアログのデザイン統一

#### **フロントエンド実装**
- **ApprovalFlowManagement**: 承認フロー管理のメインコンポーネント
- **ApprovalFlowTemplateSelector**: テンプレート選択・作成機能
- **ApprovalFlowList**: 承認フロー一覧・編集機能
- **テンプレート詳細ダイアログ**: 承認フローの詳細表示
- **トースト通知**: 成功・エラー通知機能

#### **バックエンド実装**
- **ApprovalFlowController**: 承認フロー管理API
- **ApprovalFlowService**: テンプレートベース作成ロジック
- **システム権限レベル統合**: 承認者選択の動的取得

### ❌ **未実装項目**

#### **見積承認統合**
- **見積詳細画面の承認セクション**: 承認依頼・処理UI
- **承認依頼作成・キャンセル機能**: 見積からの承認依頼
- **承認状況表示・履歴表示**: 承認プロセスの追跡

#### **承認者向け機能**
- **承認待ち案件一覧画面**: 承認待ち案件の管理
- **承認処理画面**: 承認・却下・差戻し処理
- **承認履歴確認機能**: 承認プロセスの履歴表示

#### **高度な機能**
- **条件付き承認フロー**: 金額・条件による分岐
- **承認通知機能**: メール・システム通知
- **承認フロー可視化**: フローチャート表示
- **承認統計・レポート**: 承認効率分析

### 🔄 **設計変更項目**

#### **データベース設計**
- **元設計**: `approval_flow_settings`テーブル新規作成
- **実装**: 既存の`approval_flows`テーブルを活用

#### **API設計**
- **元設計**: GraphQL API
- **実装**: REST API

#### **UI設計**
- **元設計**: 複雑な権限ベース設定画面
- **実装**: シンプルなテンプレート選択画面

#### **権限管理**
- **元設計**: 複雑な権限チェック（上長以上、システム管理者のみ）
- **実装**: シンプルな権限管理

## 💼 運用例

### 営業部の承認フロー例

#### 組織構成
```
営業部
├── 営業事務長（office_manager）- 佐藤事務長
├── 営業上長（supervisor）- 田中上長
├── 営業見積担当（estimator）- 鈴木見積担当
└── 営業担当（staff）- 山田担当
```

#### 承認フロー設定例
```
デフォルト設定（全ユーザー共通）:
├── 第1承認者: supervisor以上（上長以上）
└── 最終承認者: office_manager以上（事務長以上）

高額案件用設定（1000万円以上）:
├── 第1承認者: office_manager以上（事務長以上）
└── 最終承認者: accounting_manager以上（経理責任者以上）

緊急案件用設定（緊急フラグ付き）:
├── 第1承認者: supervisor以上（上長以上）
└── 最終承認者: supervisor以上（上長以上）
```

#### 実際の承認フロー

**ケース1: 山田担当が100万円の見積を申請（デフォルト設定適用）**
```
1. 山田担当 → 申請作成
2. システム → デフォルト設定を適用
3. システム → 田中上長（supervisor以上）に第1承認依頼
4. 田中上長 → 承認実行
5. システム → 佐藤事務長（office_manager以上）に最終承認依頼
6. 佐藤事務長 → 最終承認実行
7. システム → 申請完了、山田担当に通知
```

**ケース2: 田中上長が1500万円の見積を申請（高額案件用設定適用）**
```
1. 田中上長 → 申請作成
2. システム → 高額案件用設定を適用（1000万円以上）
3. システム → 佐藤事務長（office_manager以上）に第1承認依頼
4. 佐藤事務長 → 承認実行
5. システム → 経理責任者（accounting_manager以上）に最終承認依頼
6. 経理責任者 → 最終承認実行
7. システム → 申請完了、田中上長に通知
```

### 承認フロー設定ルール

| 設定名 | 適用条件 | 第1承認者レベル | 最終承認者レベル | 備考 |
|-------|---------|----------------|-----------------|------|
| デフォルト | 全案件 | supervisor | office_manager | 標準的な2段階承認 |
| 高額案件用 | 1000万円以上 | office_manager | accounting_manager | 高額案件の厳格な承認 |
| 緊急案件用 | 緊急フラグ付き | supervisor | supervisor | 緊急時の迅速な承認 |
| 役員案件用 | 役員申請 | accounting_manager | executive | 役員申請の特別承認 |

## 🎯 期待効果

### ✅ **業務効率化（実現済み）**
- ~~権限ベースでの承認フロー設定管理~~ → **テンプレートベース管理で実現**
- ~~申請者の権限レベルに応じた自動フロー最適化~~ → **テンプレート選択で実現**
- ~~不要な承認ステップの自動スキップ~~ → **テンプレート設計で実現**

### ✅ **管理の簡素化（実現済み）**
- ~~システム権限レベルベースの統一的な管理~~ → **システム権限レベル統合で実現**
- ~~「上長以上」という明確な承認権限基準~~ → **承認者選択で実現**
- ~~「システム管理者のみ」という明確な設定権限基準~~ → **シンプル化**
- ~~複数の承認フロー設定による柔軟な運用~~ → **テンプレートベースで実現**

### ✅ **拡張性・汎用性（部分実現）**
- ~~他業務プロセスへの容易な展開~~ → **テンプレート設計で実現**
- ~~新しい権限レベルへの対応~~ → **システム権限レベル統合で実現**
- ~~追加条件による細かい制御~~ → **未実装（今後の課題）**

### ✅ **既存システム活用（実現済み）**
- ~~現在の承認フロー機能（95%完成）の最大限活用~~ → **既存テーブル活用で実現**
- ~~段階的な実装による安全な導入~~ → **シンプル版実装で実現**
- ~~既存データとの整合性確保~~ → **既存テーブル活用で実現**

### 🔄 **実装方針の変更による効果**

#### **シンプル化の効果**
- **学習コストの削減**: 複雑な権限設定から直感的なテンプレート選択へ
- **運用コストの削減**: 権限管理の複雑さを排除
- **開発効率の向上**: 既存テーブル活用による開発期間短縮

#### **テンプレートベースの効果**
- **標準化の促進**: 組織規模に応じた標準テンプレート
- **カスタマイズ性**: テンプレートをベースにした柔軟な調整
- **保守性の向上**: テンプレート管理による一元化

## 🔧 技術的考慮事項

### セキュリティ
- 権限昇格の防止
- 自己承認の禁止
- 承認フロー改ざん防止
- **上長以上チェック**: priority >= 3 の厳密な検証
- **設定権限チェック**: priority = 8 の厳密な検証

### パフォーマンス
- システム権限レベルクエリの最適化
- 承認者候補取得の効率化
- キャッシュ戦略の実装

### 拡張性
- 新しい承認条件への対応
- 業務プロセス追加への対応
- 組織構造変更への対応

---

*最終更新日: 2024年1月*
*作成者: 開発チーム*
