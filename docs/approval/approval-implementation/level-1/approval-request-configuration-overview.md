# 承認依頼設定機能 全体概要

## 📋 概要

承認依頼の設定機能は、承認フローと承認依頼（タイプ・テンプレート）の管理を行うシステムです。添付の構想図に基づいて、現在の実装状況と今後の展開について整理します。

## 🏗️ システム構成

### 1. 承認フロー管理 ✅ (実装済み)

#### 機能概要
- **目的**: 承認プロセスの流れを定義・管理
- **対象**: 見積、予算、発注などの業務承認フロー
- **権限**: システム管理者のみが設定可能

#### 実装済み機能
- 承認フローの作成・編集・削除
- 承認ステップの設定（承認者、条件、期限）
- テンプレートからの承認フロー作成
- システム権限レベルベースの承認者指定

#### データ構造
```sql
-- 承認フロー
approval_flows
├── id
├── name (承認フロー名)
├── description (説明)
├── flow_type (フロータイプ: estimate, budget, order等)
├── is_active (有効/無効)
├── is_system (システムフロー)
├── priority (優先度)
└── created_by, updated_by

-- 承認ステップ
approval_steps
├── id
├── approval_flow_id (承認フローID)
├── step_order (ステップ順序)
├── name (ステップ名)
├── approver_type (承認者タイプ: user, system_level, department)
├── approver_id (承認者ID)
├── is_required (必須承認)
├── can_delegate (委譲可能)
└── timeout_hours (期限時間)
```

### 2. 承認依頼タイプ管理 ✅ (実装済み)

#### 機能概要
- **目的**: 承認依頼の種類を定義・管理
- **対象**: 見積承認、予算承認、発注承認などのタイプ
- **権限**: システム管理者のみが設定可能

#### 実装済み機能
- 承認依頼タイプの作成・編集・削除
- アイコン・色・デフォルト承認フローの設定
- 並び順・有効/無効の管理

#### データ構造
```sql
-- 承認依頼タイプ
approval_request_types
├── id
├── code (タイプコード: estimate, budget, order等)
├── name (タイプ名: 見積承認、予算承認等)
├── description (説明)
├── icon (アイコン: FileText, DollarSign等)
├── color (色: blue, green, orange等)
├── default_approval_flow_id (デフォルト承認フローID)
├── is_active (有効/無効)
├── sort_order (並び順)
└── created_by, updated_by
```

#### 具体例（添付構想図より）
```
見積承認タイプ
├── コード: "estimate"
├── 名前: "見積承認"
├── 説明: "見積書の承認依頼"
├── アイコン: "FileText"
├── 色: "blue"
├── デフォルト承認フロー: "見積標準フロー (2段階承認)"
└── 並び順: 1

予算承認タイプ
├── コード: "budget"
├── 名前: "予算承認"
├── 説明: "予算申請の承認依頼"
├── アイコン: "DollarSign"
├── 色: "green"
├── デフォルト承認フロー: "予算承認フロー (3段階承認)"
└── 並び順: 2

発注承認タイプ
├── コード: "order"
├── 名前: "発注承認"
├── 説明: "発注書の承認依頼"
├── アイコン: "ShoppingCart"
├── 色: "orange"
├── デフォルト承認フロー: "発注承認フロー (2段階承認)"
└── 並び順: 3
```

### 3. 承認依頼テンプレート管理 ✅ (実装済み)

#### 機能概要
- **目的**: 承認依頼の具体的なテンプレートを定義・管理
- **対象**: 標準見積承認、緊急見積承認などのテンプレート
- **権限**: システム管理者のみが設定可能

#### 実装済み機能
- 承認依頼テンプレートの作成・編集・削除
- テンプレートデータ（JSON）の基本管理
- 使用回数の追跡

#### 現在のテンプレートデータ構造（実装済み）
```json
// 現在の実装例（シーダーより）
{
  "title": "見積承認依頼",
  "fields": {
    "project_name": "プロジェクト名",
    "amount": "金額",
    "deadline": "期限",
    "notes": "備考"
  }
}
```

#### 構想図で示された詳細構造（未実装）
```json
// 構想図の詳細構造
{
  "title_format": "見積承認依頼: {estimate_number}",
  "description_template": "以下の見積について承認をお願いします。",
  "required_fields": {
    "estimate_number": "見積番号",
    "client_name": "取引先名",
    "total_amount": "見積金額",
    "delivery_date": "納期"
  },
  "optional_fields": {
    "special_notes": "特記事項",
    "attachments": "添付ファイル"
  },
  "default_values": {
    "priority": "normal",
    "urgency": "standard"
  }
}
```

#### データ構造
```sql
-- 承認依頼テンプレート
approval_request_templates
├── id
├── name (テンプレート名)
├── description (説明)
├── request_type (依頼タイプコード)
├── template_data (テンプレートデータ: JSON)
├── is_active (有効/無効)
├── is_system (システムテンプレート)
├── usage_count (使用回数)
└── created_by, updated_by
```

#### 具体例（添付構想図より）

**標準見積承認依頼テンプレート**
```json
{
  "name": "標準見積承認依頼",
  "description": "一般的な見積承認依頼用テンプレート",
  "request_type": "estimate",
  "title_format": "見積承認依頼: {estimate_number}",
  "description_template": "以下の見積について承認をお願いします。",
  "required_fields": {
    "estimate_number": "見積番号",
    "client_name": "取引先名",
    "total_amount": "見積金額",
    "delivery_date": "納期"
  },
  "optional_fields": {
    "special_notes": "特記事項",
    "attachments": "添付ファイル"
  }
}
```

**緊急見積承認依頼テンプレート**
```json
{
  "name": "緊急見積承認依頼",
  "description": "緊急案件用の見積承認依頼テンプレート",
  "request_type": "estimate",
  "title_format": "【緊急】見積承認依頼: {estimate_number}",
  "description_template": "緊急案件のため、至急承認をお願いします。",
  "required_fields": {
    "estimate_number": "見積番号",
    "client_name": "取引先名",
    "total_amount": "見積金額",
    "urgency_reason": "緊急理由",
    "requested_deadline": "希望納期"
  },
  "default_values": {
    "priority": "high",
    "urgency": "urgent"
  }
}
```

## 🔄 承認フローと承認依頼の関係

### 1. 承認フロー → 承認依頼タイプ
- 承認依頼タイプは、デフォルト承認フローを指定可能
- 複数の承認依頼タイプが同じ承認フローを使用可能
- 承認フローは承認依頼タイプから独立して管理

### 2. 承認依頼タイプ → 承認依頼テンプレート
- 承認依頼テンプレートは、承認依頼タイプに紐づく
- 1つの承認依頼タイプに対して複数のテンプレートが存在可能
- テンプレートは承認依頼タイプの具体的な実装例

### 3. 承認依頼テンプレート → 承認フロー
- テンプレート内で承認フローを指定可能
- テンプレート固有の承認フロー設定が可能
- デフォルト値や条件をテンプレートで定義

## 📊 現在の実装状況

### ✅ 実装済み機能

#### 承認フロー管理
- [x] 承認フローのCRUD操作
- [x] 承認ステップの設定
- [x] テンプレートからの作成
- [x] システム権限レベルベースの承認者指定
- [x] フロー検証・テスト機能

#### 承認依頼タイプ管理
- [x] 承認依頼タイプのCRUD操作
- [x] アイコン・色・デフォルト承認フローの設定
- [x] 並び順・有効/無効の管理
- [x] 初期データのシーダー実装

#### 承認依頼テンプレート管理
- [x] 承認依頼テンプレートのCRUD操作
- [x] テンプレートデータ（JSON）の管理
- [x] 使用回数の追跡
- [x] 初期データのシーダー実装

### ❌ 未実装機能

#### 承認依頼ルール設定
- [ ] 自動承認条件の設定
- [ ] 承認者指定ルールの設定
- [ ] 委譲・代理設定
- [ ] 並列承認設定

#### 通知設定管理
- [ ] 承認依頼通知の設定
- [ ] リマインダー通知の設定
- [ ] 完了通知の設定
- [ ] エスカレーション通知の設定

#### 承認条件設定
- [ ] 金額別承認フローの設定
- [ ] 期限管理の設定
- [ ] 必須/任意設定
- [ ] コメント設定

#### テンプレートデータ詳細設定
- [ ] テンプレートデータのJSONエディタ実装
- [ ] 必須フィールド設定（required_fields）
- [ ] 任意フィールド設定（optional_fields）
- [ ] デフォルト値設定（default_values）
- [ ] タイトル形式設定（title_format）
- [ ] 説明テンプレート設定（description_template）

#### 添付ファイル機能
- [ ] ファイルアップロード機能
- [ ] ファイル管理機能
- [ ] ファイルプレビュー機能
- [ ] ファイル削除機能

#### 動的フォームビルダー
- [ ] フィールドタイプ設定（テキスト、数値、日付、選択肢等）
- [ ] バリデーション設定（必須、最小値、最大値等）
- [ ] 条件分岐設定（金額による承認フロー変更等）
- [ ] プレースホルダー機能（{estimate_number}等）

## 🎯 今後の実装計画

### Phase 1: テンプレートデータ詳細設定
1. **テンプレートデータのJSONエディタ実装**
   - 必須フィールド設定（required_fields）
   - 任意フィールド設定（optional_fields）
   - デフォルト値設定（default_values）
   - タイトル形式設定（title_format）
   - 説明テンプレート設定（description_template）

2. **動的フォームビルダーの実装**
   - フィールドタイプ設定（テキスト、数値、日付、選択肢等）
   - バリデーション設定（必須、最小値、最大値等）
   - 条件分岐設定（金額による承認フロー変更等）
   - プレースホルダー機能（{estimate_number}等）

### Phase 2: 添付ファイル機能
1. **ファイルアップロード機能**
   - ファイル選択・アップロード
   - ファイルプレビュー
   - ファイル管理

2. **ファイル管理機能**
   - ファイル削除
   - ファイル一覧表示
   - ファイルサイズ制限

### Phase 3: 承認依頼ルール設定
1. **自動承認条件の設定**
   - 金額上限による自動承認
   - 期限設定による自動処理
   - 条件分岐による承認フロー変更

2. **承認者指定ルールの設定**
   - 役職による承認者指定
   - 部署による承認者指定
   - グループによる承認者指定

3. **委譲・代理設定**
   - 委譲可能設定
   - 代理承認者設定
   - 委譲権限の範囲設定

### Phase 4: 通知設定管理
1. **通知チャネルの設定**
   - メール通知
   - システム内通知
   - Slack通知
   - SMS通知

2. **通知タイミングの設定**
   - 承認依頼時の通知
   - リマインダー通知
   - 期限超過通知
   - 完了通知

### Phase 5: 承認条件設定
1. **金額別承認フローの設定**
   - 金額上限による承認者変更
   - 複数金額帯の設定
   - 動的承認フロー選択

2. **期限管理の設定**
   - 承認期限の設定
   - 期限超過時の処理
   - エスカレーション設定

## 🔧 技術実装詳細

### フロントエンド実装
- **承認フロー管理**: `ApprovalFlowManagement.tsx`
- **承認依頼タイプ管理**: `ApprovalRequestTypeManagement.tsx`
- **承認依頼テンプレート管理**: `ApprovalRequestTypeManagement.tsx`内
- **権限設定**: `SystemLevelPermissionForm.tsx`

### バックエンド実装
- **承認フロー**: `ApprovalFlowController.php`, `ApprovalFlowService.php`
- **承認依頼タイプ**: `ApprovalRequestTypeController.php`
- **承認依頼テンプレート**: `ApprovalRequestTemplateController.php`
- **権限管理**: `SystemLevelController.php`

### データベース設計
- **承認フロー**: `approval_flows`, `approval_steps`, `approval_conditions`
- **承認依頼タイプ**: `approval_request_types`
- **承認依頼テンプレート**: `approval_request_templates`
- **権限管理**: `system_levels`, `system_level_permissions`

## 📝 まとめ

現在の実装状況は、承認フロー管理、承認依頼タイプ管理、承認依頼テンプレート管理の基本機能が完成しており、添付の構想図に示された機能の約60%が実装済みです。

### 現在の実装状況
- ✅ **承認フロー管理**: 完全実装済み
- ✅ **承認依頼タイプ管理**: 完全実装済み
- ✅ **承認依頼テンプレート管理**: 基本機能実装済み
- ❌ **テンプレートデータ詳細設定**: 未実装
- ❌ **添付ファイル機能**: 未実装
- ❌ **動的フォームビルダー**: 未実装

### 今後の実装優先順位
1. **Phase 1**: テンプレートデータ詳細設定（最優先）
2. **Phase 2**: 添付ファイル機能
3. **Phase 3**: 承認依頼ルール設定
4. **Phase 4**: 通知設定管理
5. **Phase 5**: 承認条件設定

### 構想図との対応状況
添付の構想図に示された「登録画面での入力項目」の詳細な仕様について：

- **承認依頼タイプ登録画面**: 基本項目は実装済み、詳細設定項目は未実装
- **承認依頼テンプレート登録画面**: 基本項目は実装済み、テンプレート設定項目は未実装
- **添付ファイル機能**: 構想図に示された「添付ファイル」項目は未実装
- **動的フィールド設定**: 構想図に示された「必須フィールド」「任意フィールド」「デフォルト値」は未実装

特に、添付の構想図に示された「標準見積承認依頼テンプレート」と「緊急見積承認依頼テンプレート」の詳細な設定項目を実装することで、より実用的な承認依頼システムが実現できます。
