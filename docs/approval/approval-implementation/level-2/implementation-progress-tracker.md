# 新承認フロー実装進捗管理

## 📋 実装タスク一覧

### **Phase 1: データベース設計・バックエンド基盤** (3-4日)

#### 1. approval_flowsテーブルの拡張（JSONカラム追加）
- **ステータス**: ⏳ 未着手
- **担当**: バックエンド
- **予想工数**: 0.5日
- **詳細**:
  - `requesters` JSONカラム追加
  - `approval_steps` JSONカラム追加
  - `flow_type`, `conditions`, `priority` カラム追加
  - GINインデックスの追加
- **実装ファイル**:
  - `backend/database/migrations/xxxx_add_json_columns_to_approval_flows_table.php`
- **完了条件**:
  - [ ] マイグレーションファイル作成
  - [ ] マイグレーション実行
  - [ ] インデックス作成
  - [ ] 動作確認

#### 2. ApprovalFlowモデルの更新（JSONカラム対応、権限チェックメソッド追加）
- **ステータス**: ⏳ 未着手
- **担当**: バックエンド
- **予想工数**: 1日
- **詳細**:
  - JSONカラムのキャスト設定
  - `canCreateApprovalRequest()` メソッド実装
  - `canApprove()` メソッド実装
  - `isStepCompleted()` メソッド実装
- **実装ファイル**:
  - `backend/app/Models/ApprovalFlow.php`
- **完了条件**:
  - [ ] JSONカラムのキャスト設定
  - [ ] 承認依頼者権限チェックメソッド実装
  - [ ] 承認者権限チェックメソッド実装
  - [ ] 承認条件判定メソッド実装
  - [ ] 単体テスト作成

#### 3. ApprovalConditionEvaluatorクラスの実装（条件分岐判定ロジック）
- **ステータス**: ⏳ 未着手
- **担当**: バックエンド
- **予想工数**: 1.5日
- **詳細**:
  - 金額条件の判定
  - 業者タイプ条件の判定
  - プロジェクトタイプ条件の判定
  - 部署条件の判定
  - カスタム条件の判定
- **実装ファイル**:
  - `backend/app/Services/Approval/ApprovalConditionEvaluator.php`
- **完了条件**:
  - [ ] 基本条件判定メソッド実装
  - [ ] 金額条件判定実装
  - [ ] 業者タイプ条件判定実装
  - [ ] プロジェクトタイプ条件判定実装
  - [ ] 部署条件判定実装
  - [ ] カスタム条件判定実装
  - [ ] 単体テスト作成

#### 4. ApprovalFlowServiceクラスの実装（動的フロー選択、ステップ決定）
- **ステータス**: ⏳ 未着手
- **担当**: バックエンド
- **予想工数**: 1.5日
- **詳細**:
  - `selectApprovalFlow()` メソッド
  - `determineApprovalSteps()` メソッド
  - 適用条件のマッチングロジック
- **実装ファイル**:
  - `backend/app/Services/Approval/ApprovalFlowService.php`
- **完了条件**:
  - [ ] 承認フロー選択ロジック実装
  - [ ] 承認ステップ決定ロジック実装
  - [ ] 適用条件マッチング実装
  - [ ] 依存関係の注入設定
  - [ ] 単体テスト作成

### **Phase 2: API実装** (2-3日)

#### 5. ApprovalFlowControllerの更新（CRUD、利用可能フロー取得）
- **ステータス**: ⏳ 未着手
- **担当**: バックエンド
- **予想工数**: 1日
- **詳細**:
  - 承認フロー一覧取得
  - 承認フロー作成・更新・削除
  - 利用可能フロー取得
  - 部署・ユーザー一覧取得
- **実装ファイル**:
  - `backend/app/Http/Controllers/ApprovalFlowController.php`
- **完了条件**:
  - [ ] 一覧取得API実装
  - [ ] CRUD操作API実装
  - [ ] 利用可能フロー取得API実装
  - [ ] 部署・ユーザー一覧取得API実装
  - [ ] バリデーション実装
  - [ ] APIテスト作成

#### 6. ApprovalRequestControllerの更新（条件分岐対応の承認処理）
- **ステータス**: ⏳ 未着手
- **担当**: バックエンド
- **予想工数**: 1.5日
- **詳細**:
  - 承認依頼作成（動的フロー選択対応）
  - 承認処理（条件分岐対応）
  - 承認者通知機能
- **実装ファイル**:
  - `backend/app/Http/Controllers/ApprovalRequestController.php`
- **完了条件**:
  - [ ] 承認依頼作成API実装
  - [ ] 承認処理API実装
  - [ ] 却下・差し戻しAPI実装
  - [ ] 承認者通知機能実装
  - [ ] 条件分岐対応実装
  - [ ] APIテスト作成

#### 7. 承認フロー関連APIルートの追加・更新
- **ステータス**: ⏳ 未着手
- **担当**: バックエンド
- **予想工数**: 0.5日
- **詳細**:
  - 新しいエンドポイントの追加
  - 既存ルートの更新
  - ミドルウェアの適用
- **実装ファイル**:
  - `backend/routes/api.php`
- **完了条件**:
  - [ ] 新規APIルート追加
  - [ ] 既存ルート更新
  - [ ] ミドルウェア適用
  - [ ] ルートテスト作成

### **Phase 3: フロントエンド実装** (4-5日)

#### 8. ApprovalFlowForm.tsxの実装（承認フロー設定画面）
- **ステータス**: ⏳ 未着手
- **担当**: フロントエンド
- **予想工数**: 2日
- **詳細**:
  - 基本情報設定
  - 承認依頼者設定（部署・ユーザー選択）
  - 承認ステップ設定（最大5ステップ）
  - 承認条件設定
- **実装ファイル**:
  - `frontend/src/components/features/approvals/ApprovalFlowForm.tsx`
- **完了条件**:
  - [ ] 基本情報設定フォーム実装
  - [ ] 承認依頼者設定UI実装
  - [ ] 承認ステップ設定UI実装
  - [ ] 承認条件設定UI実装
  - [ ] バリデーション実装
  - [ ] レスポンシブ対応

#### 9. ApprovalRequestCreateDialog.tsxの実装（承認依頼作成画面）
- **ステータス**: ⏳ 未着手
- **担当**: フロントエンド
- **予想工数**: 1.5日
- **詳細**:
  - 利用可能フロー表示
  - 承認フロー情報表示
  - 承認依頼作成フォーム
- **実装ファイル**:
  - `frontend/src/components/features/approvals/ApprovalRequestCreateDialog.tsx`
- **完了条件**:
  - [ ] フロー選択UI実装
  - [ ] フロー情報表示実装
  - [ ] 依頼作成フォーム実装
  - [ ] バリデーション実装
  - [ ] エラーハンドリング実装

#### 10. 承認フロー管理ページの統合・更新
- **ステータス**: ⏳ 未着手
- **担当**: フロントエンド
- **予想工数**: 1.5日
- **詳細**:
  - 既存ページとの統合
  - ナビゲーションの更新
  - 権限チェックの実装
- **実装ファイル**:
  - `frontend/src/app/(features)/approvals/page.tsx`
  - `frontend/src/components/features/approvals/ApprovalFlowManagement.tsx`
- **完了条件**:
  - [ ] 既存ページとの統合
  - [ ] ナビゲーション更新
  - [ ] 権限チェック実装
  - [ ] レスポンシブ対応
  - [ ] アクセシビリティ対応

### **Phase 4: データ・テスト** (2-3日)

#### 11. 承認フローのサンプルデータ作成（Seeder）
- **ステータス**: ⏳ 未着手
- **担当**: バックエンド
- **予想工数**: 1日
- **詳細**:
  - チーム別承認フローのサンプル
  - 金額別承認フローのサンプル
  - 条件分岐承認フローのサンプル
- **実装ファイル**:
  - `backend/database/seeders/ApprovalFlowSeeder.php`
- **完了条件**:
  - [ ] チーム別フローデータ作成
  - [ ] 金額別フローデータ作成
  - [ ] 条件分岐フローデータ作成
  - [ ] テストデータ作成
  - [ ] シーダー実行確認

#### 12. 承認フロー機能の動作テスト・検証
- **ステータス**: ⏳ 未着手
- **担当**: 全体
- **予想工数**: 1.5日
- **詳細**:
  - 機能テスト
  - 権限テスト
  - エラーケーステスト
  - パフォーマンステスト
- **完了条件**:
  - [ ] 機能テスト実行
  - [ ] 権限テスト実行
  - [ ] エラーケーステスト実行
  - [ ] パフォーマンステスト実行
  - [ ] 統合テスト実行
  - [ ] ユーザー受け入れテスト実行

## 📊 進捗管理

### 全体進捗
- **Phase 1**: 0/4 完了 (0%)
- **Phase 2**: 0/3 完了 (0%)
- **Phase 3**: 0/3 完了 (0%)
- **Phase 4**: 0/2 完了 (0%)
- **全体**: 0/12 完了 (0%)

### ステータス凡例
- ⏳ **未着手**: まだ開始していない
- 🔄 **実装中**: 現在作業中
- ✅ **完了**: 実装完了・テスト済み
- ❌ **キャンセル**: 実装をキャンセル
- ⚠️ **保留**: 一時的に保留中

## 🚀 実装の優先順位

### 高優先度（必須）
1. **データベース設計** - 全機能の基盤
2. **基本的な承認フロー機能** - コア機能
3. **チーム別承認フロー** - 主要ユースケース

### 中優先度（重要）
4. **条件分岐機能** - 柔軟性向上
5. **動的フロー選択** - 自動化
6. **UI実装** - ユーザビリティ

### 低優先度（拡張）
7. **並列承認** - 高度な機能
8. **カスタム条件** - 拡張性
9. **高度なUI機能** - UX向上

## 📝 実装メモ

### 技術的な注意点
- JSONカラムのパフォーマンス最適化
- 条件分岐ロジックのテストカバレッジ
- フロントエンドの状態管理
- エラーハンドリングの統一

### 依存関係
- Phase 1 → Phase 2 → Phase 3 → Phase 4
- 各Phase内では並行実装可能
- フロントエンドはバックエンドAPI完成後に実装

### リスク要因
- JSONカラムの複雑なクエリ
- 条件分岐ロジックの複雑性
- フロントエンドの状態管理の複雑性
- 既存機能との統合

## 🔄 更新履歴

| 日付 | 更新内容 | 更新者 |
|------|----------|--------|
| 2025-01-21 | 初版作成 | AI Assistant |

## 📞 連絡先・質問

実装に関する質問や問題が発生した場合は、このドキュメントを更新して進捗を共有してください。

---

**最終更新**: 2025-01-21  
**次回更新予定**: 実装開始時
