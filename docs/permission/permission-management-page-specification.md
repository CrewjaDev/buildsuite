# 権限管理ページ 機能仕様書

## 概要

システム管理者が権限システムを管理するための専用ページ。5階層の権限管理システム（システム権限レベル、役割、部署、職位、ユーザー個別）を統合的に管理し、組織の要件に応じた柔軟な権限設定を可能にする。

## 機能要件

### 1. アクセス制御
- **アクセス権限**: システム管理者（`is_admin = true`）または`permission.manage`権限を持つユーザーのみ
- **URL**: `/permissions`
- **権限チェック**: ページアクセス時に権限を確認し、権限がない場合はアクセス拒否画面を表示

### 2. 権限管理機能

#### 2.1 権限マスタ管理
- **権限一覧表示**: 全権限の一覧を表示
- **権限作成**: 新しい権限の作成
- **権限編集**: 既存権限の編集
- **権限削除**: 不要な権限の削除
- **権限検索**: 権限名、モジュール、アクションでの検索

#### 2.2 システム権限レベル管理
- **レベル一覧表示**: システム権限レベルの一覧
- **レベル作成**: 新しいシステム権限レベルの作成
- **レベル編集**: 既存レベルの編集
- **レベル削除**: 不要なレベルの削除
- **権限付与**: システム権限レベルに権限を付与
- **権限削除**: システム権限レベルから権限を削除

#### 2.3 役割管理
- **役割一覧表示**: 役割の一覧（実装済み：RoleSeederで定義済み）
- **役割作成**: 新しい役割の作成（例：営業マネージャー、経理担当、システム管理者）
- **役割編集**: 既存役割の編集
- **役割削除**: 不要な役割の削除
- **権限付与**: 役割に権限を付与（実装済み：RolePermissionSeederで設定済み）
- **権限削除**: 役割から権限を削除
- **ユーザー役割割り当て**: ユーザーに役割を割り当て（実装済み：社員管理ページで設定可能）

#### 2.4 部署権限管理
- **部署一覧表示**: 部署の一覧（実装済み：DepartmentSeederで定義済み）
- **権限付与**: 部署に権限を付与（実装済み：DepartmentPermissionSeederで設定済み）
- **権限削除**: 部署から権限を削除
- **部署別権限表示**: 各部署に付与されている権限の表示

#### 2.5 職位権限管理
- **職位一覧表示**: 職位の一覧（実装済み：PositionSeederで定義済み）
- **権限付与**: 職位に権限を付与（実装済み：PositionPermissionSeederで設定済み）
- **権限削除**: 職位から権限を削除
- **職位別権限表示**: 各職位に付与されている権限の表示
- **職位階層表示**: 職位の階層構造（社員 → 担当 → 課長 → 部長 → 取締役）

#### 2.6 ユーザー個別権限管理
- **ユーザー検索**: ユーザー名、ログインIDでの検索（実装済み：社員管理ページ）
- **個別権限付与**: 特定ユーザーに権限を付与
- **個別権限削除**: 特定ユーザーから権限を削除
- **ユーザー権限表示**: ユーザーの全権限（5階層）の表示（実装済み：社員管理ページの照会タブ）

#### 2.7 管理者権限の種類と使い分け

##### 2.7.1 完全システム管理者（is_admin = true）
**目的**: システム全体の完全制御
**権限範囲**: システムのすべての機能にアクセス可能
**用途**:
- システム開発・保守
- 緊急時のアクセス
- システム全体の管理
- データベース直接操作
- システム設定の変更

**特徴**:
- 5階層の権限システムを完全にバイパス
- 常に全権限を持つ
- システム管理者、開発者向け
- 最小限の人数に限定すべき

##### 2.7.2 業務システム管理者（system_manager役割）
**目的**: 業務要件に応じたシステム管理
**権限範囲**: 業務システムの管理機能にアクセス
**前提条件**: `is_admin = false`（5階層の権限システム内で管理）
**用途**:
- ユーザー管理
- 権限設定
- 業務データの管理
- システム設定の一部変更
- 日常的なシステム運用

**特徴**:
- 5階層の権限システム内で管理
- 他の役割と組み合わせ可能
- 業務担当者向け
- 複数人に割り当て可能
- 権限の細分化が可能

##### 2.7.3 権限計算の違い
```
完全システム管理者（is_admin = true）:
├─ 5階層の権限計算をスキップ
├─ 常に全権限を持つ
└─ システム全体を制御

業務システム管理者（system_manager役割）:
├─ 5階層の権限計算に含まれる
├─ 役割として全権限を取得
└─ 他の役割と組み合わせ可能
```

##### 2.7.4 実用的な使い分け
```
開発・保守チーム:
├─ is_admin = true
├─ システム全体の制御（業務権限もすべて含む）
├─ 緊急時の対応
└─ 開発・デバッグ作業

業務管理者:
├─ is_admin = false
├─ system_manager役割
├─ 日常的なシステム運用
├─ ユーザー管理
└─ 業務に特化した管理

注意: is_admin = true の場合は、system_manager役割を追加しても
権限は変わらない（既に全権限を持つため）
```

### 3. 権限表示機能

#### 3.1 権限階層表示
- **階層別権限表示**: 5階層の権限を階層別に表示
- **最終権限表示**: ユーザーの最終的な権限（和集合）を表示
- **権限の由来表示**: 各権限がどの階層から来ているかを表示

#### 3.2 ユーザー権限詳細表示
**表示例: 山田太郎（supervisor）の権限表示**

```
┌─ ユーザー権限詳細 ─────────────────────────────────────┐
│ ユーザー: 山田太郎 (yamada)                            │
│ システム権限レベル: supervisor                         │
│ 部署: 営業部                                           │
│ 職位: 課長                                             │
└────────────────────────────────────────────────────────┘

┌─ 1. システム権限レベル (supervisor) ───────────────────┐
│ • estimate.approval.view (見積承認依頼閲覧)            │
│ • estimate.approval.approve (見積承認)                 │
│ • estimate.approval.reject (見積却下)                  │
│ • estimate.approval.return (見積差し戻し)              │
│ • estimate.approval.request (見積承認依頼作成)         │
│ • approval.usage (承認者機能利用)                      │
└────────────────────────────────────────────────────────┘

┌─ 2. 役割権限 ──────────────────────────────────────────┐
│ • 営業マネージャー役割:                                │
│   - partner.view (取引先一覧閲覧)                      │
│   - partner.create (取引先作成)                        │
│   - estimate.report (見積書出力)                       │
│ ※ 実装済み：RoleSeederで定義、RolePermissionSeederで権限設定済み │
└────────────────────────────────────────────────────────┘

┌─ 3. 部署権限 (営業部) ─────────────────────────────────┐
│ • customer.data.view (顧客データ閲覧)                  │
│ • sales.report.view (売上レポート閲覧)                 │
│ ※ 実装済み：DepartmentPermissionSeederで設定済み      │
└────────────────────────────────────────────────────────┘

┌─ 4. 職位権限 (課長) ───────────────────────────────────┐
│ • team.manage (チーム管理)                             │
│ • budget.view (予算閲覧)                               │
│ ※ 実装済み：PositionPermissionSeederで設定済み        │
└────────────────────────────────────────────────────────┘

┌─ 5. 個別権限 ──────────────────────────────────────────┐
│ • system.config.view (システム設定閲覧)                │
└────────────────────────────────────────────────────────┘

┌─ 最終権限 (和集合) ────────────────────────────────────┐
│ 合計: 13個の権限                                       │
│                                                         │
│ 見積関連:                                               │
│ • estimate.approval.view, estimate.approval.approve,   │
│   estimate.approval.reject, estimate.approval.return,  │
│   estimate.approval.request, estimate.report           │
│                                                         │
│ 取引先関連:                                             │
│ • partner.view, partner.create                         │
│                                                         │
│ 承認関連:                                               │
│ • approval.usage                                        │
│                                                         │
│ その他:                                                 │
│ • customer.data.view, sales.report.view,               │
│   team.manage, budget.view, system.config.view         │
└────────────────────────────────────────────────────────┘
```

**権限の由来表示例:**
```
権限: estimate.approval.approve
├─ システム権限レベル (supervisor) ← メインソース
└─ 最終権限に含まれる

権限: partner.view
├─ 役割 (営業マネージャー) ← メインソース
└─ 最終権限に含まれる

権限: system.config.view
├─ 個別権限 ← メインソース
└─ 最終権限に含まれる
```

#### 3.3 権限影響範囲表示
- **影響ユーザー数**: 権限変更による影響を受けるユーザー数を表示
- **権限使用状況**: 各権限がどの程度使用されているかを表示

### 4. 一括操作機能

#### 4.1 一括権限付与
- **複数ユーザーへの一括付与**: 選択した複数ユーザーに権限を一括付与
- **部署・職位への一括付与**: 部署や職位の全ユーザーに権限を一括付与

#### 4.2 一括権限削除
- **複数ユーザーからの一括削除**: 選択した複数ユーザーから権限を一括削除
- **部署・職位からの一括削除**: 部署や職位の全ユーザーから権限を一括削除

## 技術仕様

### 1. フロントエンド

#### 1.1 ページ構成
```
/permissions
├── PermissionManagement.tsx (メインページ)
├── PermissionList.tsx (権限一覧)
├── PermissionForm.tsx (権限作成・編集)
├── SystemLevelManagement.tsx (システム権限レベル管理)
├── RoleManagement.tsx (役割管理)
├── DepartmentPermissionManagement.tsx (部署権限管理)
├── PositionPermissionManagement.tsx (職位権限管理)
├── UserPermissionManagement.tsx (ユーザー個別権限管理)
└── PermissionHierarchyView.tsx (権限階層表示)
```

#### 1.2 状態管理
- **TanStack Query**: 権限データの取得・キャッシュ
- **React State**: フォーム状態、フィルタ状態
- **URL State**: タブ状態、フィルタ条件をURLパラメータで管理

#### 1.3 UI/UX
- **Shadcn/ui**: コンポーネントライブラリ
- **TanStack Table**: 一覧表示
- **タブ形式**: 機能別にタブで分離
- **モーダル**: 作成・編集フォーム
- **確認ダイアログ**: 削除時の確認

#### 1.4 権限階層表示のUI設計
**タブ構成:**
```
┌─ 権限管理 ─────────────────────────────────────────────┐
│ [権限マスタ] [システム権限レベル] [役割] [部署権限]     │
│ [職位権限] [ユーザー権限] [権限階層表示]               │
└────────────────────────────────────────────────────────┘
```

**権限階層表示タブの内容:**
```
┌─ 権限階層表示 ─────────────────────────────────────────┐
│                                                         │
│ ユーザー検索: [山田太郎 ▼] [検索]                      │
│                                                         │
│ ┌─ ユーザー基本情報 ─────────────────────────────────┐ │
│ │ 名前: 山田太郎                                      │ │
│ │ ログインID: yamada                                  │ │
│ │ システム権限レベル: supervisor                      │ │
│ │ 部署: 営業部                                        │ │
│ │ 職位: 課長                                          │ │
│ └────────────────────────────────────────────────────┘ │
│                                                         │
│ ┌─ 権限階層詳細 ─────────────────────────────────────┐ │
│ │ [階層別表示] [最終権限] [権限の由来]                │ │
│ │                                                     │ │
│ │ ▼ 1. システム権限レベル (supervisor)               │ │
│ │   • estimate.approval.view                         │ │
│ │   • estimate.approval.approve                      │ │
│ │   • approval.usage                                 │ │
│ │                                                     │ │
│ │ ▼ 2. 役割権限                                      │ │
│ │   • 営業マネージャー: partner.view                 │ │
│ │                                                     │ │
│ │ ▼ 3. 部署権限 (営業部)                             │ │
│ │   • customer.data.view                             │ │
│ │                                                     │ │
│ │ ▼ 4. 職位権限 (課長)                               │ │
│ │   • team.manage                                    │ │
│ │                                                     │ │
│ │ ▼ 5. 個別権限                                      │ │
│ │   • system.config.view                             │ │
│ └────────────────────────────────────────────────────┘ │
│                                                         │
│ ┌─ 最終権限サマリー ─────────────────────────────────┐ │
│ │ 合計権限数: 13個                                    │ │
│ │ 見積関連: 6個 | 取引先関連: 2個 | 承認関連: 1個    │ │
│ │ その他: 4個                                         │ │
│ └────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────┘
```

**権限の由来表示モード:**
```
┌─ 権限の由来 ─────────────────────────────────────────┐
│ 権限: estimate.approval.approve                      │
│                                                       │
│ 由来:                                                 │
│ ┌─ システム権限レベル (supervisor) ─────────────────┐ │
│ │ 付与日: 2024-01-15                                │ │
│ │ 付与者: システム管理者                            │ │
│ │ ステータス: 有効                                  │ │
│ └──────────────────────────────────────────────────┘ │
│                                                       │
│ 影響範囲:                                             │
│ • この権限を持つユーザー: 15名                       │
│ • この権限を使用する機能: 見積承認処理               │
└───────────────────────────────────────────────────────┘
```

### 2. バックエンド

#### 2.1 API エンドポイント
```
# 権限管理
GET    /api/permissions                    # 権限一覧取得
POST   /api/permissions                    # 権限作成
GET    /api/permissions/{id}               # 権限詳細取得
PUT    /api/permissions/{id}               # 権限更新
DELETE /api/permissions/{id}               # 権限削除

# システム権限レベル管理
GET    /api/system-levels                  # システム権限レベル一覧
POST   /api/system-levels                  # システム権限レベル作成
PUT    /api/system-levels/{id}             # システム権限レベル更新
DELETE /api/system-levels/{id}             # システム権限レベル削除
POST   /api/system-levels/{id}/permissions # 権限付与
DELETE /api/system-levels/{id}/permissions # 権限削除

# 役割管理
GET    /api/roles                          # 役割一覧
POST   /api/roles                          # 役割作成
PUT    /api/roles/{id}                     # 役割更新
DELETE /api/roles/{id}                     # 役割削除
POST   /api/roles/{id}/permissions         # 権限付与
DELETE /api/roles/{id}/permissions         # 権限削除

# 部署権限管理
GET    /api/departments                    # 部署一覧
POST   /api/departments/{id}/permissions   # 権限付与
DELETE /api/departments/{id}/permissions   # 権限削除

# 職位権限管理
GET    /api/positions                      # 職位一覧
POST   /api/positions/{id}/permissions     # 権限付与
DELETE /api/positions/{id}/permissions     # 権限削除

# ユーザー個別権限管理
GET    /api/users                          # ユーザー一覧
GET    /api/users/{id}/permissions         # ユーザー権限取得
POST   /api/users/{id}/permissions         # 個別権限付与
DELETE /api/users/{id}/permissions         # 個別権限削除
```

#### 2.2 データベースクエリ
```sql
-- ユーザーの最終権限取得
SELECT DISTINCT p.*
FROM permissions p
WHERE p.is_active = true
  AND (
    -- システム権限レベル
    EXISTS (
      SELECT 1 FROM system_level_permissions slp
      JOIN system_levels sl ON slp.system_level_id = sl.id
      WHERE slp.permission_id = p.id
        AND sl.code = ?
    )
    OR
    -- 役割
    EXISTS (
      SELECT 1 FROM user_roles ur
      JOIN role_permissions rp ON ur.role_id = rp.role_id
      WHERE rp.permission_id = p.id
        AND ur.user_id = ?
        AND ur.is_active = true
    )
    OR
    -- 部署
    EXISTS (
      SELECT 1 FROM user_departments ud
      JOIN department_permissions dp ON ud.department_id = dp.department_id
      WHERE dp.permission_id = p.id
        AND ud.user_id = ?
        AND ud.is_active = true
    )
    OR
    -- 職位
    EXISTS (
      SELECT 1 FROM employees e
      JOIN position_permissions pp ON e.position_id = pp.position_id
      WHERE pp.permission_id = p.id
        AND e.user_id = ?
    )
    OR
    -- 個別権限
    EXISTS (
      SELECT 1 FROM user_permissions up
      WHERE up.permission_id = p.id
        AND up.user_id = ?
    )
  );
```

### 3. セキュリティ

#### 3.1 権限チェック
- システム管理者権限の確認
- 各APIエンドポイントでの権限チェック
- 権限変更時の影響範囲の確認

#### 3.2 管理者権限のセキュリティ管理

##### 3.2.1 完全システム管理者（is_admin）のセキュリティ
**管理方針**:
- **最小権限の原則**: 必要最小限の人数に限定
- **厳格な監査**: 全ての操作を詳細に記録
- **定期的な見直し**: 権限の必要性を定期的に確認
- **緊急時のみ**: 通常時は業務システム管理者で運用

**セキュリティ要件**:
- 強力なパスワードポリシー
- 多要素認証の実装
- アクセスログの詳細記録
- 定期的な権限レビュー

##### 3.2.2 業務システム管理者（system_manager役割）のセキュリティ
**管理方針**:
- **is_admin = false**: 5階層の権限システム内で管理
- **業務範囲内**: 業務に必要な権限のみ付与
- **役割の組み合わせ**: 他の役割と適切に組み合わせ
- **定期的な権限見直し**: 業務変更に応じて調整
- **監査の実施**: 権限使用状況の監視

**セキュリティ要件**:
- 標準的なパスワードポリシー
- アクセスログの記録
- 権限変更の承認プロセス
- 定期的な権限レビュー
- 5階層の権限システムによる制御

#### 3.3 監査ログ
- 権限変更のログ記録
- 変更者、変更日時、変更内容の記録
- 権限変更履歴の表示
- **管理者権限の特別監査**: is_admin権限の使用状況を重点的に監視

## 実装スケジュール

### Phase 1: 基本機能 ✅ 完了
1. **権限管理ページ作成** ✅ 完了
   - ページルーティング
   - 基本レイアウト
   - 権限チェック

2. **権限マスタ管理** ✅ 完了
   - 権限一覧表示
   - 権限作成・編集・削除
   - 権限検索

3. **システム権限レベル管理** ✅ 完了
   - レベル一覧表示
   - レベル作成・編集・削除
   - 権限付与・削除

### Phase 2: 拡張機能 ✅ 完了
4. **役割管理** ✅ 完了
   - 役割一覧表示（RoleSeederで定義済み）
   - 役割作成・編集・削除
   - 権限付与・削除（RolePermissionSeederで設定済み）
   - ユーザー役割割り当て（社員管理ページで実装済み）

5. **部署・職位権限管理** ✅ 完了
   - 部署権限管理（DepartmentPermissionSeederで設定済み）
   - 職位権限管理（PositionPermissionSeederで設定済み）
   - 権限付与・削除

### Phase 3: 高度な機能 🔄 進行中
6. **ユーザー個別権限管理** ✅ 部分完了
   - ユーザー検索（社員管理ページで実装済み）
   - 個別権限付与・削除
   - 権限階層表示（社員管理ページの照会タブで実装済み）

7. **一括操作機能** ⏳ 未実装
   - 一括権限付与・削除
   - 影響範囲表示

## 実装完了状況

### ✅ 完了済み機能
1. **5階層権限システムの基盤構築**
   - システム権限レベル（SystemLevelSeeder）
   - 役割（RoleSeeder）
   - 部署権限（DepartmentPermissionSeeder）
   - 職位権限（PositionPermissionSeeder）
   - ユーザー役割割り当て（UserRoleSeeder）

2. **管理者権限システム**
   - 完全システム管理者（is_admin）の実装
   - 業務システム管理者（system_manager役割）の実装
   - 管理者権限の使い分け機能
   - 権限計算ロジックの実装

3. **社員管理ページでの権限管理**
   - システム権限レベルの設定
   - 機能役割の設定（複数選択可能）
   - 管理者権限の設定（is_admin）
   - 照会タブでの権限表示
   - 権限の任意設定対応

4. **バックエンドAPI**
   - 役割管理API（RoleController）
   - ユーザー役割更新API
   - 権限取得API
   - 管理者権限チェック機能

5. **フロントエンド実装**
   - 型定義の一元管理（types/features/employees/）
   - 役割管理フック（useRoles）
   - 社員管理フック（useEmployees）
   - 権限表示コンポーネント
   - 管理者権限表示機能

### 🔄 進行中・部分完了
1. **権限管理ページ**
   - 基本的な権限管理機能
   - 権限階層表示（社員管理ページで実装済み）

### ⏳ 未実装
1. **専用権限管理ページ**
   - 権限マスタ管理
   - システム権限レベル管理
   - 部署・職位権限管理
   - 一括操作機能

## テスト仕様

### 1. 単体テスト
- 権限チェック機能のテスト
- 権限付与・削除機能のテスト
- API エンドポイントのテスト

### 2. 統合テスト
- 権限変更による影響のテスト
- ユーザー権限の最終計算のテスト
- 権限階層の動作テスト

### 3. セキュリティテスト
- 権限チェックのテスト
- 不正アクセスの防止テスト
- 監査ログのテスト

## 運用・保守

### 1. 監視
- 権限変更の監視
- 権限使用状況の監視
- エラー率の監視

### 2. ログ
- 権限変更ログ
- アクセスログ
- エラーログ

### 3. バックアップ
- 権限設定データのバックアップ
- 権限変更履歴のバックアップ

## 関連ドキュメント

- [権限管理システム仕様書](./permission-business.md)
- [承認フロー高度仕様書](../approval/approval-implementation/level-2/approval-flow-advanced-specification.md)
- [実装進捗トラッカー](../approval/approval-implementation/level-2/implementation-progress-tracker.md)
