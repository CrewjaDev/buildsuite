# 権限管理ページ UI設計

## 概要

システム管理者向けの権限管理ページの操作画面構成とUI設計を定義します。

## 業務タイプと権限の関係

### 権限の命名規則
権限名は `{モジュールコード}.{アクション}` の形式で定義されています：

- **estimate.view** → 見積閲覧
- **estimate.create** → 見積作成  
- **estimate.edit** → 見積編集
- **estimate.approval.approve** → 見積承認

### モジュールコードの定義
モジュールコードは `business_types` テーブルの `code` フィールドと紐づけられています：

| モジュールコード | 業務名 | カテゴリ | 説明 |
|---|---|---|---|
| estimate | 見積 | financial | 見積書の作成・承認業務 |
| budget | 予算 | financial | 予算の申請・承認業務 |
| purchase | 発注 | financial | 発注の申請・承認業務 |
| construction | 工事 | construction | 工事関連の承認業務 |
| general | 一般 | general | 一般的な承認業務 |
| system | システム | system | システム管理関連の承認業務 |
| user | ユーザー管理 | system | ユーザー管理業務 |

### 権限の自動生成
新しい業務タイプを追加すると、`default_permissions` に基づいて権限が自動的に生成される仕組みになっています。

### フィルタ機能での活用
権限一覧のモジュールフィルタでは、`business_types` テーブルの `code` を使用して業務タイプ別に権限を絞り込みます。

## 全体構成

### メインレイアウト
```
┌─────────────────────────────────────────────────────────────┐
│ 権限管理システム                                    [ログアウト] │
├─────────────────────────────────────────────────────────────┤
│ [権限マスタ] [権限階層] [テンプレート] [監査・分析] [設定]        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│                    メインコンテンツエリア                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## タブ構成

### 1. 権限マスタ管理タブ
**目的**: 権限の基本定義と各階層への権限付与を管理

#### 1.1 権限一覧セクション
```
┌─ 権限一覧 ─────────────────────────────────────────────────┐
│ [検索: 権限名/モジュール/アクション] [フィルタ: モジュール▼] [新規作成] │
├─────────────────────────────────────────────────────────────┤
│ 権限名          │ 表示名      │ モジュール │ アクション │ 操作    │
│ estimate.view   │ 見積閲覧    │ estimate  │ view      │ [編集]  │
│ estimate.create │ 見積作成    │ estimate  │ create    │ [編集]  │
│ estimate.edit   │ 見積編集    │ estimate  │ edit      │ [編集]  │
│ user.view       │ ユーザー閲覧 │ user      │ view      │ [編集]  │
└─────────────────────────────────────────────────────────────┘
```

#### 1.2 階層別権限付与セクション
```
┌─ 階層別権限付与 ───────────────────────────────────────────┐
│ [システム権限レベル] [役割] [職位] [部署] [個別権限]           │
├─────────────────────────────────────────────────────────────┤
│ システム権限レベル: [staff ▼]                               │
│ ┌─ 付与済み権限 ──────────────────────────────────────────┐ │
│ │ ☑ estimate.view    ☑ estimate.create                   │ │
│ │ ☐ estimate.edit    ☐ estimate.approve                  │ │
│ │ ☑ user.view        ☐ user.create                       │ │
│ └─────────────────────────────────────────────────────────┘ │
│ [権限を追加] [一括設定] [保存]                               │
└─────────────────────────────────────────────────────────────┘
```

### 2. 権限階層表示タブ
**目的**: 5階層の権限構造を可視化

#### 2.1 階層構造表示
```
┌─ 権限階層構造 ─────────────────────────────────────────────┐
│ [ユーザー選択: 山田太郎 ▼] [権限計算] [詳細表示]              │
├─────────────────────────────────────────────────────────────┤
│ 山田太郎の権限構成:                                          │
│                                                             │
│ ┌─ システム権限レベル: supervisor ────────────────────────┐ │
│ │ estimate.view, estimate.create, estimate.edit,         │ │
│ │ estimate.approve, user.view, user.edit                 │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌─ 役割: 営業マネージャー ────────────────────────────────┐ │
│ │ estimate.view, estimate.create, estimate.edit,         │ │
│ │ estimate.approve, customer.view, customer.create       │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌─ 職位: 課長 ────────────────────────────────────────────┐ │
│ │ team.view, team.manage, report.view, report.create     │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌─ 部署: 営業部 ──────────────────────────────────────────┐ │
│ │ customer.view, customer.create, estimate.view          │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌─ 個別権限: なし ────────────────────────────────────────┐ │
│ │ (個別権限は設定されていません)                           │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌─ 最終権限（統合後） ────────────────────────────────────┐ │
│ │ estimate.view, estimate.create, estimate.edit,         │ │
│ │ estimate.approve, user.view, user.edit,                │ │
│ │ customer.view, customer.create, team.view,             │ │
│ │ team.manage, report.view, report.create                │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 3. 権限テンプレート管理タブ
**目的**: よく使用される権限セットのテンプレート化

#### 3.1 テンプレート一覧
```
┌─ 権限テンプレート ─────────────────────────────────────────┐
│ [検索: テンプレート名] [新規作成] [インポート] [エクスポート]    │
├─────────────────────────────────────────────────────────────┤
│ テンプレート名    │ 説明              │ 権限数 │ 使用回数 │ 操作    │
│ 営業部標準       │ 営業部の標準権限    │ 15    │ 8       │ [編集]  │
│ 経理部標準       │ 経理部の標準権限    │ 12    │ 5       │ [編集]  │
│ 管理者標準       │ 管理者の標準権限    │ 20    │ 3       │ [編集]  │
│ 緊急時アクセス    │ 緊急時の特別権限    │ 8     │ 1       │ [編集]  │
└─────────────────────────────────────────────────────────────┘
```

#### 3.2 テンプレート作成・編集
```
┌─ テンプレート編集 ─────────────────────────────────────────┐
│ テンプレート名: [営業部標準                    ]              │
│ 説明: [営業部の標準的な権限セット                ]              │
│                                                             │
│ 権限セット:                                                  │
│ ┌─ システム権限レベル ────────────────────────────────────┐ │
│ │ ☑ staff (担当者)                                       │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌─ 役割 ──────────────────────────────────────────────────┐ │
│ │ ☑ 営業マネージャー    ☑ 見積担当                       │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌─ 職位 ──────────────────────────────────────────────────┐ │
│ │ ☑ 担当    ☑ 課長                                       │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌─ 部署 ──────────────────────────────────────────────────┐ │
│ │ ☑ 営業部                                               │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌─ 個別権限 ──────────────────────────────────────────────┐ │
│ │ ☑ customer.view    ☑ customer.create                   │ │
│ │ ☑ estimate.view    ☑ estimate.create                   │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ [プレビュー] [保存] [キャンセル]                             │
└─────────────────────────────────────────────────────────────┘
```

### 4. 監査・分析タブ
**目的**: 権限使用状況の監査と分析

#### 4.1 権限使用状況
```
┌─ 権限使用状況 ─────────────────────────────────────────────┐
│ [期間: 2024/01/01 - 2024/01/31] [ユーザー: 全員▼] [更新]    │
├─────────────────────────────────────────────────────────────┤
│ 権限名          │ 使用回数 │ ユーザー数 │ 最終使用日 │ 状態    │
│ estimate.view   │ 1,245   │ 15        │ 2024/01/30 │ 正常    │
│ estimate.create │ 89      │ 8         │ 2024/01/29 │ 正常    │
│ user.delete     │ 2       │ 1         │ 2024/01/15 │ 注意    │
│ emergency.access│ 0       │ 0         │ -          │ 未使用  │
└─────────────────────────────────────────────────────────────┘
```

#### 4.2 異常検知
```
┌─ 異常検知 ─────────────────────────────────────────────────┐
│ [検知レベル: 高▼] [期間: 7日間▼] [通知設定]                  │
├─────────────────────────────────────────────────────────────┤
│ 日時            │ ユーザー    │ 権限        │ 内容        │ 状態    │
│ 2024/01/30 14:30│ 田中太郎    │ user.delete │ 大量削除    │ 未確認  │
│ 2024/01/29 09:15│ 佐藤花子    │ admin.access│ 深夜アクセス │ 確認済  │
│ 2024/01/28 16:45│ 山田次郎    │ data.export │ 大量エクスポート│ 未確認  │
└─────────────────────────────────────────────────────────────┘
```

### 5. 設定タブ
**目的**: 権限システムの設定

#### 5.1 システム設定
```
┌─ 権限システム設定 ─────────────────────────────────────────┐
│ 権限の優先度設定:                                            │
│ ┌─ 優先順位 ──────────────────────────────────────────────┐ │
│ │ 1. 個別権限 (最優先)                                   │ │
│ │ 2. 部署権限                                           │ │
│ │ 3. 職位権限                                           │ │
│ │ 4. 役割権限                                           │ │
│ │ 5. システム権限レベル (基本権限)                       │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 権限統合ルール:                                              │
│ ┌─ 統合方式 ──────────────────────────────────────────────┐ │
│ │ ☑ OR論理 (重複除去)                                   │ │
│ │ ☐ AND論理 (共通部分のみ)                              │ │
│ │ ☐ 上書き方式 (上位が下位を上書き)                      │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 権限の有効期限:                                              │
│ ┌─ 有効期限設定 ──────────────────────────────────────────┐ │
│ │ ☑ 個別権限に有効期限を設定                             │ │
│ │ デフォルト有効期限: [90] 日                             │ │
│ │ ☑ 期限切れ時に自動無効化                               │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ [保存] [リセット] [テスト実行]                               │
└─────────────────────────────────────────────────────────────┘
```

## 操作フロー

### 1. 権限マスタ管理の操作フロー
```
1. 権限一覧で権限を選択
   ↓
2. 階層別権限付与で対象階層を選択
   ↓
3. 権限の追加・削除を実行
   ↓
4. 変更内容を確認
   ↓
5. 保存
```

### 2. 権限階層表示の操作フロー
```
1. ユーザーを選択
   ↓
2. 権限計算を実行
   ↓
3. 各階層の権限を確認
   ↓
4. 最終権限（統合後）を確認
   ↓
5. 必要に応じて個別権限を追加
```

### 3. テンプレート管理の操作フロー
```
1. テンプレートを作成・選択
   ↓
2. 権限セットを設定
   ↓
3. プレビューで確認
   ↓
4. 保存
   ↓
5. 必要に応じてユーザーに適用
```

## レスポンシブ対応

### デスクトップ (1200px以上)
- 3カラムレイアウト
- サイドバー + メインコンテンツ + 詳細パネル

### タブレット (768px - 1199px)
- 2カラムレイアウト
- サイドバー + メインコンテンツ

### モバイル (767px以下)
- 1カラムレイアウト
- タブ切り替えでコンテンツ表示

## アクセシビリティ

### キーボード操作
- Tabキーでの順次移動
- Enterキーでの選択・実行
- Escapeキーでのキャンセル

### スクリーンリーダー対応
- 適切なaria-label
- セマンティックなHTML構造
- フォーカス管理

## パフォーマンス考慮

### データ読み込み
- ページネーション
- 仮想スクロール
- 遅延読み込み

### キャッシュ
- 権限データのキャッシュ
- ユーザー権限のキャッシュ
- テンプレートのキャッシュ

---

**作成日**: 2024年1月21日
**更新日**: 2024年1月21日
**作成者**: AI Assistant
