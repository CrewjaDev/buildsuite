# 権限システム再構築提案

## 現状の問題点

現在のシステム権限レベルには、**組織階層的な権限**と**機能特化型の権限**が混在しており、権限管理が複雑になっています。

## 再構築案（実装済み）

### 1. システム権限レベル（組織階層）

**目的**: 組織の階層的な権限レベルを定義
**特徴**: 職位と連動し、基本的な権限レベルを提供

```
system_admin (システム管理者) - 優先度: 8
├─ システム全体の管理権限
└─ 全機能へのアクセス権限

executive (最高責任者) - 優先度: 7
├─ 経営判断権限
├─ 最終承認権限
└─ 全業務データの閲覧権限

supervisor (上長) - 優先度: 3
├─ 部下の管理権限
├─ 承認権限
└─ チーム業務の管理権限

staff (担当者) - 優先度: 1
├─ 基本的な業務権限
├─ データ入力・編集権限
└─ 承認依頼権限
```

### 2. 役割（機能特化型）

**目的**: 業務機能に特化した権限を定義
**特徴**: ユーザーに複数割り当て可能、業務内容に応じて柔軟に設定

```
システム管理関連:
├─ system_manager (システム管理者)
│  ├─ システム設定管理権限
│  ├─ ユーザー管理権限
│  └─ 権限管理権限

経理・財務関連:
├─ accounting_manager (経理責任者)
│  ├─ 財務データ管理権限
│  ├─ 予算管理権限
│  └─ 経理承認権限
└─ accounting_staff (経理担当)
   ├─ 経理データ入力権限
   └─ 経理レポート閲覧権限

工事関連:
├─ construction_manager (工事責任者)
│  ├─ 工事管理権限
│  ├─ 工事承認権限
│  └─ 工事レポート権限
└─ construction_staff (工事担当)
   ├─ 工事データ入力権限
   └─ 工事進捗管理権限

事務管理関連:
├─ office_manager (事務長)
│  ├─ 事務管理権限
│  ├─ 文書管理権限
│  └─ 総務管理権限
└─ office_staff (事務担当)
   ├─ 文書作成権限
   └─ データ入力権限

見積関連:
├─ estimator_senior (上級見積担当)
│  ├─ 複雑な見積作成権限
│  ├─ 見積承認権限
│  └─ 見積分析権限
└─ estimator (見積担当)
   ├─ 基本見積作成権限
   └─ 見積データ管理権限
```

### 3. 職位（組織階層）

**目的**: 組織の階層的な役職を定義
**特徴**: 社員テーブルと直接紐づけ、組織変更時の権限自動更新

```
取締役 (director) - レベル: 5
├─ 経営判断権限
└─ 最終承認権限

部長 (department_manager) - レベル: 4
├─ 部門管理権限
├─ 予算管理権限
└─ 部門承認権限

課長 (section_chief) - レベル: 3
├─ チーム管理権限
├─ 業務承認権限
└─ 進捗管理権限

担当 (staff) - レベル: 2
├─ 基本業務権限
├─ データ入力権限
└─ 承認依頼権限

社員 (employee) - レベル: 1
├─ 基本閲覧権限
└─ データ入力権限
```

## 権限の計算式（再構築後）

```
ユーザー最終権限 = システム権限レベル + 役割 + 職位 + 部署 + 個別権限
```

### 優先順位
1. **個別権限**（最優先）
2. **部署権限**
3. **職位権限**
4. **役割権限**
5. **システム権限レベル**（基本権限）

## 実装状況

### ✅ 完了済み
1. **システム権限レベルの整理**
   - 機能特化型の権限を役割に移行
   - 組織階層的な権限のみをシステム権限レベルに残す

2. **役割データの作成**
   - 移行した権限を基に役割を作成
   - 既存ユーザーに適切な役割を割り当て

3. **社員管理ページの統合**
   - 権限設定タブの実装
   - パスワード変更ダイアログの分離
   - 機能役割の複数選択・保存機能

4. **パスワード管理の分離**
   - パスワード変更専用APIエンドポイントの作成
   - 権限管理とパスワード管理の完全分離

### 🔄 進行中
1. **職位権限の設定**
   - 職位に応じた基本権限を設定
   - 職位変更時の権限自動更新を実装

### 📋 今後の予定
1. **権限管理ページの実装**
   - システム管理者向けの権限管理画面
   - 5階層権限システムの可視化

## 具体的な移行例

### 移行前（旧システム）
```
山田太郎:
- システム権限レベル: supervisor (上長)
- 職位: 担当
- 役割: なし
```

### 移行後（現在の実装）
```
山田太郎:
- システム権限レベル: supervisor (上長)
- 職位: 担当
- 役職: 営業主任 (job_title) - 自由入力
- 役割: 営業マネージャー, 見積担当 - 複数選択可能
- 管理者権限: false
```

## 役職（job_title）の活用方針

### 現在の状況
- 社員テーブルに`job_title`フィールドが存在
- 一部の社員に役職が設定済み（システム管理者、営業主任、営業担当）

### 活用方針
1. **役職は表示用**: 社員の具体的な役職名を表示
2. **役割は権限用**: 権限管理のための機能別役割
3. **職位は階層用**: 組織の階層的な権限レベル

### 役職と役割の関係
```
役職（job_title） → 役割（Role）の推奨設定
├─ システム管理者 → システム管理者役割
├─ 営業主任 → 営業マネージャー役割
├─ 営業担当 → 営業担当役割
├─ 工事責任者 → 工事責任者役割
└─ 経理責任者 → 経理責任者役割
```

## 実装方針

### 役職（job_title）の管理方針
- **自由入力**: 社員の具体的な役職名は自由に設定可能
- **表示専用**: 人事管理や表示用途でのみ使用
- **権限とは独立**: 権限管理とは直接的な連動なし

### 役割（Role）の管理方針
- **選択リスト**: 事前定義された役割から選択
- **権限管理**: 機能別権限の割り当てに使用
- **複数選択可能**: 1人のユーザーが複数の役割を持つことが可能
- **任意設定**: 役割の設定は任意で、未設定でもシステム利用可能

### 複数役割の実装詳細

#### データベース設計
既存の`user_roles`テーブルが多対多の関係をサポートしているため、1人のユーザーが複数の役割を持つことが可能です。

```sql
-- user_roles テーブル（既存）
user_id | role_id | assigned_at | assigned_by | is_active
--------|---------|-------------|-------------|----------
   2    |    4    | 2024-01-01  |      1      |   true   -- 営業マネージャー
   2    |    7    | 2024-01-01  |      1      |   true   -- 見積担当
```

#### 権限の統合
複数の役割を持つ場合、各役割の権限が**統合（OR論理）**されます。

**例：山田太郎（営業マネージャー + 見積担当）**
- 営業マネージャーの権限：`estimate.view`, `estimate.create`, `estimate.edit`, `estimate.approve`
- 見積担当の権限：`estimate.view`, `estimate.create`, `estimate.edit`, `estimate.report`
- **統合結果**：`estimate.view`, `estimate.create`, `estimate.edit`, `estimate.approve`, `estimate.report`

#### 実用的な活用例
1. **営業主任**：営業マネージャー + 見積担当
2. **工事部長**：工事責任者 + 上級見積担当
3. **経理部長**：経理責任者 + 事務長
4. **一般社員**：役割なし（システム権限レベルの基本権限のみ）

#### 役割未設定の場合の権限
- **システム権限レベル**: 組織階層に応じた基本権限
- **職位権限**: 職位に応じた基本権限
- **部署権限**: 所属部署に応じた基本権限
- **機能権限**: なし（役割が設定されていないため）

### 社員管理ページでの設定画面設計（実装済み）
```
┌─ 基本情報 ─────────────────┐
│ 氏名: 山田太郎              │
│ 役職: [営業主任        ] ← 自由入力 │
│ 職位: [担当 ▼] ← 選択リスト    │
│ 部署: [営業部 ▼] ← 選択リスト   │
└─────────────────────────────┘

┌─ 権限設定 ─────────────────┐
│ ログインID: [yamada_taro]   │
│ システム権限レベル: [上長 ▼]   │
│ 管理者権限: ☐               │
│ 機能役割:                    │
│ ☑ 営業マネージャー            │
│ ☐ 見積担当                  │
│ ☐ 経理責任者                │
│ [パスワードを変更] ボタン      │
└─────────────────────────────┘
```

### メリット
1. **柔軟性**: 組織の実情に合わせた役職名の設定が可能
2. **拡張性**: 新しい役職名の追加が容易
3. **分離の原則**: 表示用データと権限データの明確な分離
4. **実用性**: 実際の組織運営に即した運用が可能

## 実装済みの機能

### 1. パスワード管理の分離
- **権限設定タブ**: パスワードフィールドなし、バリデーションエラーなし
- **パスワード変更ダイアログ**: 現在のパスワード確認 + 新しいパスワード設定
- **専用API**: `PUT /api/users/{id}/password`

### 2. 機能役割の複数選択
- **チェックボックス形式**: 複数の役割を同時選択可能
- **権限の統合**: 選択した役割の権限がOR論理で統合
- **任意設定**: 役割未設定でもシステム利用可能

### 3. 管理者権限の分離
- **is_admin**: 完全なシステム管理者（全権限）
- **system_manager役割**: 業務システム管理者（機能特化）

## 全体のメリット

1. **権限の明確化**: 組織階層と機能特化を分離 ✅
2. **柔軟性の向上**: 役割の複数割り当てが可能 ✅
3. **管理の簡素化**: 権限の設定・変更が容易 ✅
4. **拡張性の向上**: 新しい業務機能への対応が容易 ✅
5. **セキュリティの向上**: パスワード管理の分離 ✅
