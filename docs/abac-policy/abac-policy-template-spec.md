# ABACポリシーテンプレート機能仕様書

## 概要

ABACポリシーテンプレート機能は、**ポリシーの最小単位（機能の型）**を事前定義し、管理者がこれらを組み合わせることで、技術的な知識がなくても柔軟なポリシーを作成できる機能です。

### 基本コンセプト
- **最小単位のテンプレート**: 「部署制限」「金額制限」「作成者制限」などの機能の型
- **組み合わせ方式**: 複数のテンプレートを組み合わせて複雑なポリシーを構築
- **標準装備**: よく使用されるテンプレートは標準提供
- **カスタマイズ対応**: 特殊な要件は個別対応

## 設計方針

### 1. 非技術者向けのUI設計
- テンプレートは日本語で分かりやすい名前と説明を持つ
- カテゴリ別に整理され、視覚的に選択しやすい
- 条件式の詳細は隠蔽し、ビジネス要件に焦点を当てる

### 2. 段階的なカスタマイズ
- テンプレート選択 → 基本設定 → 詳細カスタマイズの流れ
- 必須項目のみの簡易モードと、全項目の詳細モードを提供

### 3. 再利用性と保守性
- テンプレートはシステム管理者が事前定義
- ビジネス要件の変更に応じてテンプレートを更新可能

## 最小単位テンプレートの種類

### 1. 標準装備テンプレート（システム提供）

#### 部署・組織関連
| テンプレート名 | 説明 | 条件式 | 適用例 |
|---|---|---|---|
| 自部署制限 | 自分の部署のデータのみ | `data.department_id = user.department_id` | 営業部は営業部の見積のみ |
| 自部署以下制限 | 自分の部署と下位部署のデータ | `data.department_id IN user.department_hierarchy` | 本社は全支社のデータ |
| 特定部署制限 | 指定した部署のデータのみ | `data.department_id IN [1,2,3]` | 経理部は特定部署のみ |

#### 職位・権限関連
| テンプレート名 | 説明 | 条件式 | 適用例 |
|---|---|---|---|
| 課長以上制限 | 課長以上の職位のみ | `user.position_level >= 3` | 課長以上が承認可能 |
| 部長以上制限 | 部長以上の職位のみ | `user.position_level >= 4` | 部長以上が承認可能 |
| 特定職位制限 | 指定した職位のみ | `user.position_id IN [3,4,5]` | 特定職位のみ操作可能 |

#### データ属性関連
| テンプレート名 | 説明 | 条件式 | 適用例 |
|---|---|---|---|
| 金額上限制限 | 指定金額以下のデータのみ | `data.amount <= 1000000` | 100万円以下の承認 |
| 金額範囲制限 | 指定範囲内の金額のみ | `data.amount BETWEEN 100000 AND 1000000` | 10-100万円の承認 |
| ステータス制限 | 特定ステータスのデータのみ | `data.status IN ['draft','pending']` | 草案・承認待ちのみ編集 |
| 作成者制限 | 自分が作成したデータのみ | `data.created_by = user.id` | 自分の作成データのみ |

#### 時間・環境関連
| テンプレート名 | 説明 | 条件式 | 適用例 |
|---|---|---|---|
| 営業時間制限 | 9:00-17:00の営業時間内のみ | `current_time BETWEEN '09:00' AND '17:00'` | 営業時間内のみ操作 |
| 平日制限 | 平日のみ操作可能 | `current_day NOT IN ['Saturday','Sunday']` | 平日のみ操作 |
| 社内IP制限 | 社内IPからのアクセスのみ | `user.ip_address LIKE '192.168.%'` | 社内からのみアクセス |

### 2. カスタムテンプレート（個別対応）

標準装備で対応できない特殊な要件は、個別にカスタムテンプレートを作成

## テンプレートの構造

### データベース設計

#### `policy_condition_templates` テーブル

このテーブルは、**ポリシーの最小単位（機能の型）**を管理するテーブルです。各レコードは1つの制限条件テンプレートを表し、これらを組み合わせることで複雑なポリシーを構築します。

```sql
CREATE TABLE policy_condition_templates (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,          -- レコード識別子（自動採番）
    template_code VARCHAR(100) UNIQUE NOT NULL,    -- テンプレートの一意識別子（例：「dept_self_restriction」）
    name VARCHAR(255) NOT NULL,                    -- テンプレート名（例：「自部署制限」）
    description TEXT,                              -- テンプレートの説明
    category VARCHAR(100) NOT NULL,                -- カテゴリ（例：「部署・組織」「データ属性」）
    condition_type VARCHAR(100) NOT NULL,          -- 条件タイプ（例：「department_restriction」）
    condition_rule JSON NOT NULL,                  -- 条件式のルール定義
    parameters JSON,                               -- パラメータ設定（金額上限など）
    is_system BOOLEAN NOT NULL DEFAULT true,       -- システム提供テンプレートかどうか
    is_active BOOLEAN NOT NULL DEFAULT true,       -- 有効/無効フラグ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_template_code (template_code),       -- テンプレートコード検索用
    INDEX idx_category (category),                 -- カテゴリ別検索用
    INDEX idx_condition_type (condition_type),     -- 条件タイプ別検索用
    INDEX idx_is_system (is_system),               -- システム/カスタム判別用
    INDEX idx_is_active (is_active)                -- 有効/無効判別用
);
```

#### テーブルの役割

1. **最小単位の管理**: 各テンプレートは1つの制限条件のみを定義
2. **再利用性**: 同じテンプレートを複数のポリシーで使用可能
3. **組み合わせ**: 複数のテンプレートを組み合わせて複雑なポリシーを構築
4. **標準化**: よく使用される制限条件を標準化して提供

### テンプレートの構造例

#### 1. 自部署制限テンプレート
```json
{
  "id": 1,
  "template_code": "dept_self_restriction",
  "name": "自部署制限",
  "description": "自分の部署のデータのみアクセス可能",
  "category": "部署・組織",
  "condition_type": "department_restriction",
  "condition_rule": {
    "field": "data.department_id",
    "operator": "eq",
    "value": "user.department_id"
  },
  "parameters": {
    "required_fields": ["data.department_id", "user.department_id"],
    "applicable_actions": ["view", "list", "edit", "approve"]
  },
  "is_system": true,
  "is_active": true
}
```

#### 2. 金額上限制限テンプレート
```json
{
  "id": 2,
  "template_code": "amount_limit_restriction",
  "name": "金額上限制限",
  "description": "指定金額以下のデータのみアクセス可能",
  "category": "データ属性",
  "condition_type": "amount_restriction",
  "condition_rule": {
    "field": "data.amount",
    "operator": "lte",
    "value": "{{amount_limit}}"
  },
  "parameters": {
    "required_fields": ["data.amount"],
    "configurable_values": {
      "amount_limit": {
        "type": "number",
        "label": "金額上限",
        "default": 1000000,
        "unit": "円"
      }
    },
    "applicable_actions": ["approve", "edit"]
  },
  "is_system": true,
  "is_active": true
}
```

### テンプレートの条件式例

#### 1. 自部署のみ閲覧テンプレート
```json
{
  "operator": "and",
  "rules": [
    {
      "field": "data.department_id",
      "operator": "eq",
      "value": "user.department_id"
    }
  ]
}
```

#### 2. 作成者のみ編集テンプレート
```json
{
  "operator": "and",
  "rules": [
    {
      "field": "data.created_by",
      "operator": "eq",
      "value": "user.id"
    },
    {
      "field": "data.status",
      "operator": "in",
      "value": ["draft", "pending_approval"]
    }
  ]
}
```

#### 3. 金額制限承認テンプレート
```json
{
  "operator": "and",
  "rules": [
    {
      "field": "data.amount",
      "operator": "lte",
      "value": 1000000
    },
    {
      "field": "user.position_id",
      "operator": "in",
      "value": [3, 4]
    }
  ]
}
```

## 組み合わせ方式のUI設計

### 1. テンプレート選択・組み合わせ画面

```
┌─────────────────────────────────────────────────────────────┐
│ ポリシー作成 - 見積管理 編集                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 基本設定                                                    │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ ポリシー名: [営業部の見積編集制限                    ] │ │
│ │ 説明: [営業部は自部署の見積のみ編集可能              ] │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 制限条件の組み合わせ                                        │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ カテゴリ: [すべて ▼] [部署・組織] [データ属性] [時間・環境] │ │
│ │                                                         │ │
│ │ 利用可能なテンプレート:                                 │ │
│ │ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ │ │
│ │ │ 自部署制限       │ │ 作成者制限       │ │ 金額上限制限     │ │ │
│ │ │                 │ │                 │ │                 │ │ │
│ │ │ 自分の部署の     │ │ 自分が作成した   │ │ 指定金額以下の   │ │ │
│ │ │ データのみ       │ │ データのみ       │ │ データのみ       │ │ │
│ │ │                 │ │                 │ │                 │ │ │
│ │ │ [追加]          │ │ [追加]          │ │ [追加]          │ │ │
│ │ └─────────────────┘ └─────────────────┘ └─────────────────┘ │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 選択された制限条件:                                         │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ ✅ 自部署制限                                           │ │
│ │    → data.department_id = user.department_id            │ │
│ │    [削除]                                               │ │
│ │                                                         │ │
│ │ ✅ 作成者制限                                           │ │
│ │    → data.created_by = user.id                          │ │
│ │    [削除]                                               │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 効果: [許可 ▼] 優先度: [50] 状態: [アクティブ]             │
│                                                             │
│                                    [キャンセル]    [作成]   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2. テンプレートパラメータ設定画面

```
┌─────────────────────────────────────────────────────────────┐
│ テンプレート設定 - 金額上限制限                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ テンプレート情報                                            │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 名前: 金額上限制限                                       │ │
│ │ 説明: 指定金額以下のデータのみアクセス可能               │ │
│ │ カテゴリ: データ属性                                     │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ パラメータ設定                                              │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 金額上限: [1000000] 円                                  │ │
│ │ 説明: この金額以下のデータのみアクセス可能になります     │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 生成される条件式                                            │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ data.amount <= 1000000                                  │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│                                    [キャンセル]    [適用]   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 組み合わせの仕組み

### 1. 条件式の合成

複数のテンプレートを組み合わせると、条件式は自動的にAND結合されます：

#### 例：見積編集ポリシー
**選択したテンプレート:**
- 自部署制限
- 作成者制限
- ステータス制限

**生成される条件式:**
```json
{
  "operator": "and",
  "rules": [
    {
      "field": "data.department_id",
      "operator": "eq",
      "value": "user.department_id"
    },
    {
      "field": "data.created_by",
      "operator": "eq",
      "value": "user.id"
    },
    {
      "field": "data.status",
      "operator": "in",
      "value": ["draft", "pending_approval"]
    }
  ]
}
```

**結果:** 「自分の部署の、自分が作成した、草案または承認待ちの見積のみ編集可能」

### 2. テンプレートの互換性チェック

組み合わせ時に以下のチェックを実行：

#### 必須フィールドの確認
```json
{
  "自部署制限": {
    "required_fields": ["data.department_id", "user.department_id"]
  },
  "作成者制限": {
    "required_fields": ["data.created_by", "user.id"]
  }
}
```

#### 適用可能アクションの確認
```json
{
  "自部署制限": {
    "applicable_actions": ["view", "list", "edit", "approve"]
  },
  "金額上限制限": {
    "applicable_actions": ["approve", "edit"]
  }
}
```

### 3. 実装例

#### 見積管理での具体的な組み合わせ例

**シナリオ1: 営業部の見積編集制限**
- テンプレート: 自部署制限 + 作成者制限
- 結果: 営業部は自分の部署の、自分が作成した見積のみ編集可能

**シナリオ2: 課長の承認制限**
- テンプレート: 自部署制限 + 金額上限制限 + 職位制限
- 結果: 課長は自分の部署の、100万円以下の見積のみ承認可能

**シナリオ3: 経理部の閲覧制限**
- テンプレート: 特定部署制限 + 営業時間制限
- 結果: 経理部は特定部署の見積を営業時間内のみ閲覧可能

## 実装計画

### Phase 1: 最小単位テンプレート機能
1. **データベース設計とマイグレーション**
   - `policy_condition_templates`テーブルの作成
   - 標準装備テンプレートのシーダー作成

2. **バックエンドAPI実装**
   - テンプレート一覧取得API
   - テンプレート組み合わせからポリシー作成API
   - テンプレート互換性チェックAPI

3. **フロントエンド実装**
   - テンプレート選択・組み合わせUI
   - パラメータ設定UI
   - 条件式プレビュー機能
   - 既存ポリシー管理画面への統合

### Phase 2: 高度なテンプレート機能
1. **テンプレート管理機能**
   - カスタムテンプレート作成
   - テンプレートの編集・削除
   - テンプレートのインポート・エクスポート

2. **条件式ビルダー**
   - 視覚的な条件式作成UI
   - テンプレートの条件式を動的にカスタマイズ

3. **テンプレート共有機能**
   - 組織内でのテンプレート共有
   - テンプレートのバージョン管理

## 標準装備テンプレート一覧

### 初期リリースで提供するテンプレート

#### 部署・組織関連（3種類）
- 自部署制限
- 自部署以下制限  
- 特定部署制限

#### 職位・権限関連（3種類）
- 課長以上制限
- 部長以上制限
- 特定職位制限

#### データ属性関連（4種類）
- 金額上限制限
- 金額範囲制限
- ステータス制限
- 作成者制限

#### 時間・環境関連（3種類）
- 営業時間制限
- 平日制限
- 社内IP制限

**合計: 13種類の標準装備テンプレート**

### カスタマイズ対応

標準装備で対応できない特殊な要件については、個別にカスタムテンプレートを作成します。

## テンプレート作成ガイドライン

### 1. 命名規則
- **日本語で分かりやすい名前**: 「自部署のみ閲覧」「金額制限承認」など
- **ビジネス要件を表現**: 技術的な詳細ではなく、業務上の制限を表現
- **一意性の確保**: 同じカテゴリ内で重複しない名前

### 2. 説明文の書き方
- **目的を明確に**: なぜこの制限が必要なのか
- **適用範囲を明示**: どのような場面で使用するか
- **注意事項**: 使用時の注意点や制限事項

### 3. カテゴリ分類
- **部署制限**: 部署単位でのアクセス制限
- **職位制限**: 職位に基づく権限制限
- **金額制限**: 金額に基づく承認制限
- **時間制限**: 時間帯や期間に基づく制限
- **ステータス制限**: データの状態に基づく制限
- **作成者制限**: 作成者に基づく制限

### 4. タグ付け
- **検索性向上**: 関連するタグを付与
- **グループ化**: 似たようなテンプレートをグループ化
- **例**: `["営業", "見積", "部署制限"]`, `["承認", "金額", "課長"]`

## 運用方針

### 1. テンプレートの管理
- **システムテンプレート**: システム管理者のみ編集可能
- **カスタムテンプレート**: 組織管理者が作成・編集可能
- **バージョン管理**: テンプレートの変更履歴を記録

### 2. 品質管理
- **テスト環境での検証**: 本番適用前にテスト環境で動作確認
- **ドキュメント整備**: 各テンプレートの使用方法を文書化
- **定期的な見直し**: ビジネス要件の変更に応じてテンプレートを更新

### 3. ユーザーサポート
- **操作ガイド**: テンプレートの使用方法を説明
- **FAQ**: よくある質問と回答を整備
- **サポート体制**: テンプレート使用時のサポート体制

## 成功指標

### 1. 利用状況
- **テンプレート使用率**: 新規ポリシー作成時のテンプレート使用率
- **作成時間短縮**: ポリシー作成にかかる時間の短縮
- **エラー率低下**: 手動作成時の設定ミスの減少

### 2. ユーザビリティ
- **満足度調査**: 管理者のテンプレート機能に対する満足度
- **学習時間**: 新規ユーザーの習得時間
- **サポート問い合わせ**: テンプレート関連の問い合わせ件数

### 3. 保守性
- **テンプレート更新頻度**: ビジネス要件変更に応じた更新
- **再利用率**: 同じテンプレートの再利用回数
- **カスタマイズ率**: テンプレートをベースにしたカスタマイズの割合

この仕様書に基づいて、段階的にテンプレート機能を実装していきます。
