## ABACの設定について設計検討

### ABACポリシー画面のイメージ

対象業務（resource_type）とアクション（action）を選択
　例：見積 × 閲覧(list) / 見積 × 承認(approve) など

対象者を選ぶ（付与先）
　部署・役割・職位・個人ユーザ

scope（許容集合）を選択
　- 自分のみ（self）
　- 自部署のみ（department:selfDept）
　- プロジェクトを指定（project:IN)
　- 組織全体（organization）

条件（condition）を追加
　- 金額：amount ≤ 1,000,000
　- ステータス：status IN['承認済み','承認依頼中']
　- 承認ステップ：approval_step = 1
　- 時間帯：time BETWEEN 09:00–17:00 など

プレビュー／確認
　- 合成後にどのデータが対象になるかを確認できるテストモードを付けると運用が安心


※ABAC は「条件式の組み合わせ」でポリシーを作るので、
ユーザーにSQLのWHERE句を直接書かせないUI が必要


## UI設計のコツ

・プルダウン＋条件入力式 にして SQL を隠蔽

・テンプレート化された条件ブロック を用意する（例：「自部署のみ」「自分が作成」「金額条件」）

・初期段階では 管理者のみ設定可能 にする方が安全

・監査対応として「いつ誰がポリシーを変更したか」の履歴を残す



### 実装ステップ例

AccessPolicy テーブルを用意（resource_type / action / scope / condition / attached_to）

API：ポリシー CRUD と評価用エンドポイントを実装

管理画面（UI）：上記5ステップをウィザード形式で

一覧・詳細画面の検索や操作ボタンに ABAC 判定ロジックを組み込み


### 構造イメージ

AccessPolicy テーブル例

カラム名	                型	            説明
id      	            PK  	        ポリシーID
title                   text            タイトル名称
resource_type	        text    	    見積、請求、勤怠 などの業務リソース
action	                text	        list / read / edit / approve などの操作
scope	                jsonb / text	許容集合（例：{"department":"selfDept"}）
condition	            jsonb / text	条件式（例：{"amount":{"lte":1000000},"status":["承認済み","承認依頼中"]}）
attached_to_type	    enum	        部署 / 役割 / 職位 / 権限レベル / 個別ユーザ
attached_to_id	        uuid	        付与先のID
enabled	                boolean	        有効/無効
valid_from / valid_to	timestamp   	適用期間
created_by / updated_by	uuid	        設定した管理者
created_at / updated_at	timestamp	    作成・更新日時

※ 補足
・scope や condition は JSON 形式にして、UI 側でテンプレートを編集できるようにすると柔軟です。
・attached_to_type は ENUM にして ['department','role','position','level','user'] のように管理すると良いです。
・同じポリシーでも 複数の付与先に適用したい場合はレコードを分けて複数行登録する 方がシンプルです。
・ユーザが複数のポリシーに該当する場合は、それらの scope∩・condition∧ を合成して最終判定します。



### 「Permitしか無い」構造の違い
	                            RBAC	                            ABAC
・判定レイヤー　	    機能レベル（ボタン/エンドポイント）	     データレベル（レコードのフィルタ）
・判定材料      　  	ロール・部署・ユーザ                    ユーザ属性 × データ属性 × 環境属性
・デフォルト動作　　	 Permitが無い → 入口に入れない	        条件に合わない → レコードに触れない
・Denyの必要性	    　　無し（付与されない＝使えない）	　　　　　無し（条件を満たさない＝触れない）


1️⃣ RBAC の Permit

- 目的：機能（アクション）そのものを使えるかを判定

- 単位：resource_type × action

  例：estimate.view / estimate.edit / estimate.approve

  Permit の意味：
   → その機能ボタン／APIを使う入口の鍵を持っている

- Deny は通常不要（付与しない＝使えない）

- 付与先：ロール・部署・ユーザ など

   例：

    estimate.approve が付与されていなければ、承認ボタン自体が表示されない／押せない

    👉 RBAC = 「ドアの鍵を持っているか」


2️⃣ ABAC（AccessPolicy）の Permit

- 目的：その機能を持っているユーザが、どのレコードに対して許されるかを条件で判定

- 単位：resource_type × action × 条件(scope / condition)

  例：

  estimate.approve のうち
  department_id = user.department_id AND total_amount ≤ 1,000,000

- Permit の意味：
  → 指定された条件を満たすレコードにだけ “使ってよい” と宣言

- Deny は不要
  → 条件を満たさないレコードはデフォルト拒否されるため

- 付与先：部署・役職・個人 など

  例：

  課長は estimate.approve 権限を持っていても、
  100万円超のレコードは条件を満たさないため承認不可

  👉 ABAC = 「部屋の中のどの棚を開けてよいか」



## ABAC の AccessPolicy は「どのデータへのどんな種類の操作を許すか」を条件付きで設定できる仕組みです。

一覧閲覧（list）のほかにも、業務上よく使うさまざまなアクセス種類を制御対象にできます。

🔑 ABACで制御できる主な「アクセス種類」

AccessPolicy の action カラムに指定するイメージです。

アクセス種類 (action)	            用途例	                        ABACでの制御ポイント
list（一覧表示）        	    画面やAPIでレコード一覧を取得	     検索結果をユーザ属性・データ属性でフィルタ（例：自部署の見積のみ表示）
read / view（詳細閲覧）	      1件のレコードを開いて参照	         Confidentialタグや部署で閲覧可否を制限
create（作成）	              新規レコード登録	                作成先プロジェクトや顧客の制限（例：特定プロジェクトのみ作成可）
update / edit（編集）       	既存レコードの更新	               承認済みは編集不可、自分が作成したもののみ可 など
delete / soft_delete（削除）	レコード削除                    	管理者のみ許可、承認済みは削除不可 など
approve / return /
 reject / cancel（承認系）	  承認フローの操作	                金額しきい値・承認ステップ・自部署の案件のみ など
export / download / print	   CSVエクスポートや印刷出力	        機密案件はダウンロード不可 など
share / visibility_change	   外部共有・公開範囲変更	            権限を持つ部門だけ共有可能 など
archive / restore	           アーカイブ化や復元	                過去年度データを経理部のみ参照 など
audit.read / history.read    監査ログや履歴の閲覧	              監査ロールだけ許可 など

🌟 見積モジュールでの具体例

一覧閲覧（list）
　営業は自部署の見積だけ表示、経理は承認済みのみ表示
　scope=department:selfDept, condition=status IN['approved','requesting']

詳細閲覧（read）
　Confidential案件は管理職以上のみ
　condition=visibility IN['public','internal']

編集（update）
　承認済みは編集不可、自分が作成した草案のみ編集可
　condition=status='draft' AND created_by=user.id

承認（approve）
　課長は100万以下のみ、自部署のみ
　scope=department:selfDept, condition=total_amount<=1000000

エクスポート（export）
　承認済みデータだけCSV出力可
　condition=status='approved'

🔎 まとめ

ABAC は「一覧」「詳細」「編集」「削除」「承認」「エクスポート」などデータに対するあらゆる操作に対して設定可能。

特に業務システムでは list と read のフィルタリングがもっとも効果的で、表示段階で不要データを除外できます。

action を適切に設計しておくと、モジュールごとに再利用しやすくなります。

👉 一覧制限は入り口に過ぎず、あらゆるアクションを条件で細かく制御できるのが ABAC の強みです。


## 複数の組み合わせを表現できる

  AccessPolicy の scope と condition を組み合わせることで、複数の条件を表現できます。

📝 例：見積の削除ルール

要件：

管理者はすべて削除できる

作成者本人は status='draft' のときのみ削除可

承認済み(status='approved')は誰も削除不可

1. 管理者向けポリシー
カラム	値
resource_type	estimate
action	delete
scope	organization（全体）
condition	status != 'approved'
attached_to_type	role
attached_to_id	uuid(管理者ロール)
enabled	true

👉 管理者は承認済み以外のレコードを削除できる

2. 作成者向けポリシー
カラム	値
resource_type	estimate
action	delete
scope	self（自分が作成したレコード）
condition	status = 'draft'
attached_to_type	user（または全ユーザ共通なら全体ロール）
attached_to_id	ALL など
enabled	true

👉 作成者は自分の草案のみ削除できる

3. 承認済みの扱い

どのポリシーにも status='approved' を許容条件に含めていないため、
👉 承認済みは どのユーザでも削除不可（デフォルト拒否）

🔑 複数ポリシーの評価方法

ユーザに適用されるすべてのポリシーを取得

scope は合成（交差 ∩）し、condition は論理積（AND）

少なくとも 1 つのポリシーがレコードを包含していれば許可
　※今回の例では 作成者ポリシー OR 管理者ポリシー でカバー

💡 実装メモ

OR 条件を作るには → 複数ポリシーとして登録し、評価時に「いずれか満たせばOK」 とする

AND 条件を作るには → 同じポリシー内の condition に複数条件を書く

✅ まとめ

AccessPolicy はレコード削除などにも柔軟に対応できます。

管理者用ポリシー

作成者用ポリシー
のように複数行登録すれば OR 条件が実現でき、
さらに各ポリシー内で AND 条件を組み合わせて詳細な制約を記述できます。


## 既存RBACシステムとの統合方針

### 現状の権限管理システム

#### 5階層のRBACシステム
```
ユーザー最終権限 = システム権限レベル + 役割 + 部署 + 職位 + 個別権限
```

**階層構造**:
- **システム権限レベル**: 組織階層的な基本権限（staff, manager, admin等）
- **役割**: 機能特化型権限（user_management, estimate_management等）
- **部署**: 部署固有権限
- **職位**: 職位固有権限（director, department_manager, section_chief, staff, employee）
- **個別権限**: 特定ユーザーの特別権限

#### 権限の命名規則
```
{module}.{action}[.{sub_action}]
```

**現在の権限例**:
- `estimate.view` - 見積閲覧
- `estimate.create` - 見積作成
- `estimate.edit` - 見積編集
- `estimate.approval.request` - 承認依頼作成
- `estimate.approval.approve` - 承認
- `estimate.approval.reject` - 却下
- `estimate.approval.return` - 差し戻し

#### ビジネスコードベースの権限管理
- **システム固定コード**: `role`, `department`, `system`, `approval`, `employee`, `partner`
- **ビジネスロジックコード**: `estimate`, `budget`, `purchase`, `construction`, `general`

### ABAC導入時の統合アーキテクチャ

#### 権限管理の役割分担
```
既存RBAC: ユーザー → 操作権限（estimate.view, estimate.create等）
新規ABAC: ユーザー + データ条件 → レコードアクセス権限
```

#### 統合権限チェックロジック
```php
// 権限チェックの統合ロジック
public function canAccess($user, $action, $resource = null, $data = null) {
    // 1. RBACチェック（既存）
    if (!$this->hasRBACPermission($user, $action)) {
        return false;
    }
    
    // 2. ABACチェック（新規）
    if ($resource && $data) {
        return $this->evaluateABACPolicy($user, $action, $resource, $data);
    }
    
    return true;
}
```

### 段階的導入計画

#### Phase 1: 既存RBAC維持 + ABAC追加
- **目的**: 既存システムへの影響を最小限に抑える
- **実装**: RBACとABACの並行運用
- **対象**: 新規機能やデータフィルタリングが必要な機能

#### Phase 2: データフィルタリング機能のABAC化
- **目的**: 一覧表示や検索結果のフィルタリングをABACで実装
- **実装**: 既存のデータアクセス制御をABACに移行
- **対象**: 見積一覧、承認依頼一覧等のデータ表示機能

#### Phase 3: 必要に応じた既存RBACの移行
- **目的**: より柔軟な権限制御が必要な機能をABACに移行
- **実装**: 段階的にRBACからABACへの移行
- **対象**: 複雑な条件分岐が必要な承認フロー等

### 実装時の考慮事項

#### 1. 既存システムとの互換性
- 既存の権限チェックロジックを維持
- 新規ABAC機能は既存システムに影響を与えない
- 段階的な移行によりリスクを最小化

#### 2. パフォーマンス最適化
- 権限チェックのキャッシュ機能
- 大量ポリシーでの評価最適化
- データベースクエリの効率化

#### 3. 運用面での配慮
- 管理者のみがポリシー設定可能
- 変更履歴の詳細な記録
- テスト環境での事前検証機能

### まとめ

ABACの導入により、既存のRBACシステムを補完する形で、より柔軟で細かいデータアクセス制御が可能になります。段階的な導入により、既存システムへの影響を最小限に抑えながら、業務要件に応じた権限管理の実現を目指します。

## RBACからABACへの移行事例

### 移行対象の判断基準

#### 移行対象となるRBAC権限
以下のような「データの内容によって権限を変えたい」ケースが移行対象です：

**移行対象の例**:
- `estimate.approve` - 金額によって承認権限を制限したい
- `estimate.view` - 部署によって見積データの表示範囲を制限したい
- `estimate.edit` - ステータスによって編集権限を制限したい

**移行対象外の例**:
- `system.admin` - システム管理権限（データに依存しない）
- `user.create` - ユーザー作成権限（データに依存しない）

### 承認フローでのABAC移行事例

#### 移行前（RBAC）:
```php
// 現在の実装
if ($user->hasPermission('estimate.approve')) {
    // 承認ボタン表示
    // 承認処理実行
}

// 承認ステップでの権限設定
'available_permissions' => ['estimate.approval.approve']
// → 承認権限を持つユーザーは全ての見積を承認可能
```

#### 移行後（ABAC）:
```php
// 新しい実装
if ($this->canAccess($user, 'approve', 'estimate', $estimateData)) {
    // 承認ボタン表示
    // 承認処理実行
}

// 承認ステップでのABACポリシー設定
'available_permissions' => ['estimate.approval.approve'],
'abac_policies' => [
    [
        'attached_to_type' => 'position',
        'attached_to_id' => 'section_chief', // 課長
        'condition' => [
            'amount' => ['lte' => 1000000] // 100万円以下
        ]
    ],
    [
        'attached_to_type' => 'position', 
        'attached_to_id' => 'department_manager', // 部長
        'condition' => [
            'amount' => ['lte' => 10000000] // 1000万円以下
        ]
    ],
    [
        'attached_to_type' => 'position',
        'attached_to_id' => 'director', // 取締役
        'condition' => [] // 制限なし
    ]
]
```

### 具体的な実装例

#### 1. 見積承認フローのABAC設定例
```json
{
  "approval_steps": [
    {
      "step_number": 1,
      "name": "課長承認",
      "approvers": [
        {"type": "position", "value": "section_chief"}
      ],
      "available_permissions": ["estimate.approval.approve"],
      "abac_policies": [
        {
          "attached_to_type": "position",
          "attached_to_id": "section_chief",
          "condition": {
            "amount": {"lte": 1000000}
          }
        }
      ]
    },
    {
      "step_number": 2,
      "name": "部長承認", 
      "approvers": [
        {"type": "position", "value": "department_manager"}
      ],
      "available_permissions": ["estimate.approval.approve"],
      "abac_policies": [
        {
          "attached_to_type": "position",
          "attached_to_id": "department_manager", 
          "condition": {
            "amount": {"lte": 10000000}
          }
        }
      ]
    }
  ]
}
```

#### 2. 承認フローでのABAC評価ロジック
```php
// 承認フローでの権限チェック
private function canApproveStep(array $step, $user, $estimateData)
{
    // 1. 承認者として指定されているかチェック
    if (!$this->isApprover($user, $step)) {
        return false;
    }

    // 2. ABACポリシーでの条件チェック
    if (isset($step['abac_policies'])) {
        return $this->evaluateABACPolicy($user, $step['abac_policies'], $estimateData);
    }

    // 3. 従来のRBACチェック（フォールバック）
    return $this->checkRBACPermission($user, $step['available_permissions']);
}

// ABACポリシー評価
private function evaluateABACPolicy($user, $policies, $data)
{
    foreach ($policies as $policy) {
        // ユーザーがポリシーの対象かチェック
        if ($this->matchesPolicyTarget($user, $policy)) {
            // 条件を満たすかチェック
            if ($this->evaluateCondition($policy['condition'], $data)) {
                return true;
            }
        }
    }
    return false;
}
```

#### 3. 段階的移行の実装
```php
// 移行対象の権限を特定
$migratedPermissions = [
    'estimate.approve',
    'estimate.view',
    'budget.approve'
];

public function canAccess($user, $action, $resource, $data) {
    $permission = "{$resource}.{$action}";
    
    // 移行済み権限はABACで判定
    if (in_array($permission, $this->migratedPermissions)) {
        return $this->evaluateABACPolicy($user, $action, $resource, $data);
    }
    
    // 未移行権限はRBACで判定
    return $user->hasPermission($permission);
}
```

### 移行の効果

#### 移行前（RBAC）:
- 課長は「見積承認権限」を持つ
- すべての見積を承認可能

#### 移行後（ABAC）:
- 課長は「100万円以下の見積のみ承認可能」
- 100万円超の見積は承認不可
- より細かい条件での権限制御が可能

### 承認フローでのABACの利点

1. **金額による承認権限制御**: 職位に応じた承認金額上限の設定
2. **部署による承認範囲制御**: 自部署の案件のみ承認可能
3. **ステータスによる承認制御**: 特定ステータスの案件のみ承認可能
4. **時間による承認制御**: 営業時間内のみ承認可能

### 移行の判断フロー

```
移行対象 = データの内容によって権限を変えたい権限

例:
✅ estimate.approve → 金額によって承認可能/不可を制御
✅ estimate.view → 部署によって表示範囲を制御
✅ budget.edit → ステータスによって編集可能/不可を制御
❌ system.admin → システム管理権限（データに依存しない）
❌ user.create → ユーザー作成権限（データに依存しない）
```

### 移行の優先順位

```
優先度1: 業務上重要な権限（承認、編集等）
優先度2: データ表示に関する権限（一覧、詳細等）
優先度3: その他の権限
```

承認フローでのABAC適用により、従来の「承認権限を持つユーザーは全て承認可能」から、「承認権限を持つユーザーでも、条件を満たす案件のみ承認可能」という、より細かい権限制御が実現できます。これにより、組織の承認ルールをより正確にシステムに反映させることが可能になります。

## ビジネスコードベースのABAC管理画面設計

### 設計方針

#### 1. **ビジネスコードにAccessPolicyを紐づける**

データアクセス制限という観点から、**ビジネスコード（業務データ）にAccessPolicyを紐づける**設計を採用します。これにより、データの特性に応じた柔軟な条件設定が可能になります。

#### 2. **管理画面の統合方針**

既存のビジネスコード管理画面にABACポリシー設定機能を追加し、ビジネスコードごとのデータアクセス制御を一元管理します。

### 具体的な実装設計

#### 1. **ビジネスコード管理画面でのABAC設定**

```typescript
// BusinessCodeManagement.tsx
<Card>
  <CardHeader>
    <CardTitle>見積管理 (estimate)</CardTitle>
  </CardHeader>
  <CardContent>
    {/* 既存の権限設定 */}
    <div className="mb-4">
      <h4>基本権限設定</h4>
      {/* estimate.view, estimate.create, estimate.edit 等 */}
    </div>
    
    {/* 新規追加: ABACポリシー設定 */}
    <div>
      <h4>データアクセス制御ポリシー</h4>
      <ABACPolicySettings 
        businessCode="estimate"
        resourceType="estimate"
      />
    </div>
  </CardContent>
</Card>
```

#### 2. **ABACポリシー設定コンポーネント**

```typescript
// ABACPolicySettings.tsx
interface ABACPolicySettingsProps {
  businessCode: string // 'estimate', 'budget', 'purchase' 等
  resourceType: string // リソースタイプ
}

export default function ABACPolicySettings({ businessCode, resourceType }: ABACPolicySettingsProps) {
  return (
    <div className="space-y-4">
      {/* アクション別のポリシー設定 */}
      <div>
        <h5 className="font-medium mb-2">一覧表示 (list) の制御</h5>
        <ABACPolicyList 
          businessCode={businessCode}
          action="list"
          resourceType={resourceType}
        />
      </div>
      
      <div>
        <h5 className="font-medium mb-2">詳細閲覧 (read) の制御</h5>
        <ABACPolicyList 
          businessCode={businessCode}
          action="read"
          resourceType={resourceType}
        />
      </div>
      
      <div>
        <h5 className="font-medium mb-2">編集 (edit) の制御</h5>
        <ABACPolicyList 
          businessCode={businessCode}
          action="edit"
          resourceType={resourceType}
        />
      </div>
      
      <div>
        <h5 className="font-medium mb-2">承認 (approve) の制御</h5>
        <ABACPolicyList 
          businessCode={businessCode}
          action="approve"
          resourceType={resourceType}
        />
      </div>
    </div>
  )
}
```

### ビジネスコードごとのABACポリシー設定例

#### 見積管理でのABACポリシー設定

```json
{
  "business_code": "estimate",
  "resource_type": "estimate",
  "policies": [
    {
      "action": "list",
      "title": "営業部は自部署の見積のみ表示",
      "scope": {"department": "selfDept"},
      "condition": {},
      "attached_to_type": "department",
      "attached_to_id": "sales_department"
    },
    {
      "action": "approve",
      "title": "課長は100万円以下の見積のみ承認可能",
      "scope": {},
      "condition": {"amount": {"lte": 1000000}},
      "attached_to_type": "position",
      "attached_to_id": "section_chief"
    },
    {
      "action": "edit",
      "title": "作成者は草案のみ編集可能",
      "scope": {"self": true},
      "condition": {"status": "draft"},
      "attached_to_type": "user",
      "attached_to_id": "ALL"
    }
  ]
}
```

#### 予算管理でのABACポリシー設定

```json
{
  "business_code": "budget",
  "resource_type": "budget",
  "policies": [
    {
      "action": "list",
      "title": "経理部は全予算を表示、他部署は自部署のみ",
      "scope": {"department": "selfDept"},
      "condition": {},
      "attached_to_type": "department",
      "attached_to_id": "accounting_department"
    },
    {
      "action": "approve",
      "title": "部長は500万円以下の予算のみ承認可能",
      "scope": {},
      "condition": {"amount": {"lte": 5000000}},
      "attached_to_type": "position",
      "attached_to_id": "department_manager"
    }
  ]
}
```

### 管理画面の操作フロー

#### 1. **ビジネスコード選択 → ABACポリシー設定**

```
1. ビジネスコード一覧から「見積管理」を選択
2. 基本権限設定（既存）
   - estimate.view, estimate.create, estimate.edit 等
3. ABACポリシー設定（新規追加）
   - 一覧表示の制御
   - 詳細閲覧の制御
   - 編集の制御
   - 承認の制御
```

#### 2. **アクション別ポリシー設定**

各アクション（list, read, edit, approve等）に対して、以下の設定が可能：

- **付与先設定**: システム権限レベル、役割、職位、部署、個別ユーザー
- **スコープ設定**: self, department:selfDept, project:IN, organization
- **条件設定**: 金額、ステータス、時間帯等の条件式

### この設計の利点

#### 1. **データ中心の設計**
- ビジネスコード（業務データ）に特化した制御
- データの特性に応じた柔軟な条件設定
- 業務要件に直結した権限管理

#### 2. **直感的な管理**
- 「見積データのアクセス制御」として理解しやすい
- ビジネスコードごとに独立したポリシー管理
- 既存のビジネスコード管理画面との一貫性

#### 3. **拡張性**
- 新しいビジネスコード追加時にABACポリシーも同時に設定
- ビジネスコード固有の条件を柔軟に設定可能
- 将来的な業務要件変更に対応しやすい

#### 4. **運用面での配慮**
- 管理者がビジネスコードごとに権限を管理
- データの特性に応じた適切な制御設定
- 業務フローに沿った権限管理

### 実装の優先順位

#### Phase 1: ビジネスコード管理画面への統合
- 既存のビジネスコード管理画面にABACポリシー設定機能を追加
- 基本的なポリシー作成・編集・削除機能

#### Phase 2: アクション別ポリシー設定の詳細化
- 各アクション（list, read, edit, approve等）の詳細設定
- 条件式の柔軟な設定機能

#### Phase 3: 高度な機能の追加
- ポリシーテンプレート機能
- 一括設定機能
- ポリシー適用状況の確認機能

### まとめ

ビジネスコードベースのABAC設計により、データ中心のアクセス制御が実現できます。既存のビジネスコード管理画面に統合することで、管理者が直感的にデータアクセス制御を設定でき、業務要件に応じた柔軟な権限管理が可能になります。

## ABAC設定画面のUI設計仕様

### 画面構成

#### 1. **権限管理ページのタブ構成**
```
┌─────────────────────────────────────────────────────────────┐
│ 権限管理                                                      │
├─────────────────────────────────────────────────────────────┤
│ [ビジネスコード] [システム権限レベル] [役割] [部署権限] [職位権限] [ユーザー権限] [ABACポリシー] [権限階層表示] │
└─────────────────────────────────────────────────────────────┘
```

#### 2. **ABACポリシー管理画面の全体構成**
```
┌─────────────────────────────────────────────────────────────┐
│ ABACポリシー管理                                    [+ 新規ポリシー作成] │
│ データアクセス制御ポリシーの設定を行います                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ビジネスコード選択                                           │
│ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐           │
│ │ 📊  │ │ 💰  │ │ 🛒  │ │ 🔨  │ │ 📋  │ │ ⚙️  │           │
│ │見積 │ │予算 │ │発注 │ │工事 │ │一般 │ │その他│           │
│ │管理 │ │管理 │ │管理 │ │管理 │ │業務 │ │     │           │
│ └─────┘ └─────┘ └─────┘ └─────┘ └─────┘ └─────┘           │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ アクション選択                                               │
│ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐                   │
│ │ 👁️  │ │ ✏️  │ │ ✅  │ │ 📤  │ │ 🗑️  │                   │
│ │一覧 │ │編集 │ │承認 │ │出力 │ │削除 │                   │
│ │表示 │ │    │ │    │ │    │ │    │                   │
│ └─────┘ └─────┘ └─────┘ └─────┘ └─────┘                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### ポリシー作成・編集のウィザード設計

#### 1. **ステップインジケータとナビゲーション**

**設計意図**: 上位設定によって下位の選択肢が変わるため、段階的な設定が必要

**依存関係**:
```
ステップ1: ビジネスコード選択
    ↓
ステップ2: アクション選択（ビジネスコードに依存）
    ↓
ステップ3: 付与先設定（アクションに依存）
    ↓
ステップ4: スコープ・条件設定（付与先タイプに依存）
```

#### 2. **ポリシー作成ウィザード（ステップ1: 基本情報）**
```
┌─────────────────────────────────────────────────────────────┐
│ 見積管理 - 一覧表示 ポリシー作成                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ●●●○  ← ステップインジケーター                              │
│                                                             │
│ 基本情報                                                    │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ ポリシー名: [課長は100万円以下の見積のみ承認可能        ] │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│                                    [戻る]        [次へ]     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 3. **ポリシー作成ウィザード（ステップ2: 付与先設定）**
```
┌─────────────────────────────────────────────────────────────┐
│ 見積管理 - 一覧表示 ポリシー作成                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ●●○○  ← ステップインジケーター                              │
│                                                             │
│ 付与先設定                                                  │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 付与先タイプ: [職位 ▼]                                  │ │
│ └─────────────────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 付与先: [課長 ▼]                                        │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│                                    [戻る]        [次へ]     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 4. **ポリシー作成ウィザード（ステップ3: スコープ設定）**
```
┌─────────────────────────────────────────────────────────────┐
│ 見積管理 - 一覧表示 ポリシー作成                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ●●●○  ← ステップインジケーター                              │
│                                                             │
│ スコープ設定                                                │
│ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           │
│ │ 👤      │ │ 🏢      │ │ 📁      │ │ 🌐      │           │
│ │自分のみ │ │自部署のみ│ │プロジェクト│ │組織全体 │           │
│ │自分が   │ │所属部署 │ │指定     │ │組織内の │           │
│ │作成した │ │のデータ │ │特定プロ │ │全データ │           │
│ │データ   │ │のみ     │ │ジェクト │ │        │           │
│ └─────────┘ └─────────┘ └─────────┘ └─────────┘           │
│                                                             │
│                                    [戻る]        [次へ]     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 5. **ポリシー作成ウィザード（ステップ4: 条件設定）**
```
┌─────────────────────────────────────────────────────────────┐
│ 見積管理 - 一覧表示 ポリシー作成                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ●●●●  ← ステップインジケーター                              │
│                                                             │
│ 条件設定                                                    │
│ データの条件を設定します。複数の条件は AND で結合されます。  │
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ [金額 ▼] [以下 ▼] [1000000]                    [🗑️]     │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ [+ 条件を追加]                                              │
│                                                             │
│                                    [戻る]        [保存]     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### ポリシー編集の操作設計

#### 1. **編集時のステップ移動**

**操作方法**: 画面下部の保存済みステップのタブをクリックして移動

```
┌─────────────────────────────────────────────────────────────┐
│ 見積管理 - 一覧表示 ポリシー編集                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ●●●○  ← 現在ステップ3（スコープ設定）                      │
│                                                             │
│ スコープ設定                                                │
│ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           │
│ │ 👤      │ │ 🏢      │ │ 📁      │ │ 🌐      │           │
│ │自分のみ │ │自部署のみ│ │プロジェクト│ │組織全体 │           │
│ └─────────┘ └─────────┘ └─────────┘ └─────────┘           │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│ 保存済み設定内容:                                           │
│                                                             │
│ [基本情報] [付与先設定] [スコープ設定] [条件設定]           │
│    ↑           ↑           ↑           ↑                  │
│  クリック    クリック    クリック    クリック                │
│    ↓           ↓           ↓           ↓                  │
│ ステップ1   ステップ2   ステップ3   ステップ4                │
│                                                             │
│ ✅ 基本情報                                                 │
│ • ポリシー名: 課長は100万円以下の見積のみ承認可能          │
│                                                             │
│ ✅ 付与先設定                                               │
│ • 付与先タイプ: 職位                                        │
│ • 付与先: 課長                                              │
│                                                             │
│ 🔄 スコープ設定（編集中）                                   │
│ • スコープ: 未設定                                          │
│                                                             │
│ ⏸️ 条件設定（未設定）                                       │
│ • 条件: 未設定                                              │
│                                                             │
│                                    [キャンセル]    [保存]   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 2. **タブの状態表示**

**タブの視覚的状態**:
```
┌─────────────────────────────────────────────────────────────┐
│ 保存済み設定内容:                                           │
│                                                             │
│ [基本情報] [付与先設定] [スコープ設定] [条件設定]           │
│    ↑           ↑           ↑           ↑                  │
│ アクティブ   完了済み     編集中       未設定                │
│ (青背景)    (緑背景)     (黄背景)     (グレー背景)          │
│                                                             │
│ 状態の説明:                                                 │
│ • アクティブ: 現在編集中のステップ                          │
│ • 完了済み: 設定完了済みのステップ                          │
│ • 編集中: 設定中だが未完了のステップ                        │
│ • 未設定: まだ設定していないステップ                        │
│ • リセット: 上位変更によりリセット（赤背景）                │
└─────────────────────────────────────────────────────────────┘
```

#### 3. **上位設定変更時の下位リセット**

```
┌─────────────────────────────────────────────────────────────┐
│ 見積管理 - 一覧表示 ポリシー編集                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ⚠️ 付与先を変更しました。下位設定がリセットされます。        │
│                                                             │
│ 付与先設定                                                  │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 付与先タイプ: [職位 ▼]                                  │ │
│ └─────────────────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 付与先: [部長 ▼] ← 課長から部長に変更                  │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│ 保存済み設定内容:                                           │
│                                                             │
│ [基本情報] [付与先設定] [スコープ設定] [条件設定]           │
│    ↑           ↑           ↑           ↑                  │
│ アクティブ   リセット     リセット     リセット              │
│ (青背景)    (赤背景)     (赤背景)     (赤背景)              │
│                                                             │
│ ✅ 基本情報                                                 │
│ • ポリシー名: 課長は100万円以下の見積のみ承認可能          │
│                                                             │
│ 🔄 付与先設定（編集中）                                     │
│ • 付与先タイプ: 職位                                        │
│ • 付与先: 部長 ← 変更済み                                   │
│                                                             │
│ ❌ スコープ設定（上位変更によりリセット）                   │
│ • スコープ: 未設定                                          │
│                                                             │
│ ❌ 条件設定（上位変更によりリセット）                       │
│ • 条件: 未設定                                              │
│                                                             │
│                                    [キャンセル]    [保存]   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 途中登録と状態管理

#### 1. **途中登録時の表示**

```
┌─────────────────────────────────────────────────────────────┐
│ 見積管理 - 一覧表示 ポリシー作成                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ●●○○  ← ステップ2で停止（途中登録）                        │
│                                                             │
│ 基本情報 ✅                                                 │
│ 付与先設定 ✅                                               │
│ スコープ設定 ⏸️（未設定）                                   │
│ 条件設定 ⏸️（未設定）                                       │
│                                                             │
│ 現在の設定内容:                                             │
│ • ポリシー名: 課長の承認権限設定                            │
│ • 付与先: 課長                                              │
│ • スコープ: 未設定                                          │
│ • 条件: 未設定                                              │
│                                                             │
│                                    [続行]    [下書き保存]   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 2. **ポリシー一覧での途中登録表示**

```
┌─────────────────────────────────────────────────────────────┐
│ 見積管理 - 一覧表示 のポリシー一覧                    [+ ポリシー追加] │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 営業部は自部署の見積のみ表示                    [編集] [削除] │ │
│ │ 付与先: 営業部    スコープ: 自部署のみ    条件: なし        │ │
│ │ [有効]                                                      │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 課長の承認権限設定（下書き）                    [続行] [削除] │ │
│ │ 付与先: 課長      スコープ: 未設定        条件: 未設定      │ │
│ │ [下書き] ⚠️ 設定未完了                                    │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 操作の特徴

#### 1. **直感的な操作フロー**
- ビジネスコード選択 → アクション選択 → ポリシー一覧表示
- ウィザード形式でのポリシー作成
- 視覚的な条件設定

#### 2. **既存UIとの一貫性**
- 既存の権限管理ページのデザインパターンを踏襲
- カード形式のレイアウト
- 統一されたボタンとフォーム要素

#### 3. **依存関係の明確化**
- 上位設定が下位選択肢に与える影響が分かりやすい
- 設定順序の重要性を視覚的に表現
- 無効な組み合わせを事前に防ぐ

#### 4. **柔軟な編集操作**
- 任意のステップに直接移動可能
- 上位変更時は下位設定が自動的にリセット
- 進捗状況が視覚的に分かる

この設計により、管理者が直感的にABACポリシーを設定でき、既存の権限管理システムとの一貫性を保ちながら、柔軟なデータアクセス制御が実現できます。