# ABACポリシー管理 ハイブリッド型仕様書（非技術者向け）

## 概要

**技術者が不要なUI操作**を基本方針とし、画面からコードを書く操作を完全に排除したABACポリシー管理システム。

## 基本方針

### 1. **非技術者向けUI設計**
- コード記述を一切不要とする
- プルダウン選択とボタンクリックのみで操作
- 直感的な操作フローを提供

### 2. **コード記述の完全排除**
- JSON直接入力の禁止
- 条件式の手動記述の禁止
- テンプレートベースの設定のみ

### 3. **段階的設定の簡素化**
- 複雑なウィザード形式の排除
- シンプルなフォーム入力のみ
- 1画面での完結操作

## Phase 1: 非技術者向け基本機能

### 1.1 ビジネスコード選択式UI（現在の実装を維持）

```
┌─────────────────────────────────────────────────────────────┐
│ ABACポリシー管理                                    [+ 新規作成] │
│ データアクセス制御ポリシーの管理                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ビジネスコード選択                                           │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ ビジネスコード: [見積管理 ▼]                            │ │
│ │ 選択中: 見積管理                                        │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 見積管理 のポリシー一覧                                      │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 名前                │ アクション │ 効果 │ 優先度 │ 状態 │ 操作 │ │
│ │ 見積金額制限ポリシー │ 一覧表示   │ 拒否 │ 100   │ 有効 │ [編集] │ │
│ │ 部署別見積表示制限   │ 一覧表示   │ 拒否 │ 90    │ 有効 │ [編集] │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 テンプレートベースのポリシー作成

#### ポリシー作成方法の選択
```
┌─────────────────────────────────────────────────────────────┐
│ ポリシー作成方法を選択                                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 📄 テンプレートから作成                                 │ │
│ │ よく使われるパターンから選択して設定                     │ │
│ │ [選択]                                                  │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ ⚙️ カスタム設定                                         │ │
│ │ 独自の条件でポリシーを作成                               │ │
│ │ [選択]                                                  │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

#### テンプレート選択UI
```
┌─────────────────────────────────────────────────────────────┐
│ ポリシーテンプレート選択                                     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ よく使われる条件パターン:                                   │
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 🏢 部署別アクセス制限                                    │ │
│ │ 特定の部署のユーザーのみアクセス可能                     │ │
│ │ 適用例: 営業部は自部署の見積のみ表示                     │ │
│ │ [このテンプレートを使用]                                │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 💰 金額制限                                              │ │
│ │ 指定金額以上のデータへのアクセスを制限                   │ │
│ │ 適用例: 課長は100万円以下の見積のみ承認可能             │ │
│ │ [このテンプレートを使用]                                │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 👤 作成者権限                                            │ │
│ │ 作成者のみが編集可能                                     │ │
│ │ 適用例: 作成者は自分の見積のみ編集可能                   │ │
│ │ [このテンプレートを使用]                                │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 📊 ステータス別制限                                      │ │
│ │ 特定ステータスのデータへのアクセスを制限                 │ │
│ │ 適用例: 承認済み見積は編集不可                           │ │
│ │ [このテンプレートを使用]                                │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 1.3 テンプレートベースの設定フォーム

#### 部署別アクセス制限テンプレート
```
┌─────────────────────────────────────────────────────────────┐
│ 部署別アクセス制限ポリシー設定                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 基本情報                                                    │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ ポリシー名: [部署別見積表示制限                        ] │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 適用対象                                                    │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 対象部署: [営業部 ▼]                                    │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 制限内容                                                    │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ データアクセス範囲: [自部署のみ ▼]                      │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 効果                                                        │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ ポリシー効果: [拒否 ▼]                                  │ │
│ │ 説明: 条件に合わないデータへのアクセスを拒否します       │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 優先度                                                      │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 優先度: [高 ▼] (数値: 100)                              │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│                                    [キャンセル]    [保存]   │
└─────────────────────────────────────────────────────────────┘
```

#### 金額制限テンプレート
```
┌─────────────────────────────────────────────────────────────┐
│ 金額制限ポリシー設定                                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 基本情報                                                    │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ ポリシー名: [課長の承認金額制限                        ] │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 適用対象                                                    │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 対象職位: [課長 ▼]                                      │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 制限内容                                                    │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 金額条件: [以下 ▼] [1000000] 円                         │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 効果                                                        │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ ポリシー効果: [拒否 ▼]                                  │ │
│ │ 説明: 100万円を超える見積の承認を拒否します             │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 優先度                                                      │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 優先度: [高 ▼] (数値: 100)                              │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│                                    [キャンセル]    [保存]   │
└─────────────────────────────────────────────────────────────┘
```

### 1.4 カスタム設定（簡易版）

#### カスタム設定フォーム
```
┌─────────────────────────────────────────────────────────────┐
│ カスタムポリシー設定                                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 基本情報                                                    │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ ポリシー名: [カスタムポリシー                          ] │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 適用対象                                                    │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 対象タイプ: [職位 ▼]                                    │ │
│ │ 対象: [部長 ▼]                                          │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 条件設定（最大3つまで）                                     │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 条件1: [データ.金額 ▼] [より大きい ▼] [5000000] 円      │ │
│ │ [削除]                                                  │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ [+ 条件を追加]                                              │
│                                                             │
│ データアクセス範囲                                           │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ アクセス範囲: [組織全体 ▼]                              │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 効果                                                        │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ ポリシー効果: [拒否 ▼]                                  │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 優先度                                                      │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 優先度: [中 ▼] (数値: 50)                               │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│                                    [キャンセル]    [保存]   │
└─────────────────────────────────────────────────────────────┘
```

## Phase 2: 高度なテンプレート機能

### 2.1 業務別テンプレート

#### 見積管理専用テンプレート
```
┌─────────────────────────────────────────────────────────────┐
│ 見積管理専用テンプレート                                     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 📋 見積承認フロー                                        │ │
│ │ 職位に応じた承認金額上限の設定                           │ │
│ │ [使用する]                                              │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 🏢 部署別見積管理                                        │ │
│ │ 部署ごとの見積データ管理権限                             │ │
│ │ [使用する]                                              │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 📊 見積ステータス管理                                    │ │
│ │ ステータスに応じた操作権限の制御                         │ │
│ │ [使用する]                                              │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 一括設定機能

#### 職位別一括設定
```
┌─────────────────────────────────────────────────────────────┐
│ 職位別一括設定                                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 対象職位: [課長 ▼] [部長 ▼] [取締役 ▼]                    │
│                                                             │
│ 設定内容                                                    │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 承認金額上限:                                           │ │
│ │ 課長: [1000000] 円                                      │ │
│ │ 部長: [10000000] 円                                     │ │
│ │ 取締役: [制限なし ▼]                                    │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 適用するビジネスコード                                       │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ ☑️ 見積管理  ☑️ 予算管理  ☐ 発注管理                   │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│                                    [キャンセル]    [一括設定] │
└─────────────────────────────────────────────────────────────┘
```

## Phase 3: 運用支援機能

### 3.1 ポリシー適用状況の確認

#### 簡易テスト機能
```
┌─────────────────────────────────────────────────────────────┐
│ ポリシー適用テスト                                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ テスト設定                                                  │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ テストユーザー: [田中太郎 ▼]                            │ │
│ │ ビジネスコード: [見積管理 ▼]                            │ │
│ │ アクション: [一覧表示 ▼]                                │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ [テスト実行]                                                │
│                                                             │
│ テスト結果                                                  │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ ✅ 適用されるポリシー: 2件                              │ │
│ │ ❌ 適用されないポリシー: 1件                            │ │
│ │                                                         │ │
│ │ 最終結果: 拒否（部署制限により）                        │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 ポリシー管理支援

#### ポリシー一覧の改善
```
┌─────────────────────────────────────────────────────────────┐
│ 見積管理 のポリシー一覧                                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ フィルター                                                   │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ アクション: [すべて ▼] 効果: [すべて ▼] 状態: [すべて ▼] │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 部署別見積表示制限                            [編集] [削除] │ │
│ │ 対象: 営業部    範囲: 自部署のみ    効果: 拒否           │ │
│ │ [有効] 優先度: 高 (100)                                  │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 課長の承認金額制限                            [編集] [削除] │ │
│ │ 対象: 課長      条件: 100万円以下    効果: 拒否         │ │
│ │ [有効] 優先度: 高 (100)                                  │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 実装仕様

### テンプレート定義
```typescript
interface PolicyTemplate {
  id: string;
  name: string;
  description: string;
  icon: string;
  category: 'basic' | 'business' | 'custom';
  applicableBusinessCodes: string[];
  applicableActions: string[];
  formFields: TemplateFormField[];
  defaultValues: Record<string, any>;
}

interface TemplateFormField {
  key: string;
  label: string;
  type: 'text' | 'select' | 'number' | 'boolean';
  required: boolean;
  options?: Array<{value: any, label: string}>;
  placeholder?: string;
  helpText?: string;
}

const policyTemplates: PolicyTemplate[] = [
  {
    id: 'department_access',
    name: '部署別アクセス制限',
    description: '特定の部署のユーザーのみアクセス可能',
    icon: '🏢',
    category: 'basic',
    applicableBusinessCodes: ['estimate', 'budget', 'purchase'],
    applicableActions: ['list', 'view'],
    formFields: [
      {
        key: 'name',
        label: 'ポリシー名',
        type: 'text',
        required: true,
        placeholder: '部署別見積表示制限'
      },
      {
        key: 'target_department',
        label: '対象部署',
        type: 'select',
        required: true,
        options: 'departments'
      },
      {
        key: 'scope',
        label: 'データアクセス範囲',
        type: 'select',
        required: true,
        options: [
          { value: 'self', label: '自分のみ' },
          { value: 'department', label: '自部署のみ' },
          { value: 'organization', label: '組織全体' }
        ]
      },
      {
        key: 'effect',
        label: 'ポリシー効果',
        type: 'select',
        required: true,
        options: [
          { value: 'allow', label: '許可' },
          { value: 'deny', label: '拒否' }
        ]
      },
      {
        key: 'priority',
        label: '優先度',
        type: 'select',
        required: true,
        options: [
          { value: 100, label: '高' },
          { value: 50, label: '中' },
          { value: 10, label: '低' }
        ]
      }
    ],
    defaultValues: {
      effect: 'deny',
      priority: 100,
      scope: 'department'
    }
  }
];
```

### コンポーネント構成
```
ABACPolicyManagement/
├── index.tsx                    # メインコンポーネント
├── BusinessCodeSelector.tsx     # ビジネスコード選択
├── PolicyList.tsx               # ポリシー一覧
├── PolicyCreationSelector.tsx   # 作成方法選択
├── TemplateSelector.tsx         # テンプレート選択
├── TemplateForm.tsx             # テンプレートフォーム
├── CustomForm.tsx               # カスタム設定フォーム
├── PolicyTester.tsx             # ポリシーテスト
└── components/
    ├── TemplateCard.tsx         # テンプレートカード
    ├── FormField.tsx            # フォームフィールド
    ├── ConditionRow.tsx         # 条件行（カスタム用）
    └── PolicyCard.tsx           # ポリシーカード
```

## 実装計画

### Phase 1: 非技術者向け基本機能（2-3週間）
1. **テンプレートベースのポリシー作成**
   - テンプレート定義の作成
   - テンプレート選択UIの実装
   - テンプレートフォームの実装

2. **基本的なカスタム設定**
   - 簡易カスタム設定フォーム
   - 条件の追加・削除機能
   - バリデーション機能

3. **UI/UXの改善**
   - ポリシー一覧の表示改善
   - エラーハンドリングの強化

### Phase 2: 高度なテンプレート機能（3-4週間）
1. **業務別テンプレート**
   - ビジネスコード別テンプレート
   - 専用フォームの実装

2. **一括設定機能**
   - 職位別一括設定
   - 部署別一括設定

### Phase 3: 運用支援機能（2-3週間）
1. **ポリシー適用状況の確認**
   - 簡易テスト機能
   - 結果表示の改善

2. **ポリシー管理支援**
   - フィルタリング機能
   - 一括操作機能

## まとめ

この仕様により、**技術者が不要なUI操作**を実現し、画面からコードを書く操作を完全に排除できます。

### **主な特徴**
1. **テンプレートベース**: よく使われるパターンをテンプレート化
2. **プルダウン選択**: すべての設定をプルダウンで選択
3. **直感的操作**: ボタンクリックとフォーム入力のみ
4. **段階的機能**: 必要に応じて機能を拡張

### **技術者不要の実現**
- JSON直接入力の完全排除
- 条件式の手動記述の排除
- テンプレートベースの設定のみ
- プルダウン選択とボタンクリックのみの操作

これにより、非技術者でも直感的にABACポリシーを設定・管理できるようになります。